<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIChatDesk - Agent Dashboard Test</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #e0e0e0; }
    .header { background: #16213e; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2a2a4a; }
    .header h1 { font-size: 18px; color: #6C5CE7; }
    .header .agent-info { display: flex; gap: 15px; align-items: center; font-size: 13px; }
    .header .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .header .status-dot.online { background: #00b894; }
    .header .status-dot.offline { background: #e74c3c; }
    .main { display: grid; grid-template-columns: 300px 1fr 300px; height: calc(100vh - 82px); }
    .sidebar { background: #16213e; border-right: 1px solid #2a2a4a; overflow-y: auto; }
    .sidebar h2 { padding: 15px 20px; font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
    .chat-item { padding: 12px 20px; border-bottom: 1px solid #2a2a4a; cursor: pointer; transition: background 0.2s; }
    .chat-item:hover { background: #2a2a4a; }
    .chat-item.active { background: #2a2a4a; border-left: 3px solid #6C5CE7; }
    .chat-item .name { font-weight: 600; font-size: 14px; margin-bottom: 3px; }
    .chat-item .preview { font-size: 12px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-item .meta { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; font-size: 11px; color: #666; }
    .chat-item .delete-btn {
      width: 20px; height: 20px; background: none; border: none; cursor: pointer;
      color: #666; font-size: 14px; border-radius: 4px; display: flex; align-items: center;
      justify-content: center; transition: all 0.2s; padding: 0; line-height: 1;
    }
    .chat-item .delete-btn:hover { background: #e74c3c33; color: #e74c3c; }
    .priority-badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
    .priority-badge.high { background: #e74c3c33; color: #e74c3c; }
    .priority-badge.medium { background: #f39c1233; color: #f39c12; }
    .priority-badge.low { background: #00b89433; color: #00b894; }
    .mode-tag { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 10px; }
    .mode-tag.ai { background: #6C5CE733; color: #6C5CE7; }
    .mode-tag.human { background: #00b89433; color: #00b894; }
    .center { display: flex; flex-direction: column; position: relative; }
    .chat-header-bar { padding: 15px 20px; background: #16213e; border-bottom: 1px solid #2a2a4a; display: flex; justify-content: space-between; align-items: center; }
    .chat-header-bar .user-name { font-weight: 600; font-size: 16px; }
    .chat-header-bar .actions { display: flex; gap: 8px; }
    .btn { padding: 6px 14px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: 600; }
    .btn-takeover { background: #e74c3c; color: white; }
    .btn-takeover:hover { background: #c0392b; }
    .btn-return { background: #00b894; color: white; }
    .btn-return:hover { background: #00a381; }
    .btn-suggest { background: #6C5CE7; color: white; }
    .btn-suggest:hover { background: #5a4bd1; }
    .btn-transfer { background: #f39c12; color: white; }
    .btn-transfer:hover { background: #e08e0b; }
    .messages { flex: 1; padding: 20px; overflow-y: auto; }
    .message { margin-bottom: 12px; max-width: 70%; }
    .message.user { margin-left: auto; }
    .message .bubble { padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.5; }
    .message.user .bubble { background: #6C5CE7; color: white; border-bottom-right-radius: 4px; }
    .message.ai .bubble { background: #2a2a4a; color: #e0e0e0; border-bottom-left-radius: 4px; }
    .message.agent .bubble { background: #00b894; color: white; border-bottom-left-radius: 4px; }
    .message.system .bubble { background: transparent; color: #888; text-align: center; font-size: 12px; font-style: italic; max-width: 100%; }
    .message.internal .bubble { background: #f39c1233; color: #f39c12; border: 1px dashed #f39c1266; font-size: 12px; }
    .message .sender { font-size: 11px; color: #888; margin-bottom: 3px; }
    .message .time { font-size: 10px; color: #666; margin-top: 3px; }
    .agent-input { padding: 15px 20px; background: #16213e; border-top: 1px solid #2a2a4a; display: flex; gap: 10px; }
    .agent-input input { flex: 1; background: #2a2a4a; border: 1px solid #3a3a5a; color: #e0e0e0; padding: 10px 14px; border-radius: 8px; font-size: 14px; }
    .agent-input input:focus { outline: none; border-color: #6C5CE7; }
    .agent-input button { background: #6C5CE7; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .right-panel { background: #16213e; border-left: 1px solid #2a2a4a; overflow-y: auto; padding: 20px; }
    .right-panel h3 { font-size: 13px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
    .info-row { display: flex; justify-content: space-between; font-size: 13px; padding: 6px 0; border-bottom: 1px solid #2a2a4a; }
    .info-row .label { color: #888; }
    .info-row .value { color: #e0e0e0; }
    .section { margin-bottom: 25px; }
    .note-input { width: 100%; background: #2a2a4a; border: 1px solid #3a3a5a; color: #e0e0e0; padding: 8px 12px; border-radius: 6px; font-size: 13px; resize: vertical; min-height: 60px; margin-top: 8px; font-family: inherit; }
    .note-btn { margin-top: 8px; background: #3a3a5a; color: #e0e0e0; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .canned-list { margin-top: 8px; }
    .canned-item { padding: 6px 10px; background: #2a2a4a; border-radius: 4px; margin-bottom: 4px; cursor: pointer; font-size: 12px; }
    .canned-item:hover { background: #3a3a5a; }
    .kb-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #2a2a4a; border-radius: 4px; margin-bottom: 4px; font-size: 12px; }
    .kb-item .kb-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .kb-item .kb-type { font-size: 10px; color: #888; margin: 0 6px; }
    .kb-item .kb-delete { background: none; border: none; color: #666; cursor: pointer; font-size: 14px; padding: 0 4px; }
    .kb-item .kb-delete:hover { color: #e74c3c; }
    .connection-bar { padding: 8px 30px; font-size: 12px; display: flex; gap: 20px; background: #0f0f23; }
    .connection-bar span { color: #888; }
    .connected { color: #00b894 !important; }
    .disconnected { color: #e74c3c !important; }
    .tab-btn { background: #2a2a4a; color: #888; border: none; padding: 4px 14px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; }
    .tab-btn:hover { background: #3a3a5a; color: #e0e0e0; }
    .tab-btn.active { background: #6C5CE7; color: white; }
    /* KB management page */
    #kb-page { display: none; height: calc(100vh - 82px); padding: 30px; overflow-y: auto; }
    #kb-page.active { display: block; }
    .kb-toolbar { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
    .kb-toolbar input[type="text"] { flex: 1; min-width: 200px; background: #2a2a4a; border: 1px solid #3a3a5a; color: #e0e0e0; padding: 10px 14px; border-radius: 8px; font-size: 14px; }
    .kb-toolbar input[type="text"]:focus { outline: none; border-color: #6C5CE7; }
    .kb-toolbar .kb-btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; }
    .kb-toolbar .kb-btn-primary { background: #6C5CE7; color: white; }
    .kb-toolbar .kb-btn-primary:hover { background: #5a4bd1; }
    .kb-toolbar .kb-btn-secondary { background: #2a2a4a; color: #e0e0e0; }
    .kb-toolbar .kb-btn-secondary:hover { background: #3a3a5a; }
    .kb-status { font-size: 13px; padding: 8px 14px; border-radius: 6px; margin-bottom: 16px; display: none; }
    .kb-status.success { display: block; background: #00b89433; color: #00b894; }
    .kb-status.error { display: block; background: #e74c3c33; color: #e74c3c; }
    .kb-status.loading { display: block; background: #f39c1233; color: #f39c12; }
    .kb-table { width: 100%; border-collapse: collapse; }
    .kb-table th { text-align: left; padding: 10px 14px; background: #16213e; color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #2a2a4a; }
    .kb-table td { padding: 10px 14px; border-bottom: 1px solid #2a2a4a; font-size: 13px; }
    .kb-table tr:hover { background: #2a2a4a; }
    .kb-table .actions-cell { display: flex; gap: 6px; }
    .kb-table .actions-cell button { padding: 4px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 11px; font-weight: 600; }
    .kb-table .btn-view { background: #6C5CE733; color: #6C5CE7; }
    .kb-table .btn-view:hover { background: #6C5CE755; }
    .kb-table .btn-del { background: #e74c3c33; color: #e74c3c; }
    .kb-table .btn-del:hover { background: #e74c3c55; }
    /* KB viewer/editor modal */
    #kb-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; }
    #kb-modal.open { display: flex; }
    .kb-modal-content { background: #16213e; border-radius: 12px; width: 700px; max-height: 80vh; display: flex; flex-direction: column; overflow: hidden; }
    .kb-modal-header { padding: 16px 20px; border-bottom: 1px solid #2a2a4a; display: flex; justify-content: space-between; align-items: center; }
    .kb-modal-header h3 { font-size: 16px; color: #e0e0e0; }
    .kb-modal-header button { background: none; border: none; color: #888; font-size: 22px; cursor: pointer; }
    .kb-modal-header button:hover { color: #e0e0e0; }
    .kb-modal-body { flex: 1; overflow-y: auto; padding: 20px; }
    .kb-modal-body textarea { width: 100%; min-height: 300px; background: #2a2a4a; border: 1px solid #3a3a5a; color: #e0e0e0; padding: 12px; border-radius: 8px; font-size: 13px; font-family: 'Courier New', monospace; line-height: 1.5; resize: vertical; }
    .kb-modal-body textarea:focus { outline: none; border-color: #6C5CE7; }
    .kb-modal-footer { padding: 12px 20px; border-top: 1px solid #2a2a4a; display: flex; gap: 8px; justify-content: flex-end; }
    .kb-modal-footer button { padding: 8px 18px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; }
    .kb-modal-footer .btn-save { background: #6C5CE7; color: white; }
    .kb-modal-footer .btn-save:hover { background: #5a4bd1; }
    .kb-modal-footer .btn-cancel { background: #3a3a5a; color: #e0e0e0; }
    .kb-modal-footer .btn-cancel:hover { background: #4a4a6a; }
    .kb-chunk-info { font-size: 12px; color: #888; margin-bottom: 10px; }
    .empty-state { display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 14px; flex-direction: column; gap: 10px; }
    .log-panel { background: #0f0f23; padding: 15px; margin-top: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 11px; max-height: 150px; overflow-y: auto; color: #0f0; white-space: pre-wrap; }
    /* Login overlay */
    #login-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #1a1a2e;
      display: flex; align-items: center; justify-content: center; z-index: 9999;
    }
    #login-overlay.hidden { display: none; }
    .login-box { background: #16213e; padding: 40px; border-radius: 16px; width: 360px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
    .login-box h2 { color: #6C5CE7; margin-bottom: 24px; text-align: center; }
    .login-box input { width: 100%; padding: 12px 14px; background: #2a2a4a; border: 1px solid #3a3a5a; color: #e0e0e0; border-radius: 8px; font-size: 14px; margin-bottom: 12px; }
    .login-box input:focus { outline: none; border-color: #6C5CE7; }
    .login-box button { width: 100%; padding: 12px; background: #6C5CE7; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .login-box button:hover { background: #5a4bd1; }
    .login-box .error { color: #e74c3c; font-size: 13px; text-align: center; margin-top: 10px; display: none; }
    /* Split panel styles */
    .split-panel { border-right: 1px solid #2a2a4a; }
    .split-panel:last-child { border-right: none; }
    /* Categories page */
    #categories-page { display: none; height: calc(100vh - 82px); padding: 30px; overflow-y: auto; }
  </style>
</head>
<body>
  <!-- Login Overlay -->
  <div id="login-overlay">
    <div class="login-box">
      <h2>Agent Login</h2>
      <input type="email" id="login-email" value="admin@myapp.com" placeholder="Email">
      <input type="password" id="login-password" value="changeme123" placeholder="Password">
      <button onclick="login()">Login</button>
      <div class="error" id="login-error"></div>
    </div>
  </div>

  <div class="header">
    <h1>AIChatDesk Agent Dashboard</h1>
    <div class="agent-info">
      <span><span class="status-dot" id="agent-dot"></span> <span id="agent-name">Agent</span></span>
      <span style="color: #666;">|</span>
      <span>Server: <span id="server-status">Checking...</span></span>
      <span style="color: #666;">|</span>
      <span>WS: <span id="ws-status" class="disconnected">Disconnected</span></span>
    </div>
  </div>

  <div class="connection-bar">
    <span>API: http://localhost:8004</span>
    <span>Active Chats: <span id="chat-count">0</span></span>
    <span>Queue: <span id="queue-count">0</span></span>
    <span style="margin-left:auto;">
      <button class="tab-btn active" id="tab-chats" onclick="switchTab('chats')">Chats</button>
      <button class="tab-btn" id="tab-kb" onclick="switchTab('kb')">Knowledge Base</button>
      <button class="tab-btn" id="tab-categories" onclick="switchTab('categories')">Categories</button>
    </span>
  </div>

  <div class="main">
    <!-- Left: Chat List -->
    <div class="sidebar">
      <h2>Active Chats</h2>
      <div id="chat-list"></div>
    </div>

    <!-- Center: Chat Panels Container (split screen) -->
    <div class="center" id="chat-panels-container">
      <div id="chat-view-empty" class="empty-state">
        <div style="font-size: 40px; opacity: 0.3;">&#x1F4AC;</div>
        <div>Select a chat from the sidebar</div>
        <div style="font-size: 12px; color: #555;">Click to open, click another to add to split view (up to 4)</div>
      </div>
    </div>

    <!-- Right: Info Panel -->
    <div class="right-panel">
      <div class="section">
        <h3>User Information</h3>
        <div class="info-row"><span class="label">Name</span><span class="value" id="info-name">-</span></div>
        <div class="info-row"><span class="label">Email</span><span class="value" id="info-email">-</span></div>
        <div class="info-row"><span class="label">Page</span><span class="value" id="info-page">-</span></div>
        <div class="info-row"><span class="label">URL</span><span class="value" id="info-url" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="">-</span></div>
        <div class="info-row"><span class="label">Category</span><span class="value" id="info-category">-</span></div>
        <div class="info-row"><span class="label">Ticket Type</span><span class="value" id="info-ticket-type">-</span></div>
        <div class="info-row"><span class="label">User Priority</span><span class="value" id="info-user-priority">-</span></div>
        <div class="info-row"><span class="label">Mood</span><span class="value" id="info-mood">-</span></div>
        <div class="info-row"><span class="label">Mode</span><span class="value" id="info-mode">-</span></div>
        <div class="info-row"><span class="label">Status</span><span class="value" id="info-status">-</span></div>
      </div>

      <div class="section" id="env-section" style="display:none;">
        <h3 style="cursor:pointer;" onclick="toggleEnvSection()">
          Environment <span id="env-toggle">&#x25B6;</span>
        </h3>
        <div id="env-details" style="display:none;"></div>
      </div>

      <div class="section">
        <h3>Internal Notes</h3>
        <textarea class="note-input" id="note-input" placeholder="Add a note (invisible to user)..."></textarea>
        <button class="note-btn" onclick="addNote()">Add Note</button>
      </div>

      <div class="section">
        <h3>Canned Responses</h3>
        <div class="canned-list">
          <div class="canned-item" onclick="useCanned('Thank you for contacting us! Let me help you with that.')">Thanks + help</div>
          <div class="canned-item" onclick="useCanned('I\'m looking into this for you. One moment please.')">Looking into it</div>
          <div class="canned-item" onclick="useCanned('Could you provide more details about the issue?')">Need more details</div>
          <div class="canned-item" onclick="useCanned('This has been resolved. Is there anything else I can help with?')">Issue resolved</div>
        </div>
      </div>

      <div class="section">
        <h3>Knowledge Base</h3>
        <div style="margin-bottom: 8px;">
          <input type="file" id="kb-file-input" accept=".pdf,.txt,.md,.docx,.json,.csv,.html" style="display:none;" onchange="uploadKBFile(event)">
          <button class="note-btn" onclick="document.getElementById('kb-file-input').click()" style="width:100%; text-align:center;">Upload Document</button>
          <div style="font-size: 10px; color: #666; margin-top: 4px;">PDF, TXT, MD, DOCX, JSON, CSV, HTML</div>
        </div>
        <div style="margin-bottom: 8px; display: flex; gap: 4px;">
          <input type="text" id="kb-url-input" placeholder="Paste URL to import..." style="flex:1; background:#2a2a4a; border:1px solid #3a3a5a; color:#e0e0e0; padding:6px 10px; border-radius:4px; font-size:12px;">
          <button class="note-btn" onclick="importKBUrl()" style="white-space:nowrap;">Import URL</button>
        </div>
        <div id="kb-upload-status" style="font-size: 12px; color: #00b894; display: none; margin-bottom: 8px;"></div>
        <div id="kb-list" style="max-height: 200px; overflow-y: auto;"></div>
      </div>

      <div class="section">
        <h3>Event Log</h3>
        <div class="log-panel" id="log"></div>
      </div>
    </div>
  </div>

  <!-- KB Management Page -->
  <div id="kb-page">
    <h2 style="color: #6C5CE7; margin-bottom: 20px;">Knowledge Base Management</h2>

    <div class="kb-toolbar">
      <input type="file" id="kb-page-file" accept=".pdf,.txt,.md,.docx,.json,.csv,.html" style="display:none;" onchange="kbPageUpload(event)">
      <button class="kb-btn kb-btn-primary" onclick="document.getElementById('kb-page-file').click()">Upload Document</button>
      <input type="text" id="kb-page-url" placeholder="Paste URL to import (e.g. https://yoursite.com/faq)" onkeydown="if(event.key==='Enter') kbPageImportUrl()">
      <button class="kb-btn kb-btn-secondary" onclick="kbPageImportUrl()">Import URL</button>
      <button class="kb-btn kb-btn-secondary" onclick="kbPageRefresh()">Refresh</button>
    </div>

    <div class="kb-status" id="kb-page-status"></div>

    <table class="kb-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Chunks</th>
          <th>Added</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="kb-page-list"></tbody>
    </table>
  </div>

  <!-- Categories Management Page -->
  <div id="categories-page" style="display:none; height:calc(100vh - 82px); padding:30px; overflow-y:auto;">
    <h2 style="color:#6C5CE7; margin-bottom:20px;">Workflow Categories</h2>
    <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:end;">
      <div>
        <label style="font-size:11px; color:#888;">Name</label>
        <input type="text" id="cat-name" placeholder="e.g. PreSales" style="display:block; background:#2a2a4a; border:1px solid #3a3a5a; color:#e0e0e0; padding:8px 12px; border-radius:6px; font-size:13px; width:150px;">
      </div>
      <div>
        <label style="font-size:11px; color:#888;">Icon</label>
        <input type="text" id="cat-icon" value="&#x1F4AC;" style="display:block; background:#2a2a4a; border:1px solid #3a3a5a; color:#e0e0e0; padding:8px 12px; border-radius:6px; font-size:13px; width:60px;">
      </div>
      <div style="flex:1; min-width:200px;">
        <label style="font-size:11px; color:#888;">AI Prompt</label>
        <input type="text" id="cat-prompt" placeholder="System prompt for this category..." style="display:block; width:100%; background:#2a2a4a; border:1px solid #3a3a5a; color:#e0e0e0; padding:8px 12px; border-radius:6px; font-size:13px;">
      </div>
      <div>
        <label style="font-size:11px; color:#888;">Active</label>
        <input type="checkbox" id="cat-active" checked style="display:block; margin-top:8px;">
      </div>
      <button class="kb-btn kb-btn-primary" onclick="addCategory()" style="height:36px;">Add Category</button>
    </div>
    <div id="cat-status" class="kb-status"></div>
    <table class="kb-table">
      <thead><tr><th>Icon</th><th>Name</th><th>Prompt</th><th>Active</th><th>Actions</th></tr></thead>
      <tbody id="cat-list"></tbody>
    </table>
  </div>

  <!-- KB View/Edit Modal -->
  <div id="kb-modal">
    <div class="kb-modal-content">
      <div class="kb-modal-header">
        <h3 id="kb-modal-title">Document</h3>
        <button onclick="closeKBModal()">&times;</button>
      </div>
      <div class="kb-modal-body">
        <div class="kb-chunk-info" id="kb-modal-info"></div>
        <textarea id="kb-modal-content"></textarea>
      </div>
      <div class="kb-modal-footer">
        <button class="btn-cancel" onclick="closeKBModal()">Cancel</button>
        <button class="btn-save" id="kb-modal-save" onclick="saveKBContent()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Lightbox overlay for image attachments -->
  <div id="lightbox" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:10000; cursor:pointer; align-items:center; justify-content:center;" onclick="this.style.display='none'">
    <img id="lightbox-img" style="max-width:90vw; max-height:90vh; border-radius:8px;">
  </div>

  <script>
    const API = 'http://localhost:8004';
    let token = null;
    let agentId = null;
    let agentName = '';
    let selectedChat = null; // { sessionId, chatId, mode, userName, userEmail }
    let chatList = [];
    let ws = null;

    // Multi-chat split screen state
    let activeChats = []; // Array of { sessionId, chatId, mode, userName, userEmail }
    const MAX_SPLIT = 4;

    function log(msg) {
      const el = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      el.textContent += `[${time}] ${msg}\n`;
      el.scrollTop = el.scrollHeight;
    }

    // --- Login ---
    async function login() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');
      errorEl.style.display = 'none';

      try {
        const res = await fetch(`${API}/api/agents/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();

        if (data.token) {
          token = data.token;
          agentId = data.agent?.id;
          agentName = data.agent?.name || 'Agent';
          document.getElementById('login-overlay').classList.add('hidden');
          document.getElementById('agent-name').textContent = agentName;
          document.getElementById('agent-dot').classList.add('online');
          document.getElementById('server-status').textContent = 'Connected';
          document.getElementById('server-status').classList.add('connected');
          log(`Logged in as ${agentName} (${data.agent?.role})`);
          loadChats();
          loadKBFiles();
          connectWS();
        } else {
          errorEl.textContent = data.error || 'Login failed';
          errorEl.style.display = 'block';
        }
      } catch (err) {
        errorEl.textContent = 'Cannot connect to server';
        errorEl.style.display = 'block';
      }
    }

    // --- Load chats ---
    async function loadChats() {
      if (!token) return;
      try {
        const res = await fetch(`${API}/api/dashboard/chats`);
        const chats = await res.json();
        chatList = Array.isArray(chats) ? chats : [];
        renderChatList();
      } catch (err) {
        log(`Failed to load chats: ${err.message}`);
      }
    }

    function renderChatList() {
      const el = document.getElementById('chat-list');
      const active = chatList.filter(c => c.status === 'active');
      const waiting = chatList.filter(c => c.status === 'waiting');
      document.getElementById('chat-count').textContent = active.length;
      document.getElementById('queue-count').textContent = waiting.length;

      if (chatList.length === 0) {
        el.innerHTML = '<div style="padding: 20px; color: #666; text-align: center; font-size: 13px;">No active chats.<br>Open the <a href="index.html" style="color: #6C5CE7;">customer test page</a> and start a chat.</div>';
        return;
      }

      const ticketIcons = { bug: '\u{1F41B}', feature: '\u2728', question: '\u2753', support: '\u{1F3AB}' };
      el.innerHTML = chatList.map(chat => {
        const priority = chat.priority || 'low';
        const mode = chat.mode || 'ai';
        const isSelected = selectedChat && selectedChat.sessionId === chat.sessionId;
        const isInSplit = activeChats.some(ac => ac.sessionId === chat.sessionId);
        const tktIcon = ticketIcons[chat.ticketType] || '';
        return `
          <div class="chat-item ${isSelected ? 'active' : ''} ${isInSplit && !isSelected ? 'in-split' : ''}" onclick="selectChat('${chat.sessionId}')" style="${isInSplit && !isSelected ? 'border-left: 3px solid #00b894;' : ''}">
            <div class="name">${tktIcon ? tktIcon + ' ' : ''}${chat.userName || 'Anonymous'}</div>
            <div class="preview">${chat.summary || chat.category || 'New conversation'}</div>
            <div class="meta">
              <span class="priority-badge ${priority}">${priority}</span>
              <span class="mode-tag ${mode}">${mode.toUpperCase()}</span>
              <span>${chat.waitTime || 0}m</span>
              <button class="delete-btn" onclick="event.stopPropagation(); deleteChat('${chat.sessionId}', '${(chat.userName || 'Anonymous').replace(/'/g, "\\'")}')" title="Delete chat">&times;</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // --- Select chat (multi-panel) ---
    async function selectChat(sessionId) {
      const chat = chatList.find(c => c.sessionId === sessionId);
      if (!chat) return;

      // Check if already in activeChats
      const existing = activeChats.findIndex(ac => ac.sessionId === sessionId);
      if (existing === -1) {
        if (activeChats.length >= MAX_SPLIT) {
          alert('Maximum 4 chats open. Close one first.');
          return;
        }
        activeChats.push({
          sessionId: chat.sessionId,
          chatId: chat._id,
          mode: chat.mode,
          userName: chat.userName,
          userEmail: chat.userEmail
        });
      }

      selectedChat = {
        sessionId: chat.sessionId,
        chatId: chat._id,
        mode: chat.mode,
        userName: chat.userName,
        userEmail: chat.userEmail
      };

      log(`Selected chat: ${chat.userName} (${sessionId.substring(0, 8)}...)`);

      // Update right panel info
      document.getElementById('info-name').textContent = chat.userName || '-';
      document.getElementById('info-email').textContent = chat.userEmail || '-';
      document.getElementById('info-page').textContent = chat.metadata?.currentPage || '-';
      const userUrl = chat.metadata?.environment?.currentUrl || chat.metadata?.currentPage || '-';
      document.getElementById('info-url').textContent = userUrl;
      document.getElementById('info-url').title = userUrl;
      document.getElementById('info-category').textContent = chat.category || '-';
      document.getElementById('info-ticket-type').textContent = chat.ticketType || '-';
      document.getElementById('info-user-priority').textContent = chat.userPriority || '-';
      const moodEmojis = { 1: '\u{1F621}', 2: '\u{1F615}', 3: '\u{1F610}', 4: '\u{1F642}', 5: '\u{1F929}' };
      document.getElementById('info-mood').textContent = chat.mood ? `${moodEmojis[chat.mood] || ''} (${chat.mood}/5)` : '-';
      document.getElementById('info-mode').textContent = (chat.mode || 'ai').toUpperCase();
      document.getElementById('info-status').textContent = chat.status || '-';

      // Environment info
      const env = chat.metadata?.environment;
      if (env) {
        document.getElementById('env-section').style.display = 'block';
        const envEl = document.getElementById('env-details');
        envEl.innerHTML = [
          {l:'Browser', v: parseUA(env.browser)},
          {l:'Platform', v: env.platform},
          {l:'Language', v: env.language},
          {l:'Screen', v: `${env.screenWidth}x${env.screenHeight} @${env.devicePixelRatio}x`},
          {l:'Window', v: `${env.windowWidth}x${env.windowHeight}`},
          {l:'Timezone', v: env.timezone},
          {l:'Online', v: env.online ? 'Yes' : 'No'},
          {l:'Connection', v: env.connectionType || '-'},
          {l:'CPU Cores', v: env.hardwareConcurrency || '-'},
          {l:'Memory', v: env.deviceMemory ? env.deviceMemory + 'GB' : '-'},
          {l:'Touch', v: env.maxTouchPoints > 0 ? 'Yes (' + env.maxTouchPoints + ')' : 'No'},
          {l:'Referrer', v: env.referrer || 'Direct'},
          {l:'URL', v: env.currentUrl || '-'}
        ].map(r => `<div class="info-row"><span class="label">${r.l}</span><span class="value" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(String(r.v))}">${escapeHtml(String(r.v))}</span></div>`).join('');
      } else {
        document.getElementById('env-section').style.display = 'none';
      }

      // Register WS for this session
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'chat.join', sessionId, clientType: 'dashboard' }));
      }

      renderChatPanels();
      renderChatList();
    }

    // --- Multi-panel rendering ---
    function renderChatPanels() {
      const container = document.getElementById('chat-panels-container');
      const emptyState = document.getElementById('chat-view-empty');

      if (activeChats.length === 0) {
        emptyState.style.display = 'flex';
        container.style.display = 'flex';
        container.style.gridTemplateColumns = '';
        container.style.gridTemplateRows = '';
        container.querySelectorAll('.split-panel').forEach(p => p.remove());
        return;
      }

      emptyState.style.display = 'none';

      // Set grid layout
      if (activeChats.length === 1) {
        container.style.display = 'grid';
        container.style.gridTemplateColumns = '1fr';
        container.style.gridTemplateRows = '1fr';
      } else if (activeChats.length <= 3) {
        container.style.display = 'grid';
        container.style.gridTemplateColumns = `repeat(${activeChats.length}, 1fr)`;
        container.style.gridTemplateRows = '1fr';
      } else {
        container.style.display = 'grid';
        container.style.gridTemplateColumns = '1fr 1fr';
        container.style.gridTemplateRows = '1fr 1fr';
      }

      // Remove old panels
      container.querySelectorAll('.split-panel').forEach(p => p.remove());

      // Create panels
      activeChats.forEach((ac, idx) => {
        const panel = document.createElement('div');
        panel.className = 'split-panel';
        panel.dataset.sessionId = ac.sessionId;
        panel.style.cssText = 'display:flex; flex-direction:column; overflow:hidden;';

        const isHuman = ac.mode === 'human';
        const isSelected = selectedChat && selectedChat.sessionId === ac.sessionId;
        panel.innerHTML = `
          <div style="padding:8px 12px; background:${isSelected ? '#1a2a4e' : '#16213e'}; border-bottom:1px solid #2a2a4a; display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
            <span style="font-weight:600; font-size:13px; cursor:pointer;" onclick="focusPanel('${ac.sessionId}')">${escapeHtml(ac.userName || 'Anonymous')}</span>
            <div style="display:flex; gap:4px; align-items:center;">
              <span class="mode-tag ${ac.mode || 'ai'}" style="font-size:10px;">${(ac.mode || 'ai').toUpperCase()}</span>
              <button class="btn btn-takeover" style="font-size:10px; padding:3px 8px; ${isHuman ? 'display:none' : ''}" onclick="takeoverPanel(${idx})">Take Over</button>
              <button class="btn btn-return" style="font-size:10px; padding:3px 8px; ${isHuman ? '' : 'display:none'}" onclick="returnPanel(${idx})">Return</button>
              <button style="background:none; border:none; color:#666; cursor:pointer; font-size:16px;" onclick="closePanel(${idx})" title="Close">&times;</button>
            </div>
          </div>
          <div class="messages" id="panel-messages-${idx}" style="flex:1; padding:12px; overflow-y:auto;"></div>
          <div style="padding:8px 12px; background:#16213e; border-top:1px solid #2a2a4a; display:${isHuman ? 'flex' : 'none'}; gap:6px;" id="panel-input-${idx}">
            <input type="text" style="flex:1; background:#2a2a4a; border:1px solid #3a3a5a; color:#e0e0e0; padding:8px 10px; border-radius:6px; font-size:13px;" placeholder="Type..." onkeydown="if(event.key==='Enter') sendPanelMessage(${idx})">
            <button style="background:#6C5CE7; color:white; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600;" onclick="sendPanelMessage(${idx})">Send</button>
          </div>
        `;
        container.appendChild(panel);

        // Load messages for this panel
        loadPanelMessages(idx);
      });
    }

    function focusPanel(sessionId) {
      const chat = chatList.find(c => c.sessionId === sessionId);
      if (!chat) return;
      selectedChat = {
        sessionId: chat.sessionId,
        chatId: chat._id,
        mode: chat.mode,
        userName: chat.userName,
        userEmail: chat.userEmail
      };
      // Update right panel info
      document.getElementById('info-name').textContent = chat.userName || '-';
      document.getElementById('info-email').textContent = chat.userEmail || '-';
      document.getElementById('info-page').textContent = chat.metadata?.currentPage || '-';
      const userUrl = chat.metadata?.environment?.currentUrl || chat.metadata?.currentPage || '-';
      document.getElementById('info-url').textContent = userUrl;
      document.getElementById('info-url').title = userUrl;
      document.getElementById('info-category').textContent = chat.category || '-';
      document.getElementById('info-ticket-type').textContent = chat.ticketType || '-';
      document.getElementById('info-user-priority').textContent = chat.userPriority || '-';
      const moodEmojis = { 1: '\u{1F621}', 2: '\u{1F615}', 3: '\u{1F610}', 4: '\u{1F642}', 5: '\u{1F929}' };
      document.getElementById('info-mood').textContent = chat.mood ? `${moodEmojis[chat.mood] || ''} (${chat.mood}/5)` : '-';
      document.getElementById('info-mode').textContent = (chat.mode || 'ai').toUpperCase();
      document.getElementById('info-status').textContent = chat.status || '-';

      // Environment info
      const env = chat.metadata?.environment;
      if (env) {
        document.getElementById('env-section').style.display = 'block';
        const envEl = document.getElementById('env-details');
        envEl.innerHTML = [
          {l:'Browser', v: parseUA(env.browser)},
          {l:'Platform', v: env.platform},
          {l:'Language', v: env.language},
          {l:'Screen', v: `${env.screenWidth}x${env.screenHeight} @${env.devicePixelRatio}x`},
          {l:'Window', v: `${env.windowWidth}x${env.windowHeight}`},
          {l:'Timezone', v: env.timezone},
          {l:'Online', v: env.online ? 'Yes' : 'No'},
          {l:'Connection', v: env.connectionType || '-'},
          {l:'CPU Cores', v: env.hardwareConcurrency || '-'},
          {l:'Memory', v: env.deviceMemory ? env.deviceMemory + 'GB' : '-'},
          {l:'Touch', v: env.maxTouchPoints > 0 ? 'Yes (' + env.maxTouchPoints + ')' : 'No'},
          {l:'Referrer', v: env.referrer || 'Direct'},
          {l:'URL', v: env.currentUrl || '-'}
        ].map(r => `<div class="info-row"><span class="label">${r.l}</span><span class="value" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(String(r.v))}">${escapeHtml(String(r.v))}</span></div>`).join('');
      } else {
        document.getElementById('env-section').style.display = 'none';
      }

      renderChatPanels();
      renderChatList();
    }

    async function loadPanelMessages(idx) {
      const ac = activeChats[idx];
      if (!ac) return;
      try {
        const res = await fetch(`${API}/api/chat/${ac.sessionId}/messages`);
        const messages = await res.json();
        const el = document.getElementById('panel-messages-' + idx);
        if (!el) return;
        const msgs = Array.isArray(messages) ? messages : [];
        el.innerHTML = msgs.map(msg => {
          const sender = msg.sender || 'user';
          const time = new Date(msg.sentAt).toLocaleTimeString();
          const senderLabel = sender === 'user' ? 'Customer' : sender === 'ai' ? 'AI Assistant' : msg.senderName || 'Agent';
          let attachHtml = '';
          if (msg.attachments && msg.attachments.length > 0) {
            msg.attachments.forEach(att => {
              const url = att.url && att.url.startsWith('http') ? att.url : API + (att.url || '');
              const name = att.filename || att.originalName || 'file';
              if (att.type && att.type.startsWith('image/')) {
                attachHtml += `<div style="margin-top:6px;"><img src="${url}" style="max-width:150px; border-radius:4px; cursor:pointer;" onclick="openLightbox('${url}')"></div>`;
              } else if (att.type === 'application/pdf') {
                attachHtml += `<div style="margin-top:6px;"><a href="${url}" target="_blank" style="color:#6C5CE7;">&#x1F4C4; ${escapeHtml(name)}</a></div>`;
              } else {
                attachHtml += `<div style="margin-top:4px;"><a href="${url}" target="_blank" style="color:#6C5CE7; font-size:12px;">&#x1F4CE; ${escapeHtml(name)}</a></div>`;
              }
            });
          }
          if (msg.isInternal) {
            return `<div class="message internal"><div class="sender">Internal Note</div><div class="bubble">${escapeHtml(msg.content)}</div><div class="time">${time}</div></div>`;
          }
          return `<div class="message ${sender}"><div class="sender">${senderLabel}</div><div class="bubble">${escapeHtml(msg.content)}${attachHtml}</div><div class="time">${time}</div></div>`;
        }).join('');
        el.scrollTop = el.scrollHeight;
      } catch (err) { log('Load messages error: ' + err.message); }
    }

    function closePanel(idx) {
      const closedSessionId = activeChats[idx]?.sessionId;
      activeChats.splice(idx, 1);
      if (activeChats.length === 0) {
        selectedChat = null;
      } else if (selectedChat && selectedChat.sessionId === closedSessionId) {
        // Select the first remaining chat
        const ac = activeChats[0];
        selectedChat = { sessionId: ac.sessionId, chatId: ac.chatId, mode: ac.mode, userName: ac.userName, userEmail: ac.userEmail };
      }
      renderChatPanels();
      renderChatList();
    }

    async function takeoverPanel(idx) {
      const ac = activeChats[idx];
      if (!ac) return;
      try {
        const res = await fetch(API + '/api/chat/' + ac.sessionId + '/takeover', {
          method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (data.success) {
          ac.mode = 'human';
          if (selectedChat && selectedChat.sessionId === ac.sessionId) selectedChat.mode = 'human';
          log('Took over chat: ' + ac.userName);
          renderChatPanels();
          loadChats();
        }
      } catch (err) { log('Takeover error: ' + err.message); }
    }

    async function returnPanel(idx) {
      const ac = activeChats[idx];
      if (!ac) return;
      try {
        const res = await fetch(API + '/api/chat/' + ac.sessionId + '/return-to-ai', {
          method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (data.success) {
          ac.mode = 'ai';
          if (selectedChat && selectedChat.sessionId === ac.sessionId) selectedChat.mode = 'ai';
          log('Returned to AI: ' + ac.userName);
          renderChatPanels();
          loadChats();
        }
      } catch (err) { log('Return error: ' + err.message); }
    }

    async function sendPanelMessage(idx) {
      const ac = activeChats[idx];
      if (!ac) return;
      const input = document.querySelector(`#panel-input-${idx} input`);
      const content = input.value.trim();
      if (!content) return;
      input.value = '';
      try {
        await fetch(API + '/api/messages', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ chatId: ac.chatId, content, sender: 'agent' })
        });
        loadPanelMessages(idx);
      } catch (err) { log('Send error: ' + err.message); }
    }

    // --- Helper functions ---
    function parseUA(ua) {
      if (!ua) return '-';
      if (ua.includes('Chrome')) return 'Chrome';
      if (ua.includes('Firefox')) return 'Firefox';
      if (ua.includes('Safari')) return 'Safari';
      if (ua.includes('Edge')) return 'Edge';
      return ua.substring(0, 30);
    }

    function toggleEnvSection() {
      const d = document.getElementById('env-details');
      const t = document.getElementById('env-toggle');
      if (d.style.display === 'none') { d.style.display = 'block'; t.innerHTML = '&#x25BC;'; }
      else { d.style.display = 'none'; t.innerHTML = '&#x25B6;'; }
    }

    function openLightbox(url) {
      document.getElementById('lightbox-img').src = url;
      document.getElementById('lightbox').style.display = 'flex';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // --- Agent actions (legacy, kept for canned responses) ---
    async function takeover() {
      if (!selectedChat) return;
      const idx = activeChats.findIndex(ac => ac.sessionId === selectedChat.sessionId);
      if (idx !== -1) { takeoverPanel(idx); return; }
      try {
        const res = await fetch(`${API}/api/chat/${selectedChat.sessionId}/takeover`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (data.success) {
          log(`Took over chat from AI`);
          selectedChat.mode = 'human';
          loadChats();
        } else {
          log(`Takeover failed: ${data.error || 'unknown'}`);
        }
      } catch (err) { log(`Takeover error: ${err.message}`); }
    }

    async function returnToAI() {
      if (!selectedChat) return;
      const idx = activeChats.findIndex(ac => ac.sessionId === selectedChat.sessionId);
      if (idx !== -1) { returnPanel(idx); return; }
      try {
        const res = await fetch(`${API}/api/chat/${selectedChat.sessionId}/return-to-ai`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (data.success) {
          log('Returned chat to AI');
          selectedChat.mode = 'ai';
          loadChats();
        }
      } catch (err) { log(`Return error: ${err.message}`); }
    }

    async function suggestReply() {
      if (!selectedChat) return;
      log('Requesting AI suggestion...');
      try {
        const res = await fetch(`${API}/api/ai/suggest-reply`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ chatId: selectedChat.chatId })
        });
        const data = await res.json();
        if (data.suggestedReply) {
          // Put suggestion in the active panel's input
          const idx = activeChats.findIndex(ac => ac.sessionId === selectedChat.sessionId);
          if (idx !== -1) {
            const input = document.querySelector(`#panel-input-${idx} input`);
            if (input) input.value = data.suggestedReply;
          }
          log('AI suggestion loaded');
        } else {
          log(`Suggest failed: ${data.error || 'no suggestion'}`);
        }
      } catch (err) { log(`Suggest error: ${err.message}`); }
    }

    async function sendAgentMessage() {
      if (!selectedChat) return;
      const idx = activeChats.findIndex(ac => ac.sessionId === selectedChat.sessionId);
      if (idx !== -1) { sendPanelMessage(idx); return; }
    }

    async function addNote() {
      const input = document.getElementById('note-input');
      const content = input.value.trim();
      if (!content || !selectedChat) return;

      try {
        await fetch(`${API}/api/messages`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chatId: selectedChat.chatId,
            content,
            isInternal: true
          })
        });
        input.value = '';
        log('Internal note added');
        // Refresh the panel
        const idx = activeChats.findIndex(ac => ac.sessionId === selectedChat.sessionId);
        if (idx !== -1) loadPanelMessages(idx);
      } catch (err) { log(`Note error: ${err.message}`); }
    }

    async function deleteChat(sessionId, userName) {
      if (!confirm(`Delete chat with ${userName}? This will permanently remove all messages.`)) return;
      try {
        const res = await fetch(`${API}/api/chat/${sessionId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (data.success) {
          log(`Deleted chat with ${userName} (${data.deletedMessages} messages)`);
          // Remove from activeChats if present
          const idx = activeChats.findIndex(ac => ac.sessionId === sessionId);
          if (idx !== -1) activeChats.splice(idx, 1);
          if (selectedChat && selectedChat.sessionId === sessionId) {
            selectedChat = activeChats.length > 0 ? { ...activeChats[0] } : null;
          }
          renderChatPanels();
          loadChats();
        } else {
          log(`Delete failed: ${data.error}`);
          alert(data.error || 'Failed to delete chat');
        }
      } catch (err) {
        log(`Delete error: ${err.message}`);
      }
    }

    function useCanned(text) {
      if (!selectedChat) return;
      const idx = activeChats.findIndex(ac => ac.sessionId === selectedChat.sessionId);
      if (idx !== -1) {
        const input = document.querySelector(`#panel-input-${idx} input`);
        if (input) { input.value = text; input.focus(); }
      }
    }

    // --- WebSocket ---
    function connectWS() {
      try {
        ws = new WebSocket('ws://localhost:8004/ws');
        ws.onopen = () => {
          document.getElementById('ws-status').textContent = 'Connected';
          document.getElementById('ws-status').className = 'connected';
          ws.send(JSON.stringify({ type: 'dashboard.connect', clientType: 'dashboard' }));
          log('WebSocket connected');
        };
        ws.onmessage = (e) => {
          try {
            const data = JSON.parse(e.data);
            log(`WS: ${data.type}`);

            if (data.type && data.type !== 'error') {
              loadChats();
              // Refresh matching panel
              const panelIdx = activeChats.findIndex(ac => ac.sessionId === data.sessionId);
              if (panelIdx !== -1) {
                setTimeout(() => loadPanelMessages(panelIdx), 500);
              }
            }
          } catch {}
        };
        ws.onclose = () => {
          document.getElementById('ws-status').textContent = 'Disconnected';
          document.getElementById('ws-status').className = 'disconnected';
          setTimeout(connectWS, 3000);
        };
        ws.onerror = () => {};
      } catch (err) {
        log(`WS error: ${err.message}`);
      }
    }

    // --- Knowledge Base ---
    async function loadKBFiles() {
      if (!token) return;
      try {
        const res = await fetch(`${API}/api/knowledge`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        const files = Array.isArray(data) ? data : (data.files || []);
        const el = document.getElementById('kb-list');
        if (files.length === 0) {
          el.innerHTML = '<div style="color:#666; font-size:12px; text-align:center; padding:8px;">No documents yet</div>';
          return;
        }
        el.innerHTML = files.map(f => `
          <div class="kb-item">
            <span class="kb-name" title="${escapeHtml(f.originalName || f.filename)}">${escapeHtml(f.originalName || f.filename)}</span>
            <span class="kb-type">${f.fileType || ''}</span>
            <button class="kb-delete" onclick="deleteKBFile('${f._id}')" title="Delete">&times;</button>
          </div>
        `).join('');
      } catch (err) {
        log(`KB load error: ${err.message}`);
      }
    }

    async function uploadKBFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      event.target.value = '';

      const statusEl = document.getElementById('kb-upload-status');
      statusEl.textContent = `Uploading ${file.name}...`;
      statusEl.style.display = 'block';
      statusEl.style.color = '#f39c12';

      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch(`${API}/api/knowledge/upload`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
        const data = await res.json();
        if (data.error) {
          statusEl.textContent = data.error;
          statusEl.style.color = '#e74c3c';
        } else {
          statusEl.textContent = `Uploaded! ${data.chunks || 0} chunks, ${data.embeddings || 0} embeddings`;
          statusEl.style.color = '#00b894';
          log(`KB uploaded: ${file.name}`);
          loadKBFiles();
        }
      } catch (err) {
        statusEl.textContent = `Upload failed: ${err.message}`;
        statusEl.style.color = '#e74c3c';
      }
      setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
    }

    async function importKBUrl() {
      const input = document.getElementById('kb-url-input');
      const url = input.value.trim();
      if (!url) return;

      const statusEl = document.getElementById('kb-upload-status');
      statusEl.textContent = 'Fetching page...';
      statusEl.style.display = 'block';
      statusEl.style.color = '#f39c12';

      try {
        const res = await fetch(`${API}/api/knowledge/import-url`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        const data = await res.json();
        if (data.error) {
          statusEl.textContent = data.error;
          statusEl.style.color = '#e74c3c';
        } else {
          statusEl.textContent = `Imported! ${data.chunks} chunks from "${data.title}"`;
          statusEl.style.color = '#00b894';
          input.value = '';
          log(`KB URL imported: ${data.title}`);
          loadKBFiles();
        }
      } catch (err) {
        statusEl.textContent = `Import failed: ${err.message}`;
        statusEl.style.color = '#e74c3c';
      }
      setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
    }

    async function deleteKBFile(id) {
      if (!confirm('Delete this knowledge base document?')) return;
      try {
        const res = await fetch(`${API}/api/knowledge/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (data.error) {
          log(`KB delete failed: ${data.error}`);
        } else {
          log('KB document deleted');
          loadKBFiles();
        }
      } catch (err) {
        log(`KB delete error: ${err.message}`);
      }
    }

    // Allow Enter to login
    document.getElementById('login-password').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') login();
    });

    // --- Tab switching ---
    function switchTab(tab) {
      document.getElementById('tab-chats').classList.toggle('active', tab === 'chats');
      document.getElementById('tab-kb').classList.toggle('active', tab === 'kb');
      document.getElementById('tab-categories').classList.toggle('active', tab === 'categories');
      document.querySelector('.main').style.display = tab === 'chats' ? 'grid' : 'none';
      document.getElementById('kb-page').classList.toggle('active', tab === 'kb');
      document.getElementById('categories-page').style.display = tab === 'categories' ? 'block' : 'none';
      if (tab === 'kb') kbPageRefresh();
      if (tab === 'categories') loadCategories();
    }

    // --- KB Page functions ---
    async function kbPageRefresh() {
      if (!token) return;
      try {
        const res = await fetch(`${API}/api/knowledge`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        const files = Array.isArray(data) ? data : (data.files || []);
        const el = document.getElementById('kb-page-list');
        if (files.length === 0) {
          el.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#666; padding:30px;">No documents yet. Upload a file or import a URL.</td></tr>';
          return;
        }
        el.innerHTML = files.map(f => {
          const date = f.uploadedAt ? new Date(f.uploadedAt).toLocaleDateString() : '-';
          const name = escapeHtml(f.originalName || f.filename);
          return `<tr>
            <td title="${name}">${name}</td>
            <td>${f.fileType || '-'}</td>
            <td>${f.chunkCount || 0}</td>
            <td>${date}</td>
            <td><div class="actions-cell">
              <button class="btn-view" onclick="viewKBDoc('${f.id || f._id}')">View/Edit</button>
              <button class="btn-del" onclick="deleteKBPageDoc('${f.id || f._id}')">Delete</button>
            </div></td>
          </tr>`;
        }).join('');
      } catch (err) {
        log(`KB page load error: ${err.message}`);
      }
    }

    function kbPageStatus(msg, type) {
      const el = document.getElementById('kb-page-status');
      el.textContent = msg;
      el.className = 'kb-status ' + type;
      if (type !== 'loading') setTimeout(() => { el.className = 'kb-status'; }, 5000);
    }

    async function kbPageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      event.target.value = '';
      kbPageStatus(`Uploading ${file.name}...`, 'loading');
      const formData = new FormData();
      formData.append('file', file);
      try {
        const res = await fetch(`${API}/api/knowledge/upload`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
        const data = await res.json();
        if (data.error) { kbPageStatus(data.error, 'error'); }
        else { kbPageStatus(`Uploaded "${file.name}"  ${data.chunks || 0} chunks`, 'success'); kbPageRefresh(); loadKBFiles(); }
      } catch (err) { kbPageStatus(`Upload failed: ${err.message}`, 'error'); }
    }

    async function kbPageImportUrl() {
      const input = document.getElementById('kb-page-url');
      const url = input.value.trim();
      if (!url) return;
      kbPageStatus('Fetching page...', 'loading');
      try {
        const res = await fetch(`${API}/api/knowledge/import-url`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        const data = await res.json();
        if (data.error) { kbPageStatus(data.error, 'error'); }
        else { kbPageStatus(`Imported "${data.title}"  ${data.chunks} chunks`, 'success'); input.value = ''; kbPageRefresh(); loadKBFiles(); }
      } catch (err) { kbPageStatus(`Import failed: ${err.message}`, 'error'); }
    }

    async function deleteKBPageDoc(id) {
      if (!confirm('Delete this document and all its embeddings?')) return;
      try {
        const res = await fetch(`${API}/api/knowledge/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (data.error) { kbPageStatus(data.error, 'error'); }
        else { kbPageStatus('Document deleted', 'success'); kbPageRefresh(); loadKBFiles(); }
      } catch (err) { kbPageStatus(`Delete failed: ${err.message}`, 'error'); }
    }

    let editingKBId = null;
    async function viewKBDoc(id) {
      editingKBId = id;
      try {
        const res = await fetch(`${API}/api/knowledge/${id}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const doc = await res.json();
        if (doc.error) { alert(doc.error); return; }
        document.getElementById('kb-modal-title').textContent = doc.originalName || doc.filename;
        document.getElementById('kb-modal-info').textContent = `Type: ${doc.fileType || '-'} | Chunks: ${doc.chunks?.length || 0} | Size: ${doc.content?.length || 0} chars`;
        document.getElementById('kb-modal-content').value = doc.content || '';
        document.getElementById('kb-modal').classList.add('open');
      } catch (err) { alert('Failed to load document: ' + err.message); }
    }

    function closeKBModal() {
      document.getElementById('kb-modal').classList.remove('open');
      editingKBId = null;
    }

    async function saveKBContent() {
      if (!editingKBId) return;
      const content = document.getElementById('kb-modal-content').value;
      try {
        const res = await fetch(`${API}/api/knowledge/${editingKBId}`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ content })
        });
        const data = await res.json();
        if (data.error) { alert(data.error); }
        else { kbPageStatus('Document updated and re-embedded', 'success'); closeKBModal(); kbPageRefresh(); }
      } catch (err) { alert('Save failed: ' + err.message); }
    }

    // --- Categories CRUD ---
    async function loadCategories() {
      try {
        const res = await fetch(API + '/api/categories/all', { headers: { 'Authorization': 'Bearer ' + token } });
        const cats = await res.json();
        const el = document.getElementById('cat-list');
        const items = Array.isArray(cats) ? cats : [];
        if (!items.length) { el.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#666; padding:30px;">No categories. Add one above.</td></tr>'; return; }
        el.innerHTML = items.map(c => `<tr>
          <td>${c.icon || ''}</td>
          <td>${escapeHtml(c.name)}</td>
          <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${escapeHtml(c.prompt || '')}">${escapeHtml(c.prompt || '')}</td>
          <td><input type="checkbox" ${c.active ? 'checked' : ''} onchange="toggleCategory('${c._id}', this.checked)"></td>
          <td><div class="actions-cell"><button class="btn-del" onclick="deleteCategory('${c._id}')">Delete</button></div></td>
        </tr>`).join('');
      } catch (err) { log('Categories load error: ' + err.message); }
    }

    async function addCategory() {
      const name = document.getElementById('cat-name').value.trim();
      const icon = document.getElementById('cat-icon').value.trim() || '\u{1F4AC}';
      const prompt = document.getElementById('cat-prompt').value.trim();
      const active = document.getElementById('cat-active').checked;
      if (!name || !prompt) { alert('Name and prompt are required'); return; }
      try {
        await fetch(API + '/api/categories', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, icon, prompt, active })
        });
        document.getElementById('cat-name').value = '';
        document.getElementById('cat-prompt').value = '';
        loadCategories();
      } catch (err) { log('Add category error: ' + err.message); }
    }

    async function toggleCategory(id, active) {
      try {
        await fetch(API + '/api/categories/' + id, {
          method: 'PUT',
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ active })
        });
      } catch (err) { log('Toggle category error: ' + err.message); }
    }

    async function deleteCategory(id) {
      if (!confirm('Delete this category?')) return;
      try {
        await fetch(API + '/api/categories/' + id, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        loadCategories();
      } catch (err) { log('Delete category error: ' + err.message); }
    }

    // Poll for new chats
    setInterval(() => { if (token) loadChats(); }, 5000);
  </script>
</body>
</html>
