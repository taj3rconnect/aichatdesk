<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIChatDesk - Agent Dashboard Test</title>
  <style>
    /* ============================================================
       Dropbox-inspired Blue/White Theme
       ============================================================ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f7f8fa; color: #1e1919; }

    /* Header */
    .header { background: #fff; padding: 14px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e8eb; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
    .header h1 { font-size: 18px; color: #0061ff; font-weight: 700; }
    .header .agent-info { display: flex; gap: 15px; align-items: center; font-size: 13px; color: #637282; }
    .header .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .header .status-dot.online { background: #17a34a; }
    .header .status-dot.offline { background: #dc2626; }

    /* Layout */
    .main { display: grid; grid-template-columns: 300px 1fr 300px; height: calc(100vh - 112px); }

    /* Sidebar */
    .sidebar { background: #fff; border-right: 1px solid #e5e8eb; overflow-y: auto; }
    .sidebar h2 { padding: 15px 20px; font-size: 11px; color: #8c9bab; text-transform: uppercase; letter-spacing: 1.2px; font-weight: 700; }
    .chat-item { padding: 12px 20px; border-bottom: 1px solid #f0f2f5; cursor: pointer; transition: background 0.15s; }
    .chat-item:hover { background: #f0f5ff; }
    .chat-item.active { background: #e8f0fe; border-left: 3px solid #0061ff; }
    .chat-item .name { font-weight: 600; font-size: 14px; color: #1e1919; margin-bottom: 3px; }
    .chat-item .preview { font-size: 12px; color: #8c9bab; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-item .meta { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; font-size: 11px; color: #8c9bab; }
    .chat-item .delete-btn {
      width: 20px; height: 20px; background: none; border: none; cursor: pointer;
      color: #b0bec5; font-size: 14px; border-radius: 4px; display: flex; align-items: center;
      justify-content: center; transition: all 0.2s; padding: 0; line-height: 1;
    }
    .chat-item .delete-btn:hover { background: #fee2e2; color: #dc2626; }

    /* Badges */
    .priority-badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
    .priority-badge.high { background: #fee2e2; color: #dc2626; }
    .priority-badge.medium { background: #fef3c7; color: #d97706; }
    .priority-badge.low { background: #d1fae5; color: #059669; }
    .mode-tag { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 10px; }
    .mode-tag.ai { background: #e8f0fe; color: #0061ff; }
    .mode-tag.human { background: #d1fae5; color: #059669; }

    /* Center panel */
    .center { display: flex; flex-direction: column; position: relative; background: #fff; }
    .chat-header-bar { padding: 15px 20px; background: #fff; border-bottom: 1px solid #e5e8eb; display: flex; justify-content: space-between; align-items: center; }
    .chat-header-bar .user-name { font-weight: 600; font-size: 16px; color: #1e1919; }
    .chat-header-bar .actions { display: flex; gap: 8px; }

    /* Buttons */
    .btn { padding: 6px 14px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: 600; }
    .btn-takeover { background: #dc2626; color: white; }
    .btn-takeover:hover { background: #b91c1c; }
    .btn-return { background: #17a34a; color: white; }
    .btn-return:hover { background: #15803d; }
    .btn-suggest { background: #0061ff; color: white; }
    .btn-suggest:hover { background: #0050d4; }
    .btn-transfer { background: #d97706; color: white; }
    .btn-transfer:hover { background: #b45309; }

    /* Messages */
    .messages { flex: 1; padding: 20px; overflow-y: auto; background: #f7f8fa; }
    .message { margin-bottom: 12px; max-width: 70%; }
    .message.user { margin-left: auto; }
    .message .bubble { padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.5; }
    .message.user .bubble { background: #0061ff; color: white; border-bottom-right-radius: 4px; }
    .message.ai .bubble { background: #fff; color: #1e1919; border: 1px solid #e5e8eb; border-bottom-left-radius: 4px; }
    .message.agent .bubble { background: #d1fae5; color: #065f46; border-bottom-left-radius: 4px; }
    .message.system .bubble { background: transparent; color: #8c9bab; text-align: center; font-size: 12px; font-style: italic; max-width: 100%; }
    .message.internal .bubble { background: #fef3c7; color: #92400e; border: 1px dashed #fbbf24; font-size: 12px; }
    .message .sender { font-size: 11px; color: #8c9bab; margin-bottom: 3px; }
    .message .time { font-size: 10px; color: #b0bec5; margin-top: 3px; }

    /* Agent input */
    .agent-input { padding: 15px 20px; background: #fff; border-top: 1px solid #e5e8eb; display: flex; gap: 10px; }
    .agent-input input { flex: 1; background: #f7f8fa; border: 1px solid #d1d5db; color: #1e1919; padding: 10px 14px; border-radius: 8px; font-size: 14px; }
    .agent-input input:focus { outline: none; border-color: #0061ff; box-shadow: 0 0 0 3px rgba(0,97,255,0.1); }
    .agent-input button { background: #0061ff; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .agent-input button:hover { background: #0050d4; }

    /* Right panel */
    .right-panel { background: #fff; border-left: 1px solid #e5e8eb; overflow-y: auto; padding: 20px; }
    .right-panel h3 { font-size: 11px; color: #8c9bab; text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 12px; font-weight: 700; }
    .info-row { display: flex; justify-content: space-between; font-size: 13px; padding: 6px 0; border-bottom: 1px solid #f0f2f5; }
    .info-row .label { color: #8c9bab; }
    .info-row .value { color: #1e1919; }
    .section { margin-bottom: 25px; }
    .note-input { width: 100%; background: #f7f8fa; border: 1px solid #d1d5db; color: #1e1919; padding: 8px 12px; border-radius: 6px; font-size: 13px; resize: vertical; min-height: 60px; margin-top: 8px; font-family: inherit; }
    .note-input:focus { outline: none; border-color: #0061ff; }
    .note-btn { margin-top: 8px; background: #f0f2f5; color: #637282; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .note-btn:hover { background: #e5e8eb; color: #1e1919; }
    .canned-list { margin-top: 8px; }
    .canned-item { padding: 6px 10px; background: #f7f8fa; border-radius: 4px; margin-bottom: 4px; cursor: pointer; font-size: 12px; color: #1e1919; }
    .canned-item:hover { background: #e8f0fe; }
    .kb-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #f7f8fa; border-radius: 4px; margin-bottom: 4px; font-size: 12px; color: #1e1919; }
    .kb-item .kb-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .kb-item .kb-type { font-size: 10px; color: #8c9bab; margin: 0 6px; }
    .kb-item .kb-delete { background: none; border: none; color: #b0bec5; cursor: pointer; font-size: 14px; padding: 0 4px; }
    .kb-item .kb-delete:hover { color: #dc2626; }

    /* Connection bar */
    .connection-bar { padding: 8px 30px; font-size: 12px; display: flex; gap: 20px; background: #fff; border-bottom: 1px solid #e5e8eb; }
    .connection-bar span { color: #8c9bab; }
    .connected { color: #17a34a !important; }
    .disconnected { color: #dc2626 !important; }

    /* Tabs */
    .tab-btn { background: #f0f2f5; color: #637282; border: none; padding: 4px 14px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; }
    .tab-btn:hover { background: #e5e8eb; color: #1e1919; }
    .tab-btn.active { background: #0061ff; color: white; }

    /* KB management page */
    #kb-page { display: none; height: calc(100vh - 112px); padding: 30px; overflow-y: auto; background: #f7f8fa; }
    #kb-page.active { display: block; }
    .kb-toolbar { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
    .kb-toolbar input[type="text"] { flex: 1; min-width: 200px; background: #fff; border: 1px solid #d1d5db; color: #1e1919; padding: 10px 14px; border-radius: 8px; font-size: 14px; }
    .kb-toolbar input[type="text"]:focus { outline: none; border-color: #0061ff; box-shadow: 0 0 0 3px rgba(0,97,255,0.1); }
    .kb-toolbar .kb-btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; }
    .kb-toolbar .kb-btn-primary { background: #0061ff; color: white; }
    .kb-toolbar .kb-btn-primary:hover { background: #0050d4; }
    .kb-toolbar .kb-btn-secondary { background: #f0f2f5; color: #637282; }
    .kb-toolbar .kb-btn-secondary:hover { background: #e5e8eb; }
    .kb-status { font-size: 13px; padding: 8px 14px; border-radius: 6px; margin-bottom: 16px; display: none; }
    .kb-status.success { display: block; background: #d1fae5; color: #059669; }
    .kb-status.error { display: block; background: #fee2e2; color: #dc2626; }
    .kb-status.loading { display: block; background: #fef3c7; color: #d97706; }
    .kb-table { width: 100%; border-collapse: collapse; }
    .kb-table th { text-align: left; padding: 10px 14px; background: #f7f8fa; color: #8c9bab; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #e5e8eb; }
    .kb-table td { padding: 10px 14px; border-bottom: 1px solid #f0f2f5; font-size: 13px; color: #1e1919; }
    .kb-table tr:hover { background: #f0f5ff; }
    .kb-table .actions-cell { display: flex; gap: 6px; }
    .kb-table .actions-cell button { padding: 4px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 11px; font-weight: 600; }
    .kb-table .btn-view { background: #e8f0fe; color: #0061ff; }
    .kb-table .btn-view:hover { background: #d1e2ff; }
    .kb-table .btn-del { background: #fee2e2; color: #dc2626; }
    .kb-table .btn-del:hover { background: #fecaca; }

    /* KB viewer/editor modal */
    #kb-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); z-index: 10000; align-items: center; justify-content: center; }
    #kb-modal.open { display: flex; }
    .kb-modal-content { background: #fff; border-radius: 12px; width: 700px; max-height: 80vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
    .kb-modal-header { padding: 16px 20px; border-bottom: 1px solid #e5e8eb; display: flex; justify-content: space-between; align-items: center; }
    .kb-modal-header h3 { font-size: 16px; color: #1e1919; }
    .kb-modal-header button { background: none; border: none; color: #8c9bab; font-size: 22px; cursor: pointer; }
    .kb-modal-header button:hover { color: #1e1919; }
    .kb-modal-body { flex: 1; overflow-y: auto; padding: 20px; }
    .kb-modal-body textarea { width: 100%; min-height: 300px; background: #f7f8fa; border: 1px solid #d1d5db; color: #1e1919; padding: 12px; border-radius: 8px; font-size: 13px; font-family: 'Courier New', monospace; line-height: 1.5; resize: vertical; }
    .kb-modal-body textarea:focus { outline: none; border-color: #0061ff; }
    .kb-modal-footer { padding: 12px 20px; border-top: 1px solid #e5e8eb; display: flex; gap: 8px; justify-content: flex-end; }
    .kb-modal-footer button { padding: 8px 18px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; }
    .kb-modal-footer .btn-save { background: #0061ff; color: white; }
    .kb-modal-footer .btn-save:hover { background: #0050d4; }
    .kb-modal-footer .btn-cancel { background: #f0f2f5; color: #637282; }
    .kb-modal-footer .btn-cancel:hover { background: #e5e8eb; }
    .kb-chunk-info { font-size: 12px; color: #8c9bab; margin-bottom: 10px; }
    .empty-state { display: flex; align-items: center; justify-content: center; height: 100%; color: #8c9bab; font-size: 14px; flex-direction: column; gap: 10px; }
    .log-panel { background: #f0f2f5; padding: 15px; margin-top: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 11px; max-height: 150px; overflow-y: auto; color: #059669; white-space: pre-wrap; border: 1px solid #e5e8eb; }

    /* Login overlay */
    #login-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #0061ff 0%, #60a5fa 100%);
      display: flex; align-items: center; justify-content: center; z-index: 9999;
    }
    #login-overlay.hidden { display: none; }
    .login-box { background: #fff; padding: 40px; border-radius: 16px; width: 380px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
    .login-box h2 { color: #0061ff; margin-bottom: 24px; text-align: center; font-size: 22px; }
    .login-box input { width: 100%; padding: 12px 14px; background: #f7f8fa; border: 1px solid #d1d5db; color: #1e1919; border-radius: 8px; font-size: 14px; margin-bottom: 12px; }
    .login-box input:focus { outline: none; border-color: #0061ff; box-shadow: 0 0 0 3px rgba(0,97,255,0.1); }
    .login-box > div > button:not(.password-toggle):not(.forgot-link) { width: 100%; padding: 12px; background: #0061ff; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .login-box > div > button:not(.password-toggle):not(.forgot-link):hover { background: #0050d4; }
    .login-box .error { color: #dc2626; font-size: 13px; text-align: center; margin-top: 10px; display: none; }
    .login-box .login-options { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; font-size: 12px; }
    .login-box .login-options label { color: #637282; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .login-box .login-options label input { width: auto; margin: 0; }
    .login-box .forgot-link { color: #0061ff; cursor: pointer; background: none; border: none; font-size: 12px; padding: 0; width: auto; }
    .login-box .forgot-link:hover { text-decoration: underline; }
    .password-field { position: relative; margin-bottom: 12px; }
    .password-field input { padding-right: 40px !important; margin-bottom: 0 !important; }
    .password-toggle { position: absolute !important; right: 10px !important; top: 12px !important; background: none !important; border: none !important; color: #8c9bab !important; cursor: pointer; font-size: 14px !important; padding: 0 !important; line-height: 1; width: auto !important; }
    .password-toggle:hover { background: none !important; color: #1e1919 !important; }
    .forgot-form { display: none; }
    .forgot-form.active { display: block; }
    .login-form.hidden { display: none; }
    .logout-btn { background: none; border: 1px solid #dc262644; color: #dc2626; padding: 4px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
    .logout-btn:hover { background: #fee2e2; border-color: #dc2626; }

    /* Split panel styles */
    .split-panel { border-right: 1px solid #e5e8eb; }
    .split-panel:last-child { border-right: none; }

    /* Categories page */
    #categories-page { display: none; height: calc(100vh - 112px); padding: 30px; overflow-y: auto; background: #f7f8fa; }

    /* Users page */
    #users-page { display: none; height: calc(100vh - 112px); padding: 30px; overflow-y: auto; background: #f7f8fa; }
    .sub-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
    .sub-tab-btn { padding: 6px 16px; border-radius: 20px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; background: #f0f2f5; color: #637282; transition: all 0.2s; }
    .sub-tab-btn:hover { background: #e5e8eb; color: #1e1919; }
    .sub-tab-btn.active { background: #0061ff; color: white; }
    .sub-tab-content { display: none; }
    .sub-tab-content.active { display: block; }
    .users-toolbar { display: flex; gap: 10px; margin-bottom: 16px; align-items: center; }
    .users-toolbar .kb-btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; }
    .users-toolbar .kb-btn-primary { background: #0061ff; color: white; }
    .users-toolbar .kb-btn-primary:hover { background: #0050d4; }
    .role-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
    .role-badge.admin { background: #e8f0fe; color: #0061ff; }
    .role-badge.manager { background: #dbeafe; color: #2563eb; }
    .role-badge.agent { background: #f0f2f5; color: #637282; }
    .team-tag { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 10px; background: #f0f2f5; color: #637282; margin-right: 4px; margin-bottom: 2px; }
    .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
    .status-indicator.online { background: #17a34a; }
    .status-indicator.offline { background: #d1d5db; }
    .status-indicator.away { background: #d97706; }
    .action-btn { background: none; border: 1px solid #d1d5db; color: #637282; cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-right: 4px; transition: all 0.2s; }
    .action-btn:hover { border-color: #0061ff; color: #0061ff; }
    .action-btn.danger:hover { border-color: #dc2626; color: #dc2626; }
    .copy-btn { background: none; border: 1px solid #d1d5db; color: #637282; cursor: pointer; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 6px; }
    .copy-btn:hover { border-color: #17a34a; color: #17a34a; }

    /* Generic modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); z-index: 10000; align-items: center; justify-content: center; }
    .modal-overlay.open { display: flex; }
    .modal-box { background: #fff; border-radius: 12px; width: 500px; max-height: 80vh; overflow-y: auto; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
    .modal-box h3 { color: #1e1919; margin-bottom: 20px; font-size: 18px; }
    .modal-field { margin-bottom: 14px; }
    .modal-field label { display: block; font-size: 12px; color: #637282; margin-bottom: 4px; font-weight: 600; }
    .modal-field input, .modal-field select, .modal-field textarea { width: 100%; padding: 10px 12px; background: #f7f8fa; border: 1px solid #d1d5db; color: #1e1919; border-radius: 6px; font-size: 13px; }
    .modal-field input:focus, .modal-field select:focus { outline: none; border-color: #0061ff; box-shadow: 0 0 0 3px rgba(0,97,255,0.1); }
    .modal-field select { appearance: auto; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
    .modal-actions button { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; }
    .modal-actions .btn-primary { background: #0061ff; color: white; }
    .modal-actions .btn-primary:hover { background: #0050d4; }
    .modal-actions .btn-secondary { background: #f0f2f5; color: #637282; }
    .modal-actions .btn-secondary:hover { background: #e5e8eb; }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; padding: 8px; background: #f7f8fa; border-radius: 6px; border: 1px solid #d1d5db; min-height: 40px; }
    .checkbox-group label { display: flex; align-items: center; gap: 4px; font-size: 12px; color: #1e1919; cursor: pointer; padding: 2px 6px; background: #fff; border-radius: 4px; border: 1px solid #e5e8eb; }
    .checkbox-group input[type="checkbox"] { width: auto; margin: 0; }
    .invite-url { font-family: 'Courier New', monospace; font-size: 11px; color: #0061ff; background: #f0f5ff; padding: 4px 8px; border-radius: 4px; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle; }
    .push-rag-btn { background: none; border: none; cursor: pointer; font-size: 12px; opacity: 0.4; padding: 0 4px; transition: opacity 0.2s; vertical-align: middle; }
    .push-rag-btn:hover { opacity: 1; }
    .push-rag-btn.pushed { opacity: 0.3; cursor: default; }

    /* Agent stats bar */
    .stats-bar { padding: 6px 30px; font-size: 12px; display: flex; gap: 20px; align-items: center; background: #f0f5ff; border-bottom: 1px solid #e5e8eb; color: #637282; }
    .stats-bar .stat-item { display: flex; align-items: center; gap: 5px; }
    .stats-bar .stat-val { font-weight: 700; color: #0061ff; }
    .stats-bar .stat-sep { color: #d1d5db; }
    body.dark-mode .stats-bar { background: #1a1a2e; border-bottom-color: #2a2a4a; color: #6b7280; }
    body.dark-mode .stats-bar .stat-val { color: #60a5fa; }
    body.dark-mode .stats-bar .stat-sep { color: #2a2a4a; }

    /* Global search */
    .search-wrapper { position: relative; margin-left: auto; margin-right: 12px; }
    .search-wrapper input { width: 260px; padding: 6px 12px 6px 32px; background: #f7f8fa; border: 1px solid #d1d5db; color: #1e1919; border-radius: 8px; font-size: 13px; transition: all 0.2s; }
    .search-wrapper input:focus { outline: none; border-color: #0061ff; box-shadow: 0 0 0 3px rgba(0,97,255,0.1); width: 340px; }
    .search-wrapper .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; color: #8c9bab; pointer-events: none; }
    .search-dropdown { position: absolute; top: calc(100% + 4px); left: 0; right: 0; min-width: 400px; background: #fff; border: 1px solid #e5e8eb; border-radius: 10px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); z-index: 9000; max-height: 420px; overflow-y: auto; display: none; }
    .search-dropdown.open { display: block; }
    .search-group-label { padding: 8px 14px 4px; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #8c9bab; font-weight: 700; background: #f7f8fa; border-bottom: 1px solid #f0f2f5; position: sticky; top: 0; }
    .search-result { padding: 8px 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f0f2f5; transition: background 0.1s; }
    .search-result:hover { background: #f0f5ff; }
    .search-result:last-child { border-bottom: none; }
    .search-result .sr-icon { font-size: 16px; flex-shrink: 0; width: 24px; text-align: center; }
    .search-result .sr-body { flex: 1; min-width: 0; }
    .search-result .sr-title { font-size: 13px; font-weight: 600; color: #1e1919; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .search-result .sr-sub { font-size: 11px; color: #8c9bab; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .search-result mark { background: #fef08a; color: #1e1919; border-radius: 2px; padding: 0 1px; }
    .search-empty { padding: 20px; text-align: center; color: #8c9bab; font-size: 13px; }
    .search-loading { padding: 12px; text-align: center; color: #8c9bab; font-size: 12px; }

    /* Dark mode toggle */
    .theme-toggle { background: none; border: 1px solid #d1d5db; color: #637282; cursor: pointer; padding: 4px 10px; border-radius: 6px; font-size: 14px; transition: all 0.2s; line-height: 1; }
    .theme-toggle:hover { border-color: #0061ff; color: #0061ff; }

    /* ============================================================
       Dark Mode Overrides
       ============================================================ */
    body.dark-mode { background: #1a1a2e; color: #e0e0e0; }
    body.dark-mode .header { background: #16213e; border-bottom-color: #2a2a4a; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
    body.dark-mode .header h1 { color: #60a5fa; }
    body.dark-mode .header .agent-info { color: #9ca3af; }
    body.dark-mode .sidebar { background: #16213e; border-right-color: #2a2a4a; }
    body.dark-mode .sidebar h2 { color: #6b7280; }
    body.dark-mode .chat-item { border-bottom-color: #2a2a4a; }
    body.dark-mode .chat-item:hover { background: #1e2a4a; }
    body.dark-mode .chat-item.active { background: #1a2744; border-left-color: #60a5fa; }
    body.dark-mode .chat-item .name { color: #e0e0e0; }
    body.dark-mode .chat-item .preview { color: #6b7280; }
    body.dark-mode .chat-item .meta { color: #6b7280; }
    body.dark-mode .chat-item .delete-btn { color: #4b5563; }
    body.dark-mode .chat-item .delete-btn:hover { background: #3b1a1a; color: #f87171; }
    body.dark-mode .center { background: #1a1a2e; }
    body.dark-mode .chat-header-bar { background: #16213e; border-bottom-color: #2a2a4a; }
    body.dark-mode .chat-header-bar .user-name { color: #e0e0e0; }
    body.dark-mode .messages { background: #0f0f23; }
    body.dark-mode .message.ai .bubble { background: #1e2a4a; color: #e0e0e0; border-color: #2a2a4a; }
    body.dark-mode .message.agent .bubble { background: #0d3320; color: #86efac; }
    body.dark-mode .message.internal .bubble { background: #3b2e0a; color: #fbbf24; border-color: #92400e; }
    body.dark-mode .message .sender { color: #6b7280; }
    body.dark-mode .message .time { color: #4b5563; }
    body.dark-mode .agent-input { background: #16213e; border-top-color: #2a2a4a; }
    body.dark-mode .agent-input input { background: #1a1a2e; border-color: #2a2a4a; color: #e0e0e0; }
    body.dark-mode .agent-input input:focus { border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,0.15); }
    body.dark-mode .right-panel { background: #16213e; border-left-color: #2a2a4a; }
    body.dark-mode .right-panel h3 { color: #6b7280; }
    body.dark-mode .info-row { border-bottom-color: #2a2a4a; }
    body.dark-mode .info-row .label { color: #6b7280; }
    body.dark-mode .info-row .value { color: #e0e0e0; }
    body.dark-mode .note-input { background: #1a1a2e; border-color: #2a2a4a; color: #e0e0e0; }
    body.dark-mode .note-input:focus { border-color: #60a5fa; }
    body.dark-mode .note-btn { background: #2a2a4a; color: #9ca3af; }
    body.dark-mode .note-btn:hover { background: #3a3a5a; color: #e0e0e0; }
    body.dark-mode .canned-item { background: #1a1a2e; color: #e0e0e0; }
    body.dark-mode .canned-item:hover { background: #1e2a4a; }
    body.dark-mode .kb-item { background: #1a1a2e; color: #e0e0e0; }
    body.dark-mode .kb-item .kb-type { color: #6b7280; }
    body.dark-mode .connection-bar { background: #16213e; border-bottom-color: #2a2a4a; }
    body.dark-mode .connection-bar span { color: #6b7280; }
    body.dark-mode .tab-btn { background: #2a2a4a; color: #9ca3af; }
    body.dark-mode .tab-btn:hover { background: #3a3a5a; color: #e0e0e0; }
    body.dark-mode .tab-btn.active { background: #0061ff; color: white; }
    body.dark-mode #kb-page, body.dark-mode #categories-page, body.dark-mode #users-page { background: #0f0f23; }
    body.dark-mode .kb-toolbar input[type="text"] { background: #1a1a2e; border-color: #2a2a4a; color: #e0e0e0; }
    body.dark-mode .kb-toolbar input[type="text"]:focus { border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,0.15); }
    body.dark-mode .kb-toolbar .kb-btn-secondary { background: #2a2a4a; color: #9ca3af; }
    body.dark-mode .kb-toolbar .kb-btn-secondary:hover { background: #3a3a5a; }
    body.dark-mode .kb-table th { background: #16213e; color: #6b7280; border-bottom-color: #2a2a4a; }
    body.dark-mode .kb-table td { border-bottom-color: #2a2a4a; color: #e0e0e0; }
    body.dark-mode .kb-table tr:hover { background: #1e2a4a; }
    body.dark-mode .kb-table .btn-view { background: #1e2a4a; color: #60a5fa; }
    body.dark-mode #kb-modal .kb-modal-content, body.dark-mode .modal-box { background: #16213e; }
    body.dark-mode .kb-modal-header { border-bottom-color: #2a2a4a; }
    body.dark-mode .kb-modal-header h3, body.dark-mode .modal-box h3 { color: #e0e0e0; }
    body.dark-mode .kb-modal-header button { color: #6b7280; }
    body.dark-mode .kb-modal-header button:hover { color: #e0e0e0; }
    body.dark-mode .kb-modal-body textarea { background: #1a1a2e; border-color: #2a2a4a; color: #e0e0e0; }
    body.dark-mode .kb-modal-footer { border-top-color: #2a2a4a; }
    body.dark-mode .kb-modal-footer .btn-cancel { background: #2a2a4a; color: #9ca3af; }
    body.dark-mode .modal-field label { color: #9ca3af; }
    body.dark-mode .modal-field input, body.dark-mode .modal-field select, body.dark-mode .modal-field textarea { background: #1a1a2e; border-color: #2a2a4a; color: #e0e0e0; }
    body.dark-mode .modal-actions .btn-secondary { background: #2a2a4a; color: #9ca3af; }
    body.dark-mode .checkbox-group { background: #1a1a2e; border-color: #2a2a4a; }
    body.dark-mode .checkbox-group label { background: #16213e; border-color: #2a2a4a; color: #e0e0e0; }
    body.dark-mode .sub-tab-btn { background: #2a2a4a; color: #9ca3af; }
    body.dark-mode .sub-tab-btn:hover { background: #3a3a5a; color: #e0e0e0; }
    body.dark-mode .sub-tab-btn.active { background: #0061ff; color: white; }
    body.dark-mode .role-badge.admin { background: #1e2a4a; color: #60a5fa; }
    body.dark-mode .role-badge.manager { background: #1e2a4a; color: #93c5fd; }
    body.dark-mode .role-badge.agent { background: #2a2a4a; color: #9ca3af; }
    body.dark-mode .team-tag { background: #2a2a4a; color: #9ca3af; }
    body.dark-mode .action-btn { border-color: #2a2a4a; color: #9ca3af; }
    body.dark-mode .action-btn:hover { border-color: #60a5fa; color: #60a5fa; }
    body.dark-mode .invite-url { background: #1e2a4a; color: #60a5fa; }
    body.dark-mode .empty-state { color: #6b7280; }
    body.dark-mode .log-panel { background: #0f0f23; border-color: #2a2a4a; }
    body.dark-mode .kb-status.success { background: #0d3320; color: #86efac; }
    body.dark-mode .kb-status.error { background: #3b1a1a; color: #f87171; }
    body.dark-mode .kb-status.loading { background: #3b2e0a; color: #fbbf24; }
    body.dark-mode .logout-btn { border-color: rgba(248,113,113,0.3); color: #f87171; }
    body.dark-mode .logout-btn:hover { background: #3b1a1a; border-color: #f87171; }
    body.dark-mode .theme-toggle { border-color: #2a2a4a; color: #9ca3af; }
    body.dark-mode .theme-toggle:hover { border-color: #60a5fa; color: #60a5fa; }
    body.dark-mode .split-panel { border-right-color: #2a2a4a; }
    body.dark-mode #login-overlay { background: linear-gradient(135deg, #0f0f23 0%, #16213e 100%); }
    body.dark-mode .login-box { background: #16213e; }
    body.dark-mode .login-box h2 { color: #60a5fa; }
    body.dark-mode .login-box input { background: #1a1a2e; border-color: #2a2a4a; color: #e0e0e0; }
    body.dark-mode .login-box input:focus { border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,0.15); }
    body.dark-mode .login-box .error { color: #f87171; }
    body.dark-mode .login-box .login-options label { color: #9ca3af; }
    body.dark-mode .login-box .forgot-link { color: #60a5fa; }
    body.dark-mode .priority-badge.high { background: #3b1a1a; color: #f87171; }
    body.dark-mode .priority-badge.medium { background: #3b2e0a; color: #fbbf24; }
    body.dark-mode .priority-badge.low { background: #0d3320; color: #86efac; }
    body.dark-mode .mode-tag.ai { background: #1e2a4a; color: #60a5fa; }
    body.dark-mode .mode-tag.human { background: #0d3320; color: #86efac; }
    body.dark-mode .copy-btn { border-color: #2a2a4a; color: #9ca3af; }
    body.dark-mode .copy-btn:hover { border-color: #86efac; color: #86efac; }
    body.dark-mode .search-wrapper input { background: #1a1a2e; border-color: #2a2a4a; color: #e0e0e0; }
    body.dark-mode .search-wrapper input:focus { border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,0.15); }
    body.dark-mode .search-dropdown { background: #16213e; border-color: #2a2a4a; box-shadow: 0 8px 30px rgba(0,0,0,0.4); }
    body.dark-mode .search-group-label { background: #0f0f23; border-bottom-color: #2a2a4a; color: #6b7280; }
    body.dark-mode .search-result { border-bottom-color: #2a2a4a; }
    body.dark-mode .search-result:hover { background: #1e2a4a; }
    body.dark-mode .search-result .sr-title { color: #e0e0e0; }
    body.dark-mode .search-result .sr-sub { color: #6b7280; }
    body.dark-mode .search-result mark { background: #854d0e; color: #fef08a; }
    body.dark-mode .search-empty, body.dark-mode .search-loading { color: #6b7280; }
  </style>
</head>
<body>
  <!-- Login Overlay -->
  <div id="login-overlay">
    <div class="login-box">
      <h2>Agent Login</h2>
      <!-- Login form -->
      <div id="login-form-section">
        <input type="email" id="login-email" value="admin@myapp.com" placeholder="Email">
        <div class="password-field">
          <input type="password" id="login-password" value="changeme123" placeholder="Password">
          <button type="button" class="password-toggle" onclick="togglePasswordVisibility('login-password', this)">&#x1F441;</button>
        </div>
        <div class="login-options">
          <label><input type="checkbox" id="remember-me"> Remember me</label>
          <button class="forgot-link" onclick="showForgotPassword()">Forgot password?</button>
        </div>
        <button onclick="login()">Login</button>
      </div>
      <!-- Forgot password form -->
      <div id="forgot-form-section" class="forgot-form">
        <p style="color:#aaa; font-size:13px; margin-bottom:16px; text-align:center;">Enter your email and new password. An admin or your manager must reset your password from the Users panel.</p>
        <button onclick="showLoginForm()" style="margin-bottom:12px; background:#3a3a5a;">&larr; Back to Login</button>
      </div>
      <div class="error" id="login-error"></div>
    </div>
  </div>

  <div class="header">
    <h1 style="cursor:pointer;" onclick="switchTab('chats')">AIChatDesk Agent Dashboard</h1>
    <span style="font-size: 11px; color: #8c9bab; margin-left: 14px; font-weight: 400; letter-spacing: 0.3px;">v1.02 <span style="margin-left: 10px;">02/14 -- 23:06</span></span>
    <div class="agent-info">
      <span><span class="status-dot" id="agent-dot"></span> <span id="agent-name" style="cursor:pointer; text-decoration:underline dotted; text-underline-offset:3px;" onclick="openProfileModal()" title="My Profile">Agent</span></span>
      <span style="color: #666;">|</span>
      <span>Server: <span id="server-status">Checking...</span></span>
      <span style="color: #666;">|</span>
      <span>WS: <span id="ws-status" class="disconnected">Disconnected</span></span>
      <span style="color: #666;">|</span>
      <span style="cursor:pointer;" onclick="openProfileModal()" title="Configure in Profile">O365: <span id="o365-status" class="disconnected">Not configured</span></span>
      <div class="search-wrapper">
        <span class="search-icon">&#x1F50D;</span>
        <input type="text" id="global-search" placeholder="Search chats, agents, teams..." autocomplete="off" oninput="onSearchInput(this.value)" onfocus="onSearchFocus()" onkeydown="onSearchKeydown(event)">
        <div class="search-dropdown" id="search-dropdown"></div>
      </div>
      <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">☀️</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="connection-bar">
    <span>API: http://localhost:8004</span>
    <span>Active Chats: <span id="chat-count">0</span></span>
    <span>Queue: <span id="queue-count">0</span></span>
    <span style="margin-left:auto;">
      <button class="tab-btn active" id="tab-chats" onclick="switchTab('chats')">Chats</button>
      <button class="tab-btn" id="tab-kb" onclick="switchTab('kb')">Knowledge Base</button>
      <button class="tab-btn" id="tab-categories" onclick="switchTab('categories')">Categories</button>
      <button class="tab-btn" id="tab-users" onclick="switchTab('users')" style="display:none;">Users</button>
    </span>
  </div>

  <div class="stats-bar">
    <div class="stat-item"><span id="current-datetime" class="stat-val">--/-- - --:--</span></div>
    <span class="stat-sep">|</span>
    <div class="stat-item">Session: <span id="session-elapsed" class="stat-val">00:00</span></div>
    <span class="stat-sep">|</span>
    <div class="stat-item">Chats Attended: <span id="stat-chats-attended" class="stat-val">0</span></div>
    <span class="stat-sep">|</span>
    <div class="stat-item">Responses Sent: <span id="stat-responses-sent" class="stat-val">0</span></div>
  </div>

  <div class="main">
    <!-- Left: Chat List -->
    <div class="sidebar">
      <h2>Active Chats</h2>
      <div id="chat-list"></div>
    </div>

    <!-- Center: Chat Panels Container (split screen) -->
    <div class="center" id="chat-panels-container" style="position:relative;">
      <button id="close-all-btn" onclick="closeAllPanels()" title="Close all chat panels" style="display:none; position:absolute; top:6px; right:10px; z-index:10; background:#e74c3c; color:#fff; border:none; border-radius:4px; padding:3px 10px; font-size:11px; cursor:pointer; opacity:0.85; transition:opacity 0.2s;" onmouseenter="this.style.opacity='1'" onmouseleave="this.style.opacity='0.85'">&#x2715; Close All</button>
      <div id="chat-view-empty" class="empty-state">
        <div style="font-size: 40px; opacity: 0.3;">&#x1F4AC;</div>
        <div>Select a chat from the sidebar</div>
        <div style="font-size: 12px; color: #555;">Click to open, click another to add to split view (up to 6)</div>
      </div>
    </div>

    <!-- Right: Info Panel -->
    <div class="right-panel">
      <div class="section">
        <h3>User Information</h3>
        <div class="info-row"><span class="label">Name</span><span class="value" id="info-name">-</span></div>
        <div class="info-row"><span class="label">Email</span><span class="value" id="info-email">-</span></div>
        <div class="info-row"><span class="label">Page</span><span class="value" id="info-page">-</span></div>
        <div class="info-row"><span class="label">URL</span><span class="value" id="info-url" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="">-</span></div>
        <div class="info-row"><span class="label">Category</span><span class="value" id="info-category">-</span></div>
        <div class="info-row"><span class="label">Ticket Type</span><span class="value" id="info-ticket-type">-</span></div>
        <div class="info-row"><span class="label">User Priority</span><span class="value" id="info-user-priority">-</span></div>
        <div class="info-row"><span class="label">Mood</span><span class="value" id="info-mood">-</span></div>
        <div class="info-row"><span class="label">Mode</span><span class="value" id="info-mode">-</span></div>
        <div class="info-row"><span class="label">Status</span><span class="value" id="info-status">-</span></div>
      </div>

      <div class="section" id="env-section" style="display:none;">
        <h3 style="cursor:pointer;" onclick="toggleEnvSection()">
          Environment <span id="env-toggle">&#x25B6;</span>
        </h3>
        <div id="env-details" style="display:none;"></div>
      </div>

      <div class="section">
        <h3>Internal Notes</h3>
        <textarea class="note-input" id="note-input" placeholder="Add a note (invisible to user)..."></textarea>
        <button class="note-btn" onclick="addNote()">Add Note</button>
      </div>

      <div class="section">
        <h3>Canned Responses</h3>
        <div class="canned-list">
          <div class="canned-item" onclick="useCanned('Thank you for contacting us! Let me help you with that.')">Thanks + help</div>
          <div class="canned-item" onclick="useCanned('I\'m looking into this for you. One moment please.')">Looking into it</div>
          <div class="canned-item" onclick="useCanned('Could you provide more details about the issue?')">Need more details</div>
          <div class="canned-item" onclick="useCanned('This has been resolved. Is there anything else I can help with?')">Issue resolved</div>
        </div>
      </div>

      <div class="section">
        <h3>Knowledge Base</h3>
        <div style="margin-bottom: 8px;">
          <input type="file" id="kb-file-input" accept=".pdf,.txt,.md,.docx,.json,.csv,.html" style="display:none;" onchange="uploadKBFile(event)">
          <button class="note-btn" onclick="document.getElementById('kb-file-input').click()" style="width:100%; text-align:center;">Upload Document</button>
          <div style="font-size: 10px; color: #666; margin-top: 4px;">PDF, TXT, MD, DOCX, JSON, CSV, HTML</div>
        </div>
        <div style="margin-bottom: 8px; display: flex; gap: 4px;">
          <input type="text" id="kb-url-input" placeholder="Paste URL to import..." style="flex:1; background:#2a2a4a; border:1px solid #3a3a5a; color:#e0e0e0; padding:6px 10px; border-radius:4px; font-size:12px;">
          <button class="note-btn" onclick="importKBUrl()" style="white-space:nowrap;">Import URL</button>
        </div>
        <div id="kb-upload-status" style="font-size: 12px; color: #00b894; display: none; margin-bottom: 8px;"></div>
        <div id="kb-list" style="max-height: 200px; overflow-y: auto;"></div>
      </div>

      <div class="section">
        <h3>Event Log</h3>
        <div class="log-panel" id="log"></div>
      </div>
    </div>
  </div>

  <!-- KB Management Page -->
  <div id="kb-page">
    <h2 style="color: #6C5CE7; margin-bottom: 20px;">Knowledge Base Management</h2>

    <div class="kb-toolbar">
      <input type="file" id="kb-page-file" accept=".pdf,.txt,.md,.docx,.json,.csv,.html" style="display:none;" onchange="kbPageUpload(event)">
      <button class="kb-btn kb-btn-primary" onclick="document.getElementById('kb-page-file').click()">Upload Document</button>
      <input type="text" id="kb-page-url" placeholder="Paste URL to import (e.g. https://yoursite.com/faq)" onkeydown="if(event.key==='Enter') kbPageImportUrl()">
      <button class="kb-btn kb-btn-secondary" onclick="kbPageImportUrl()">Import URL</button>
      <button class="kb-btn kb-btn-secondary" onclick="kbPageRefresh()">Refresh</button>
    </div>

    <div class="kb-status" id="kb-page-status"></div>

    <table class="kb-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Chunks</th>
          <th>Added</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="kb-page-list"></tbody>
    </table>
  </div>

  <!-- Categories Management Page -->
  <div id="categories-page" style="display:none; height:calc(100vh - 82px); padding:30px; overflow-y:auto;">
    <h2 style="color:#6C5CE7; margin-bottom:20px;">Workflow Categories</h2>
    <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:end;">
      <div>
        <label style="font-size:11px; color:#888;">Name</label>
        <input type="text" id="cat-name" placeholder="e.g. PreSales" style="display:block; background:#2a2a4a; border:1px solid #3a3a5a; color:#e0e0e0; padding:8px 12px; border-radius:6px; font-size:13px; width:150px;">
      </div>
      <div>
        <label style="font-size:11px; color:#888;">Icon <span style="color:#6C5CE7;">(AI auto)</span></label>
        <input type="text" id="cat-icon" value="" placeholder="auto" style="display:block; background:#2a2a4a; border:1px solid #3a3a5a; color:#e0e0e0; padding:8px 12px; border-radius:6px; font-size:13px; width:60px;" title="Leave blank for AI to pick the best icon">
      </div>
      <div style="flex:1; min-width:200px;">
        <label style="font-size:11px; color:#888;">AI Prompt</label>
        <input type="text" id="cat-prompt" placeholder="System prompt for this category..." style="display:block; width:100%; background:#2a2a4a; border:1px solid #3a3a5a; color:#e0e0e0; padding:8px 12px; border-radius:6px; font-size:13px;">
      </div>
      <div>
        <label style="font-size:11px; color:#888;">Active</label>
        <input type="checkbox" id="cat-active" checked style="display:block; margin-top:8px;">
      </div>
      <button class="kb-btn kb-btn-primary" onclick="addCategory()" style="height:36px;">Add Category</button>
    </div>
    <div id="cat-status" class="kb-status"></div>
    <table class="kb-table">
      <thead><tr><th>Icon</th><th>Name</th><th>Prompt</th><th>Active</th><th>Actions</th></tr></thead>
      <tbody id="cat-list"></tbody>
    </table>
  </div>

  <!-- KB View/Edit Modal -->
  <div id="kb-modal">
    <div class="kb-modal-content">
      <div class="kb-modal-header">
        <h3 id="kb-modal-title">Document</h3>
        <button onclick="closeKBModal()">&times;</button>
      </div>
      <div class="kb-modal-body">
        <div class="kb-chunk-info" id="kb-modal-info"></div>
        <textarea id="kb-modal-content"></textarea>
      </div>
      <div class="kb-modal-footer">
        <button class="btn-cancel" onclick="closeKBModal()">Cancel</button>
        <button class="btn-save" id="kb-modal-save" onclick="saveKBContent()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Users Management Page -->
  <div id="users-page">
    <h2 style="color: #6C5CE7; margin-bottom: 20px;">User Management</h2>
    <div class="sub-tabs">
      <button class="sub-tab-btn active" onclick="switchUsersSubTab('all-users')">All Users</button>
      <button class="sub-tab-btn" onclick="switchUsersSubTab('roles-teams')">Roles/Teams</button>
      <button class="sub-tab-btn" onclick="switchUsersSubTab('invite-links')">Invite Links</button>
    </div>

    <!-- Sub-tab: All Users -->
    <div id="subtab-all-users" class="sub-tab-content active">
      <div class="users-toolbar">
        <button class="kb-btn kb-btn-primary" onclick="showUserModal()">+ Add User</button>
      </div>
      <table class="kb-table">
        <thead><tr><th>Name</th><th>Email</th><th>System Role</th><th>Teams/Roles</th><th>Manager</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="users-list"></tbody>
      </table>
    </div>

    <!-- Sub-tab: Roles/Teams -->
    <div id="subtab-roles-teams" class="sub-tab-content">
      <div class="users-toolbar">
        <button class="kb-btn kb-btn-primary" onclick="showRoleModal()">+ Create Role</button>
      </div>
      <table class="kb-table">
        <thead><tr><th>Icon</th><th>Role Name</th><th>Description</th><th>Manager</th><th># Agents</th><th>Actions</th></tr></thead>
        <tbody id="roles-list"></tbody>
      </table>
    </div>

    <!-- Sub-tab: Invite Links -->
    <div id="subtab-invite-links" class="sub-tab-content">
      <div class="users-toolbar">
        <button class="kb-btn kb-btn-primary" onclick="showInviteLinkModal()">+ Create Invite Link</button>
      </div>
      <table class="kb-table">
        <thead><tr><th>Label</th><th>URL</th><th>Roles</th><th>Used/Max</th><th>Created</th><th>Actions</th></tr></thead>
        <tbody id="invite-links-list"></tbody>
      </table>
    </div>
  </div>

  <!-- Add/Edit User Modal -->
  <div class="modal-overlay" id="user-modal">
    <div class="modal-box">
      <h3 id="user-modal-title">Add User</h3>
      <input type="hidden" id="user-modal-id">
      <div class="modal-field">
        <label>Name</label>
        <input type="text" id="user-modal-name" placeholder="Full name">
      </div>
      <div class="modal-field">
        <label>Email</label>
        <input type="email" id="user-modal-email" placeholder="email@example.com">
      </div>
      <div class="modal-field" id="user-modal-password-field">
        <label>Password</label>
        <div class="password-field">
          <input type="password" id="user-modal-password" placeholder="Min 8 characters">
          <button type="button" class="password-toggle" onclick="togglePasswordVisibility('user-modal-password', this)" style="margin-bottom:0;">&#x1F441;</button>
        </div>
      </div>
      <div class="modal-field" id="user-modal-sysrole-field">
        <label>System Role</label>
        <select id="user-modal-sysrole">
          <option value="agent">Agent</option>
          <option value="manager">Manager</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="modal-field">
        <label>Roles/Teams</label>
        <div class="checkbox-group" id="user-modal-roles"></div>
      </div>
      <div class="modal-field">
        <label>Manager</label>
        <select id="user-modal-manager">
          <option value="">None</option>
        </select>
      </div>
      <div class="modal-field">
        <label>Office 365 Email (for calendar)</label>
        <input type="email" id="user-modal-office365" placeholder="user@company.com">
      </div>
      <div class="modal-field">
        <label>Microsoft Teams Email</label>
        <input type="email" id="user-modal-teams" placeholder="user@company.com">
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeModal('user-modal')">Cancel</button>
        <button class="btn-primary" onclick="saveUser()">Save</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Role Modal -->
  <div class="modal-overlay" id="role-modal">
    <div class="modal-box">
      <h3 id="role-modal-title">Create Role</h3>
      <input type="hidden" id="role-modal-id">
      <div class="modal-field">
        <label>Name</label>
        <input type="text" id="role-modal-name" placeholder="Role name">
      </div>
      <div class="modal-field">
        <label>Description</label>
        <input type="text" id="role-modal-desc" placeholder="What this role does...">
      </div>
      <div class="modal-field">
        <label>Icon <span style="color:#6C5CE7;">(AI auto)</span></label>
        <input type="text" id="role-modal-icon" placeholder="auto">
      </div>
      <div class="modal-field">
        <label>Manager</label>
        <select id="role-modal-manager">
          <option value="">None</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeModal('role-modal')">Cancel</button>
        <button class="btn-primary" onclick="saveRole()">Save</button>
      </div>
    </div>
  </div>

  <!-- Create Invite Link Modal -->
  <div class="modal-overlay" id="invite-modal">
    <div class="modal-box">
      <h3>Create Invite Link</h3>
      <div class="modal-field">
        <label>Label</label>
        <input type="text" id="invite-modal-label" placeholder="e.g. Q1 Hiring Batch">
      </div>
      <div class="modal-field">
        <label>Roles</label>
        <div class="checkbox-group" id="invite-modal-roles"></div>
      </div>
      <div class="modal-field">
        <label>Default Manager</label>
        <select id="invite-modal-manager">
          <option value="">None</option>
        </select>
      </div>
      <div class="modal-field">
        <label>Max Uses (0 = unlimited)</label>
        <input type="number" id="invite-modal-max" value="0" min="0">
      </div>
      <div class="modal-field">
        <label>Expiry Date (optional)</label>
        <input type="date" id="invite-modal-expiry">
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeModal('invite-modal')">Cancel</button>
        <button class="btn-primary" onclick="createInviteLink()">Create</button>
      </div>
    </div>
  </div>

  <!-- Reset Password Modal -->
  <div class="modal-overlay" id="reset-pw-modal">
    <div class="modal-box">
      <h3>Reset Password</h3>
      <input type="hidden" id="reset-pw-agent-id">
      <div class="modal-field">
        <label>Agent</label>
        <input type="text" id="reset-pw-agent-name" readonly style="opacity: 0.7;">
      </div>
      <div class="modal-field">
        <label>New Password</label>
        <div class="password-field">
          <input type="password" id="reset-pw-value" placeholder="Min 8 characters">
          <button type="button" class="password-toggle" onclick="togglePasswordVisibility('reset-pw-value', this)" style="margin-bottom:0;">&#x1F441;</button>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeModal('reset-pw-modal')">Cancel</button>
        <button class="btn-primary" onclick="resetAgentPassword()">Reset Password</button>
      </div>
    </div>
  </div>

  <!-- Profile Settings Modal -->
  <div class="modal-overlay" id="profile-modal">
    <div class="modal-box">
      <h3>My Profile</h3>
      <div class="modal-field">
        <label>Name</label>
        <input type="text" id="profile-name" placeholder="Your name">
      </div>
      <div class="modal-field">
        <label>Email (read-only)</label>
        <input type="email" id="profile-email" readonly style="opacity:0.6;">
      </div>
      <div class="modal-field">
        <label>Office 365 Email (for calendar integration)</label>
        <input type="email" id="profile-office365" placeholder="user@company.com">
      </div>
      <div class="modal-field">
        <label>Microsoft Teams Email</label>
        <input type="email" id="profile-teams" placeholder="user@company.com">
      </div>
      <hr style="border:none; border-top:1px solid #2a2a4a; margin:16px 0;">
      <h4 style="color:#aaa; font-size:13px; margin-bottom:12px;">Change Password</h4>
      <div class="modal-field">
        <label>Current Password</label>
        <div class="password-field">
          <input type="password" id="profile-current-pw" placeholder="Enter current password">
          <button type="button" class="password-toggle" onclick="togglePasswordVisibility('profile-current-pw', this)" style="margin-bottom:0;">&#x1F441;</button>
        </div>
      </div>
      <div class="modal-field">
        <label>New Password</label>
        <div class="password-field">
          <input type="password" id="profile-new-pw" placeholder="Min 8 characters">
          <button type="button" class="password-toggle" onclick="togglePasswordVisibility('profile-new-pw', this)" style="margin-bottom:0;">&#x1F441;</button>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeModal('profile-modal')">Cancel</button>
        <button class="btn-primary" onclick="saveProfile()">Save Profile</button>
      </div>
      <div id="profile-msg" style="margin-top:10px; font-size:12px; text-align:center; display:none;"></div>
    </div>
  </div>

  <!-- Lightbox overlay for image attachments -->
  <!-- Notes Modal -->
  <div id="notes-modal" style="display:none; position:fixed; inset:0; z-index:10000; background:rgba(0,0,0,0.7); align-items:center; justify-content:center;" onclick="if(event.target===this)closeNotesModal()">
    <div style="background:#1a1a2e; border:1px solid #4a5568; border-radius:8px; width:450px; box-shadow:0 20px 40px rgba(0,0,0,0.5);">
      <div style="padding:12px 16px; border-bottom:1px solid #2a2a4a; display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:600; color:#f59e0b;">&#x1F4DD; Agent Notes</span>
        <button onclick="closeNotesModal()" style="background:none; border:none; color:#888; font-size:18px; cursor:pointer;">&times;</button>
      </div>
      <div style="padding:16px;">
        <textarea id="notes-textarea" placeholder="Write your notes about this chat..." style="width:100%; height:150px; background:#0d1117; color:#e2e8f0; border:1px solid #4a5568; border-radius:6px; padding:10px; font-size:13px; resize:vertical; font-family:inherit; box-sizing:border-box;"></textarea>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
          <button onclick="closeNotesModal()" style="background:#374151; color:#e2e8f0; border:none; border-radius:4px; padding:6px 14px; cursor:pointer; font-size:12px;">Cancel</button>
          <button onclick="saveNotes()" style="background:#f59e0b; color:#000; border:none; border-radius:4px; padding:6px 14px; cursor:pointer; font-size:12px; font-weight:600;">Save Notes</button>
        </div>
      </div>
    </div>
  </div>

  <div id="lightbox" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:10000; cursor:pointer; align-items:center; justify-content:center;" onclick="this.style.display='none'">
    <img id="lightbox-img" style="max-width:90vw; max-height:90vh; border-radius:8px;">
  </div>

  <script>
    // Theme toggle
    function toggleTheme() {
      const isDark = document.body.classList.toggle('dark-mode');
      localStorage.setItem('aichatdesk-theme', isDark ? 'dark' : 'light');
      document.getElementById('theme-toggle').textContent = isDark ? '🌙' : '☀️';
    }
    // Apply saved theme on load
    (function() {
      const saved = localStorage.getItem('aichatdesk-theme');
      if (saved === 'dark') {
        document.body.classList.add('dark-mode');
        document.addEventListener('DOMContentLoaded', () => {
          const btn = document.getElementById('theme-toggle');
          if (btn) btn.textContent = '🌙';
        });
      }
    })();

    const API = 'http://localhost:8004';
    let token = null;
    let agentId = null;
    let agentName = '';
    let selectedChat = null; // { sessionId, chatId, mode, userName, userEmail }
    let chatList = [];
    let ws = null;

    // Session stats
    let sessionStartTime = null;
    let sessionChatsAttended = 0;
    let sessionResponsesSent = 0;

    function updateDateTime() {
      const now = new Date();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      let h = now.getHours();
      const ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12 || 12;
      const min = String(now.getMinutes()).padStart(2, '0');
      document.getElementById('current-datetime').textContent = mm + '/' + dd + ' - ' + h + ':' + min + ' ' + ampm;
    }

    function updateSessionElapsed() {
      if (!sessionStartTime) return;
      const diff = Math.floor((Date.now() - sessionStartTime) / 1000);
      const hrs = String(Math.floor(diff / 3600)).padStart(2, '0');
      const mins = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
      document.getElementById('session-elapsed').textContent = hrs + ':' + mins;
    }

    function startSessionTimer() {
      sessionStartTime = Date.now();
      sessionChatsAttended = 0;
      sessionResponsesSent = 0;
      updateDateTime();
      updateSessionElapsed();
      setInterval(updateDateTime, 10000);
      setInterval(updateSessionElapsed, 30000);
    }

    function incrementChatsAttended() {
      sessionChatsAttended++;
      document.getElementById('stat-chats-attended').textContent = sessionChatsAttended;
    }

    function incrementResponsesSent() {
      sessionResponsesSent++;
      document.getElementById('stat-responses-sent').textContent = sessionResponsesSent;
    }

    async function updateO365Status(email) {
      const el = document.getElementById('o365-status');
      if (!email) {
        el.textContent = 'Not configured';
        el.className = 'disconnected';
        el.parentElement.title = 'Click to configure Office 365 in Profile';
        return;
      }
      el.textContent = 'Checking...';
      el.className = '';
      el.style.color = '#d97706';
      try {
        const res = await fetch(API + '/api/calendar/status');
        const data = await res.json();
        if (data.configured) {
          el.textContent = 'Connected';
          el.className = 'connected';
          el.parentElement.title = 'Office 365: ' + email;
        } else {
          el.textContent = email.split('@')[0];
          el.className = 'disconnected';
          el.style.color = '#d97706';
          el.parentElement.title = 'Office 365 email set but calendar API not configured. Check server env vars.';
        }
      } catch (e) {
        el.textContent = email.split('@')[0];
        el.className = 'disconnected';
        el.style.color = '#d97706';
        el.parentElement.title = 'Could not verify Office 365 connection';
      }
    }

    // Multi-chat split screen state
    let activeChats = []; // Array of { sessionId, chatId, mode, userName, userEmail }
    const MAX_SPLIT = 6;

    function log(msg) {
      const el = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      el.textContent += `[${time}] ${msg}\n`;
      el.scrollTop = el.scrollHeight;
    }

    // --- Password visibility toggle ---
    function togglePasswordVisibility(inputId, btn) {
      const input = document.getElementById(inputId);
      if (input.type === 'password') {
        input.type = 'text';
        btn.innerHTML = '&#x1F576;';
      } else {
        input.type = 'password';
        btn.innerHTML = '&#x1F441;';
      }
    }

    // --- Forgot password / login form toggle ---
    function showForgotPassword() {
      document.getElementById('login-form-section').classList.add('hidden');
      document.getElementById('login-form-section').style.display = 'none';
      document.getElementById('forgot-form-section').classList.add('active');
      document.getElementById('forgot-form-section').style.display = 'block';
    }
    function showLoginForm() {
      document.getElementById('forgot-form-section').classList.remove('active');
      document.getElementById('forgot-form-section').style.display = 'none';
      document.getElementById('login-form-section').classList.remove('hidden');
      document.getElementById('login-form-section').style.display = '';
    }

    // --- Remember me: auto-fill from localStorage ---
    (function initRememberMe() {
      const saved = localStorage.getItem('aichatdesk_remember');
      if (saved) {
        try {
          const { email } = JSON.parse(saved);
          document.getElementById('login-email').value = email;
          document.getElementById('remember-me').checked = true;
        } catch (e) {}
      }
    })();

    // --- Login ---
    async function login() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');
      errorEl.style.display = 'none';

      // Remember me
      const rememberMe = document.getElementById('remember-me').checked;
      if (rememberMe) {
        localStorage.setItem('aichatdesk_remember', JSON.stringify({ email }));
      } else {
        localStorage.removeItem('aichatdesk_remember');
      }

      try {
        const res = await fetch(`${API}/api/agents/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();

        if (data.token) {
          token = data.token;
          agentId = data.agent?.id;
          agentName = data.agent?.name || 'Agent';

          // Persist session if remember me
          if (rememberMe) {
            localStorage.setItem('aichatdesk_token', token);
            localStorage.setItem('aichatdesk_agent', JSON.stringify(data.agent));
          }

          document.getElementById('login-overlay').classList.add('hidden');
          document.getElementById('agent-name').textContent = agentName;
          document.getElementById('agent-dot').classList.add('online');
          document.getElementById('server-status').textContent = 'Connected';
          document.getElementById('server-status').classList.add('connected');
          currentAgentSystemRole = data.agent?.systemRole || data.agent?.role || 'agent';
          log(`Logged in as ${agentName} (${currentAgentSystemRole})`);
          updateO365Status(data.agent?.office365Email);
          // Show Users tab for admin and manager
          if (currentAgentSystemRole === 'admin' || currentAgentSystemRole === 'manager') {
            document.getElementById('tab-users').style.display = '';
          }
          startSessionTimer();
          loadChats();
          loadKBFiles();
          connectWS();
        } else {
          errorEl.textContent = data.error || 'Login failed';
          errorEl.style.display = 'block';
        }
      } catch (err) {
        errorEl.textContent = 'Cannot connect to server';
        errorEl.style.display = 'block';
      }
    }

    // --- Auto-login from saved session ---
    (function tryAutoLogin() {
      const savedToken = localStorage.getItem('aichatdesk_token');
      const savedAgent = localStorage.getItem('aichatdesk_agent');
      if (savedToken && savedAgent) {
        try {
          const agent = JSON.parse(savedAgent);
          token = savedToken;
          agentId = agent.id;
          agentName = agent.name || 'Agent';
          currentAgentSystemRole = agent.systemRole || agent.role || 'agent';
          document.getElementById('login-overlay').classList.add('hidden');
          document.getElementById('agent-name').textContent = agentName;
          document.getElementById('agent-dot').classList.add('online');
          document.getElementById('server-status').textContent = 'Connected';
          document.getElementById('server-status').classList.add('connected');
          if (currentAgentSystemRole === 'admin' || currentAgentSystemRole === 'manager') {
            document.getElementById('tab-users').style.display = '';
          }
          log(`Auto-logged in as ${agentName} (${currentAgentSystemRole})`);
          updateO365Status(agent.office365Email);
          startSessionTimer();
          loadChats();
          loadKBFiles();
          connectWS();
        } catch (e) {
          localStorage.removeItem('aichatdesk_token');
          localStorage.removeItem('aichatdesk_agent');
        }
      }
    })();

    // --- Logout ---
    async function logout() {
      try {
        if (token) {
          await fetch(`${API}/api/agents/logout`, {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token }
          });
        }
      } catch (e) {}
      token = null;
      agentId = null;
      agentName = '';
      currentAgentSystemRole = '';
      localStorage.removeItem('aichatdesk_token');
      localStorage.removeItem('aichatdesk_agent');
      if (ws) { ws.close(); ws = null; }
      document.getElementById('login-overlay').classList.remove('hidden');
      document.getElementById('agent-dot').classList.remove('online');
      document.getElementById('agent-name').textContent = 'Agent';
      document.getElementById('tab-users').style.display = 'none';
      log('Logged out');
    }

    // --- Load chats ---
    async function loadChats() {
      if (!token) return;
      try {
        const res = await fetch(`${API}/api/dashboard/chats`);
        const chats = await res.json();
        chatList = Array.isArray(chats) ? chats : [];
        renderChatList();
      } catch (err) {
        log(`Failed to load chats: ${err.message}`);
      }
    }

    function renderChatList() {
      const el = document.getElementById('chat-list');
      const active = chatList.filter(c => c.status === 'active');
      const waiting = chatList.filter(c => c.status === 'waiting');
      document.getElementById('chat-count').textContent = active.length;
      document.getElementById('queue-count').textContent = waiting.length;

      if (chatList.length === 0) {
        el.innerHTML = '<div style="padding: 20px; color: #666; text-align: center; font-size: 13px;">No active chats.<br>Open the <a href="index.html" style="color: #6C5CE7;">customer test page</a> and start a chat.</div>';
        return;
      }

      const ticketIcons = { bug: '\u{1F41B}', feature: '\u2728', question: '\u2753', support: '\u{1F3AB}' };
      el.innerHTML = chatList.map(chat => {
        const priority = chat.priority || 'low';
        const mode = chat.mode || 'ai';
        const isSelected = selectedChat && selectedChat.sessionId === chat.sessionId;
        const isInSplit = activeChats.some(ac => ac.sessionId === chat.sessionId);
        const tktIcon = ticketIcons[chat.ticketType] || '';
        const isActive = chat.status === 'active' || chat.status === 'waiting';
        const statusDot = isActive
          ? '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#17a34a;margin-right:6px;flex-shrink:0;" title="Active"></span>'
          : '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#6b7280;margin-right:6px;flex-shrink:0;font-size:7px;text-align:center;line-height:10px;color:#fff;" title="Done">&#x2713;</span>';
        const statusLabel = isActive ? 'Active' : 'Done';
        return `
          <div class="chat-item ${isSelected ? 'active' : ''} ${isInSplit && !isSelected ? 'in-split' : ''}" onclick="selectChat('${chat.sessionId}')" style="${isInSplit && !isSelected ? 'border-left: 3px solid #00b894;' : ''}">
            <div class="name" style="display:flex;align-items:center;">${statusDot}${tktIcon ? tktIcon + ' ' : ''}${chat.userName || 'Anonymous'}${chat.metadata?.profanity ? ' <span style="background:#dc2626;color:#fff;font-size:9px;font-weight:700;padding:1px 4px;border-radius:3px;margin-left:4px;" title="Profanity detected">XX</span>' : ''} <span style="margin-left:auto;font-size:10px;color:${isActive ? '#17a34a' : '#8c9bab'};font-weight:600;">${statusLabel}</span></div>
            <div class="preview" style="color:#0061ff; font-size:11px; margin-bottom:2px; overflow:hidden; text-overflow:ellipsis;" title="${chat.metadata?.environment?.currentUrl || chat.metadata?.currentPage || ''}">${chat.metadata?.environment?.currentUrl || chat.metadata?.currentPage || ''}</div>
            <div class="preview">${chat.summary || chat.category || 'New conversation'}</div>
            <div class="meta">
              <span class="priority-badge ${priority}">${priority}</span>
              <span class="mode-tag ${mode}">${mode.toUpperCase()}</span>
              <span>${chat.waitTime || 0}m</span>
              <button class="notes-btn" onclick="event.stopPropagation(); openNotesModal('${chat.sessionId}')" title="${chat.agentNotes ? 'View notes' : 'Add notes'}" style="background:none; border:none; cursor:pointer; font-size:12px; padding:0 2px; color:${chat.agentNotes ? '#f59e0b' : '#555'};">${chat.agentNotes ? '&#x1F4DD;' : '&#x2795;'}</button>
              <button class="delete-btn" onclick="event.stopPropagation(); deleteChat('${chat.sessionId}', '${(chat.userName || 'Anonymous').replace(/'/g, "\\'")}')" title="Delete chat">&times;</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // --- Select chat (multi-panel) ---
    async function selectChat(sessionId) {
      const chat = chatList.find(c => c.sessionId === sessionId);
      if (!chat) return;

      // Check if already in activeChats
      const existing = activeChats.findIndex(ac => ac.sessionId === sessionId);
      if (existing === -1) {
        if (activeChats.length >= MAX_SPLIT) {
          alert('Maximum 4 chats open. Close one first.');
          return;
        }
        activeChats.push({
          sessionId: chat.sessionId,
          chatId: chat._id,
          mode: chat.mode,
          userName: chat.userName,
          userEmail: chat.userEmail,
          userUrl: chat.metadata?.environment?.currentUrl || chat.metadata?.currentPage || ''
        });
        incrementChatsAttended();
      }

      selectedChat = {
        sessionId: chat.sessionId,
        chatId: chat._id,
        mode: chat.mode,
        userName: chat.userName,
        userEmail: chat.userEmail
      };

      log(`Selected chat: ${chat.userName} (${sessionId.substring(0, 8)}...)`);

      // Update right panel info
      document.getElementById('info-name').textContent = chat.userName || '-';
      document.getElementById('info-email').textContent = chat.userEmail || '-';
      document.getElementById('info-page').textContent = chat.metadata?.currentPage || '-';
      const userUrl = chat.metadata?.environment?.currentUrl || chat.metadata?.currentPage || '-';
      document.getElementById('info-url').textContent = userUrl;
      document.getElementById('info-url').title = userUrl;
      document.getElementById('info-category').textContent = chat.category || '-';
      document.getElementById('info-ticket-type').textContent = chat.ticketType || '-';
      document.getElementById('info-user-priority').textContent = chat.userPriority || '-';
      const moodEmojis = { 1: '\u{1F621}', 2: '\u{1F615}', 3: '\u{1F610}', 4: '\u{1F642}', 5: '\u{1F929}' };
      document.getElementById('info-mood').textContent = chat.mood ? `${moodEmojis[chat.mood] || ''} (${chat.mood}/5)` : '-';
      document.getElementById('info-mode').textContent = (chat.mode || 'ai').toUpperCase();
      document.getElementById('info-status').textContent = chat.status || '-';

      // Environment info
      const env = chat.metadata?.environment;
      if (env) {
        document.getElementById('env-section').style.display = 'block';
        const envEl = document.getElementById('env-details');
        envEl.innerHTML = [
          {l:'Browser', v: parseUA(env.browser)},
          {l:'Platform', v: env.platform},
          {l:'Language', v: env.language},
          {l:'Screen', v: `${env.screenWidth}x${env.screenHeight} @${env.devicePixelRatio}x`},
          {l:'Window', v: `${env.windowWidth}x${env.windowHeight}`},
          {l:'Timezone', v: env.timezone},
          {l:'Online', v: env.online ? 'Yes' : 'No'},
          {l:'Connection', v: env.connectionType || '-'},
          {l:'CPU Cores', v: env.hardwareConcurrency || '-'},
          {l:'Memory', v: env.deviceMemory ? env.deviceMemory + 'GB' : '-'},
          {l:'Touch', v: env.maxTouchPoints > 0 ? 'Yes (' + env.maxTouchPoints + ')' : 'No'},
          {l:'Referrer', v: env.referrer || 'Direct'},
          {l:'URL', v: env.currentUrl || '-'}
        ].map(r => `<div class="info-row"><span class="label">${r.l}</span><span class="value" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(String(r.v))}">${escapeHtml(String(r.v))}</span></div>`).join('');
      } else {
        document.getElementById('env-section').style.display = 'none';
      }

      // Register WS for this session
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'chat.join', sessionId, clientType: 'dashboard' }));
      }

      renderChatPanels();
      renderChatList();
    }

    // --- Multi-panel rendering ---
    function renderChatPanels() {
      const container = document.getElementById('chat-panels-container');
      const emptyState = document.getElementById('chat-view-empty');
      const closeAllBtn = document.getElementById('close-all-btn');
      closeAllBtn.style.display = activeChats.length > 1 ? '' : 'none';

      if (activeChats.length === 0) {
        emptyState.style.display = 'flex';
        container.style.display = 'flex';
        container.style.gridTemplateColumns = '';
        container.style.gridTemplateRows = '';
        container.querySelectorAll('.split-panel').forEach(p => p.remove());
        return;
      }

      emptyState.style.display = 'none';

      // Set grid layout
      container.style.display = 'grid';
      if (activeChats.length === 1) {
        container.style.gridTemplateColumns = '1fr';
        container.style.gridTemplateRows = '1fr';
      } else if (activeChats.length === 2) {
        container.style.gridTemplateColumns = '1fr 1fr';
        container.style.gridTemplateRows = '1fr';
      } else if (activeChats.length <= 4) {
        container.style.gridTemplateColumns = '1fr 1fr';
        container.style.gridTemplateRows = '1fr 1fr';
      } else {
        container.style.gridTemplateColumns = '1fr 1fr 1fr';
        container.style.gridTemplateRows = '1fr 1fr';
      }

      // Remove old panels
      container.querySelectorAll('.split-panel').forEach(p => p.remove());

      // Create panels
      activeChats.forEach((ac, idx) => {
        const panel = document.createElement('div');
        panel.className = 'split-panel';
        panel.dataset.sessionId = ac.sessionId;
        panel.style.cssText = 'display:flex; flex-direction:column; overflow:hidden;';

        const isHuman = ac.mode === 'human';
        const isSelected = selectedChat && selectedChat.sessionId === ac.sessionId;
        panel.innerHTML = `
          <div style="padding:8px 12px; background:${isSelected ? '#1a2a4e' : '#16213e'}; border-bottom:1px solid #2a2a4a; display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
            <span style="font-weight:600; font-size:13px; cursor:pointer;" onclick="focusPanel('${ac.sessionId}')">${escapeHtml(ac.userName || 'Anonymous')}${ac.userUrl ? ' &mdash; <span style="font-weight:400; font-size:11px; color:#888; max-width:180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:inline-block; vertical-align:middle;" title="' + escapeHtml(ac.userUrl) + '">' + escapeHtml(ac.userUrl) + '</span>' : ''}</span>
            <div style="display:flex; gap:4px; align-items:center;">
              <span class="mode-tag ${ac.mode || 'ai'}" style="font-size:10px;">${(ac.mode || 'ai').toUpperCase()}</span>
              <button class="btn btn-takeover" style="font-size:10px; padding:3px 8px; ${isHuman ? 'display:none' : ''}" onclick="takeoverPanel(${idx})">Take Over</button>
              <button class="btn btn-return" style="font-size:10px; padding:3px 8px; ${isHuman ? '' : 'display:none'}" onclick="returnPanel(${idx})">Return</button>
              <button style="background:none; border:none; color:#666; cursor:pointer; font-size:16px;" onclick="closePanel(${idx})" title="Close">&times;</button>
            </div>
          </div>
          <div class="messages" id="panel-messages-${idx}" style="flex:1; padding:12px; overflow-y:auto;"></div>
          <div style="padding:8px 12px; background:#16213e; border-top:1px solid #2a2a4a; display:${isHuman ? 'flex' : 'none'}; gap:6px;" id="panel-input-${idx}">
            <input type="text" style="flex:1; background:#2a2a4a; border:1px solid #3a3a5a; color:#e0e0e0; padding:8px 10px; border-radius:6px; font-size:13px;" placeholder="Type..." onkeydown="if(event.key==='Enter') sendPanelMessage(${idx})">
            <button style="background:#6C5CE7; color:white; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600;" onclick="sendPanelMessage(${idx})">Send</button>
          </div>
        `;
        container.appendChild(panel);

        // Load messages for this panel
        loadPanelMessages(idx);
      });
    }

    function focusPanel(sessionId) {
      const chat = chatList.find(c => c.sessionId === sessionId);
      if (!chat) return;
      selectedChat = {
        sessionId: chat.sessionId,
        chatId: chat._id,
        mode: chat.mode,
        userName: chat.userName,
        userEmail: chat.userEmail
      };
      // Update right panel info
      document.getElementById('info-name').textContent = chat.userName || '-';
      document.getElementById('info-email').textContent = chat.userEmail || '-';
      document.getElementById('info-page').textContent = chat.metadata?.currentPage || '-';
      const userUrl = chat.metadata?.environment?.currentUrl || chat.metadata?.currentPage || '-';
      document.getElementById('info-url').textContent = userUrl;
      document.getElementById('info-url').title = userUrl;
      document.getElementById('info-category').textContent = chat.category || '-';
      document.getElementById('info-ticket-type').textContent = chat.ticketType || '-';
      document.getElementById('info-user-priority').textContent = chat.userPriority || '-';
      const moodEmojis = { 1: '\u{1F621}', 2: '\u{1F615}', 3: '\u{1F610}', 4: '\u{1F642}', 5: '\u{1F929}' };
      document.getElementById('info-mood').textContent = chat.mood ? `${moodEmojis[chat.mood] || ''} (${chat.mood}/5)` : '-';
      document.getElementById('info-mode').textContent = (chat.mode || 'ai').toUpperCase();
      document.getElementById('info-status').textContent = chat.status || '-';

      // Environment info
      const env = chat.metadata?.environment;
      if (env) {
        document.getElementById('env-section').style.display = 'block';
        const envEl = document.getElementById('env-details');
        envEl.innerHTML = [
          {l:'Browser', v: parseUA(env.browser)},
          {l:'Platform', v: env.platform},
          {l:'Language', v: env.language},
          {l:'Screen', v: `${env.screenWidth}x${env.screenHeight} @${env.devicePixelRatio}x`},
          {l:'Window', v: `${env.windowWidth}x${env.windowHeight}`},
          {l:'Timezone', v: env.timezone},
          {l:'Online', v: env.online ? 'Yes' : 'No'},
          {l:'Connection', v: env.connectionType || '-'},
          {l:'CPU Cores', v: env.hardwareConcurrency || '-'},
          {l:'Memory', v: env.deviceMemory ? env.deviceMemory + 'GB' : '-'},
          {l:'Touch', v: env.maxTouchPoints > 0 ? 'Yes (' + env.maxTouchPoints + ')' : 'No'},
          {l:'Referrer', v: env.referrer || 'Direct'},
          {l:'URL', v: env.currentUrl || '-'}
        ].map(r => `<div class="info-row"><span class="label">${r.l}</span><span class="value" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(String(r.v))}">${escapeHtml(String(r.v))}</span></div>`).join('');
      } else {
        document.getElementById('env-section').style.display = 'none';
      }

      renderChatPanels();
      renderChatList();
    }

    async function loadPanelMessages(idx) {
      const ac = activeChats[idx];
      if (!ac) return;
      try {
        const res = await fetch(`${API}/api/chat/${ac.sessionId}/messages`);
        const messages = await res.json();
        const el = document.getElementById('panel-messages-' + idx);
        if (!el) return;
        const msgs = Array.isArray(messages) ? messages : [];
        el.innerHTML = msgs.map(msg => {
          const sender = msg.sender || 'user';
          const time = new Date(msg.sentAt).toLocaleTimeString();
          const senderLabel = sender === 'user' ? 'Customer' : sender === 'ai' ? 'AI Assistant' : msg.senderName || 'Agent';
          let attachHtml = '';
          if (msg.attachments && msg.attachments.length > 0) {
            msg.attachments.forEach(att => {
              const url = att.url && att.url.startsWith('http') ? att.url : API + (att.url || '');
              const name = att.filename || att.originalName || 'file';
              if (att.type && att.type.startsWith('image/')) {
                attachHtml += `<div style="margin-top:6px;"><img src="${url}" style="max-width:150px; border-radius:4px; cursor:pointer;" onclick="openLightbox('${url}')"></div>`;
              } else if (att.type === 'text/plain' && name.startsWith('system-info')) {
                attachHtml += `<div style="margin-top:4px;"><button onclick="openTextPopup('${url}', '${escapeHtml(name)}')" style="background:#2d3748; color:#60a5fa; border:1px solid #4a5568; border-radius:4px; padding:2px 8px; font-size:11px; cursor:pointer;">&#x1F4BB; System Info</button></div>`;
              } else if (att.type === 'application/pdf') {
                attachHtml += `<div style="margin-top:6px;"><a href="${url}" target="_blank" style="color:#6C5CE7;">&#x1F4C4; ${escapeHtml(name)}</a></div>`;
              } else {
                attachHtml += `<div style="margin-top:4px;"><a href="${url}" target="_blank" style="color:#6C5CE7; font-size:12px;">&#x1F4CE; ${escapeHtml(name)}</a></div>`;
              }
            });
          }
          if (msg.isInternal) {
            return `<div class="message internal"><div class="sender">Internal Note</div><div class="bubble">${escapeHtml(msg.content)}</div><div class="time">${time}</div></div>`;
          }
          const pushBtn = `<button class="push-rag-btn" onclick="pushToRAG('${escapeHtml(msg.content).replace(/'/g, "\\'")}', '${sender}')" title="Push to Knowledge Base">&#x1F4DA;</button>`;
          return `<div class="message ${sender}"><div class="sender">${senderLabel} ${pushBtn}</div><div class="bubble">${escapeHtml(msg.content)}${attachHtml}</div><div class="time">${time}</div></div>`;
        }).join('');
        el.scrollTop = el.scrollHeight;
      } catch (err) { log('Load messages error: ' + err.message); }
    }

    function closeAllPanels() {
      activeChats = [];
      selectedChat = null;
      renderChatPanels();
      renderChatList();
    }

    function closePanel(idx) {
      const closedSessionId = activeChats[idx]?.sessionId;
      activeChats.splice(idx, 1);
      if (activeChats.length === 0) {
        selectedChat = null;
      } else if (selectedChat && selectedChat.sessionId === closedSessionId) {
        // Select the first remaining chat
        const ac = activeChats[0];
        selectedChat = { sessionId: ac.sessionId, chatId: ac.chatId, mode: ac.mode, userName: ac.userName, userEmail: ac.userEmail };
      }
      renderChatPanels();
      renderChatList();
    }

    async function takeoverPanel(idx) {
      const ac = activeChats[idx];
      if (!ac) return;
      try {
        const res = await fetch(API + '/api/chat/' + ac.sessionId + '/takeover', {
          method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (data.success) {
          ac.mode = 'human';
          if (selectedChat && selectedChat.sessionId === ac.sessionId) selectedChat.mode = 'human';
          log('Took over chat: ' + ac.userName);
          renderChatPanels();
          loadChats();
        }
      } catch (err) { log('Takeover error: ' + err.message); }
    }

    async function returnPanel(idx) {
      const ac = activeChats[idx];
      if (!ac) return;
      try {
        const res = await fetch(API + '/api/chat/' + ac.sessionId + '/return-to-ai', {
          method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (data.success) {
          ac.mode = 'ai';
          if (selectedChat && selectedChat.sessionId === ac.sessionId) selectedChat.mode = 'ai';
          log('Returned to AI: ' + ac.userName);
          renderChatPanels();
          loadChats();
        }
      } catch (err) { log('Return error: ' + err.message); }
    }

    async function sendPanelMessage(idx) {
      const ac = activeChats[idx];
      if (!ac) return;
      const input = document.querySelector(`#panel-input-${idx} input`);
      const content = input.value.trim();
      if (!content) return;
      input.value = '';
      try {
        await fetch(API + '/api/messages', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ chatId: ac.chatId, content, sender: 'agent' })
        });
        incrementResponsesSent();
        loadPanelMessages(idx);
      } catch (err) { log('Send error: ' + err.message); }
    }

    // --- Helper functions ---
    function parseUA(ua) {
      if (!ua) return '-';
      if (ua.includes('Chrome')) return 'Chrome';
      if (ua.includes('Firefox')) return 'Firefox';
      if (ua.includes('Safari')) return 'Safari';
      if (ua.includes('Edge')) return 'Edge';
      return ua.substring(0, 30);
    }

    function toggleEnvSection() {
      const d = document.getElementById('env-details');
      const t = document.getElementById('env-toggle');
      if (d.style.display === 'none') { d.style.display = 'block'; t.innerHTML = '&#x25BC;'; }
      else { d.style.display = 'none'; t.innerHTML = '&#x25B6;'; }
    }

    function openLightbox(url) {
      document.getElementById('lightbox-img').src = url;
      document.getElementById('lightbox').style.display = 'flex';
    }

    async function openTextPopup(url, title) {
      try {
        const res = await fetch(url);
        const text = await res.text();
        const popup = document.createElement('div');
        popup.style.cssText = 'position:fixed; inset:0; z-index:10000; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center;';
        popup.onclick = (e) => { if (e.target === popup) popup.remove(); };
        popup.innerHTML = `
          <div style="background:#1a1a2e; border:1px solid #4a5568; border-radius:8px; width:600px; max-height:80vh; display:flex; flex-direction:column; box-shadow:0 20px 40px rgba(0,0,0,0.5);">
            <div style="padding:12px 16px; border-bottom:1px solid #2a2a4a; display:flex; justify-content:space-between; align-items:center;">
              <span style="font-weight:600; color:#60a5fa;">&#x1F4BB; ${escapeHtml(title)}</span>
              <button onclick="this.closest('[style*=fixed]').remove()" style="background:none; border:none; color:#888; font-size:18px; cursor:pointer;">&times;</button>
            </div>
            <pre style="margin:0; padding:16px; overflow:auto; flex:1; font-size:12px; line-height:1.6; color:#e2e8f0; white-space:pre-wrap; font-family:'Cascadia Code','Fira Code',monospace;">${escapeHtml(text)}</pre>
          </div>`;
        document.body.appendChild(popup);
      } catch (err) {
        alert('Failed to load file: ' + err.message);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // --- Agent actions (legacy, kept for canned responses) ---
    async function takeover() {
      if (!selectedChat) return;
      const idx = activeChats.findIndex(ac => ac.sessionId === selectedChat.sessionId);
      if (idx !== -1) { takeoverPanel(idx); return; }
      try {
        const res = await fetch(`${API}/api/chat/${selectedChat.sessionId}/takeover`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (data.success) {
          log(`Took over chat from AI`);
          selectedChat.mode = 'human';
          loadChats();
        } else {
          log(`Takeover failed: ${data.error || 'unknown'}`);
        }
      } catch (err) { log(`Takeover error: ${err.message}`); }
    }

    async function returnToAI() {
      if (!selectedChat) return;
      const idx = activeChats.findIndex(ac => ac.sessionId === selectedChat.sessionId);
      if (idx !== -1) { returnPanel(idx); return; }
      try {
        const res = await fetch(`${API}/api/chat/${selectedChat.sessionId}/return-to-ai`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (data.success) {
          log('Returned chat to AI');
          selectedChat.mode = 'ai';
          loadChats();
        }
      } catch (err) { log(`Return error: ${err.message}`); }
    }

    async function suggestReply() {
      if (!selectedChat) return;
      log('Requesting AI suggestion...');
      try {
        const res = await fetch(`${API}/api/ai/suggest-reply`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ chatId: selectedChat.chatId })
        });
        const data = await res.json();
        if (data.suggestedReply) {
          // Put suggestion in the active panel's input
          const idx = activeChats.findIndex(ac => ac.sessionId === selectedChat.sessionId);
          if (idx !== -1) {
            const input = document.querySelector(`#panel-input-${idx} input`);
            if (input) input.value = data.suggestedReply;
          }
          log('AI suggestion loaded');
        } else {
          log(`Suggest failed: ${data.error || 'no suggestion'}`);
        }
      } catch (err) { log(`Suggest error: ${err.message}`); }
    }

    async function sendAgentMessage() {
      if (!selectedChat) return;
      const idx = activeChats.findIndex(ac => ac.sessionId === selectedChat.sessionId);
      if (idx !== -1) { sendPanelMessage(idx); return; }
    }

    async function addNote() {
      const input = document.getElementById('note-input');
      const content = input.value.trim();
      if (!content || !selectedChat) return;

      try {
        await fetch(`${API}/api/messages`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chatId: selectedChat.chatId,
            content,
            isInternal: true
          })
        });
        input.value = '';
        log('Internal note added');
        // Refresh the panel
        const idx = activeChats.findIndex(ac => ac.sessionId === selectedChat.sessionId);
        if (idx !== -1) loadPanelMessages(idx);
      } catch (err) { log(`Note error: ${err.message}`); }
    }

    let notesSessionId = null;

    function openNotesModal(sessionId) {
      notesSessionId = sessionId;
      const chat = chatList.find(c => c.sessionId === sessionId);
      const textarea = document.getElementById('notes-textarea');
      textarea.value = chat?.agentNotes || '';
      document.getElementById('notes-modal').style.display = 'flex';
      textarea.focus();
    }

    function closeNotesModal() {
      document.getElementById('notes-modal').style.display = 'none';
      notesSessionId = null;
    }

    async function saveNotes() {
      if (!notesSessionId) return;
      const notes = document.getElementById('notes-textarea').value.trim();
      try {
        const res = await fetch(`${API}/api/chat/${notesSessionId}/notes`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes })
        });
        const data = await res.json();
        if (data.success) {
          const chat = chatList.find(c => c.sessionId === notesSessionId);
          if (chat) chat.agentNotes = notes;
          renderChatList();
          closeNotesModal();
          log('Notes saved');
        }
      } catch (err) { log('Save notes error: ' + err.message); }
    }

    async function deleteChat(sessionId, userName) {
      try {
        const res = await fetch(`${API}/api/chat/${sessionId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (data.success) {
          log(`Deleted chat with ${userName} (${data.deletedMessages} messages)`);
          // Remove from activeChats if present
          const idx = activeChats.findIndex(ac => ac.sessionId === sessionId);
          if (idx !== -1) activeChats.splice(idx, 1);
          if (selectedChat && selectedChat.sessionId === sessionId) {
            selectedChat = activeChats.length > 0 ? { ...activeChats[0] } : null;
          }
          renderChatPanels();
          loadChats();
        } else {
          log(`Delete failed: ${data.error}`);
          alert(data.error || 'Failed to delete chat');
        }
      } catch (err) {
        log(`Delete error: ${err.message}`);
      }
    }

    function useCanned(text) {
      if (!selectedChat) return;
      const idx = activeChats.findIndex(ac => ac.sessionId === selectedChat.sessionId);
      if (idx !== -1) {
        const input = document.querySelector(`#panel-input-${idx} input`);
        if (input) { input.value = text; input.focus(); }
      }
    }

    // --- WebSocket ---
    function connectWS() {
      try {
        ws = new WebSocket('ws://localhost:8004/ws');
        ws.onopen = () => {
          document.getElementById('ws-status').textContent = 'Connected';
          document.getElementById('ws-status').className = 'connected';
          ws.send(JSON.stringify({ type: 'dashboard.connect', clientType: 'dashboard' }));
          log('WebSocket connected');
        };
        ws.onmessage = (e) => {
          try {
            const data = JSON.parse(e.data);
            log(`WS: ${data.type}`);

            if (data.type && data.type !== 'error') {
              loadChats();
              // Refresh matching panel
              const panelIdx = activeChats.findIndex(ac => ac.sessionId === data.sessionId);
              if (panelIdx !== -1) {
                setTimeout(() => loadPanelMessages(panelIdx), 500);
              }
            }
          } catch {}
        };
        ws.onclose = () => {
          document.getElementById('ws-status').textContent = 'Disconnected';
          document.getElementById('ws-status').className = 'disconnected';
          setTimeout(connectWS, 3000);
        };
        ws.onerror = () => {};
      } catch (err) {
        log(`WS error: ${err.message}`);
      }
    }

    // --- Knowledge Base ---
    async function loadKBFiles() {
      if (!token) return;
      try {
        const res = await fetch(`${API}/api/knowledge`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        const files = Array.isArray(data) ? data : (data.files || []);
        const el = document.getElementById('kb-list');
        if (files.length === 0) {
          el.innerHTML = '<div style="color:#666; font-size:12px; text-align:center; padding:8px;">No documents yet</div>';
          return;
        }
        el.innerHTML = files.map(f => `
          <div class="kb-item">
            <span class="kb-name" title="${escapeHtml(f.originalName || f.filename)}">${escapeHtml(f.originalName || f.filename)}</span>
            <span class="kb-type">${f.fileType || ''}</span>
            <button class="kb-delete" onclick="deleteKBFile('${f._id}')" title="Delete">&times;</button>
          </div>
        `).join('');
      } catch (err) {
        log(`KB load error: ${err.message}`);
      }
    }

    async function uploadKBFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      event.target.value = '';

      const statusEl = document.getElementById('kb-upload-status');
      statusEl.textContent = `Uploading ${file.name}...`;
      statusEl.style.display = 'block';
      statusEl.style.color = '#f39c12';

      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch(`${API}/api/knowledge/upload`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
        const data = await res.json();
        if (data.error) {
          statusEl.textContent = data.error;
          statusEl.style.color = '#e74c3c';
        } else {
          statusEl.textContent = `Uploaded! ${data.chunks || 0} chunks, ${data.embeddings || 0} embeddings`;
          statusEl.style.color = '#00b894';
          log(`KB uploaded: ${file.name}`);
          loadKBFiles();
        }
      } catch (err) {
        statusEl.textContent = `Upload failed: ${err.message}`;
        statusEl.style.color = '#e74c3c';
      }
      setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
    }

    async function importKBUrl() {
      const input = document.getElementById('kb-url-input');
      const url = input.value.trim();
      if (!url) return;

      const statusEl = document.getElementById('kb-upload-status');
      statusEl.textContent = 'Fetching page...';
      statusEl.style.display = 'block';
      statusEl.style.color = '#f39c12';

      try {
        const res = await fetch(`${API}/api/knowledge/import-url`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        const data = await res.json();
        if (data.error) {
          statusEl.textContent = data.error;
          statusEl.style.color = '#e74c3c';
        } else {
          statusEl.textContent = `Imported! ${data.chunks} chunks from "${data.title}"`;
          statusEl.style.color = '#00b894';
          input.value = '';
          log(`KB URL imported: ${data.title}`);
          loadKBFiles();
        }
      } catch (err) {
        statusEl.textContent = `Import failed: ${err.message}`;
        statusEl.style.color = '#e74c3c';
      }
      setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
    }

    async function deleteKBFile(id) {
      if (!confirm('Delete this knowledge base document?')) return;
      try {
        const res = await fetch(`${API}/api/knowledge/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (data.error) {
          log(`KB delete failed: ${data.error}`);
        } else {
          log('KB document deleted');
          loadKBFiles();
        }
      } catch (err) {
        log(`KB delete error: ${err.message}`);
      }
    }

    // Allow Enter to login
    document.getElementById('login-password').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') login();
    });

    // --- Tab switching ---
    function switchTab(tab) {
      document.getElementById('tab-chats').classList.toggle('active', tab === 'chats');
      document.getElementById('tab-kb').classList.toggle('active', tab === 'kb');
      document.getElementById('tab-categories').classList.toggle('active', tab === 'categories');
      document.getElementById('tab-users').classList.toggle('active', tab === 'users');
      document.querySelector('.main').style.display = tab === 'chats' ? 'grid' : 'none';
      document.getElementById('kb-page').classList.toggle('active', tab === 'kb');
      document.getElementById('categories-page').style.display = tab === 'categories' ? 'block' : 'none';
      document.getElementById('users-page').style.display = tab === 'users' ? 'block' : 'none';
      if (tab === 'kb') kbPageRefresh();
      if (tab === 'categories') loadCategories();
      if (tab === 'users') loadUsers();
    }

    // --- KB Page functions ---
    async function kbPageRefresh() {
      if (!token) return;
      try {
        const res = await fetch(`${API}/api/knowledge`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        const files = Array.isArray(data) ? data : (data.files || []);
        const el = document.getElementById('kb-page-list');
        if (files.length === 0) {
          el.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#666; padding:30px;">No documents yet. Upload a file or import a URL.</td></tr>';
          return;
        }
        el.innerHTML = files.map(f => {
          const date = f.uploadedAt ? new Date(f.uploadedAt).toLocaleDateString() : '-';
          const name = escapeHtml(f.originalName || f.filename);
          return `<tr>
            <td title="${name}">${name}</td>
            <td>${f.fileType || '-'}</td>
            <td>${f.chunkCount || 0}</td>
            <td>${date}</td>
            <td><div class="actions-cell">
              <button class="btn-view" onclick="viewKBDoc('${f.id || f._id}')">View/Edit</button>
              <button class="btn-del" onclick="deleteKBPageDoc('${f.id || f._id}')">Delete</button>
            </div></td>
          </tr>`;
        }).join('');
      } catch (err) {
        log(`KB page load error: ${err.message}`);
      }
    }

    function kbPageStatus(msg, type) {
      const el = document.getElementById('kb-page-status');
      el.textContent = msg;
      el.className = 'kb-status ' + type;
      if (type !== 'loading') setTimeout(() => { el.className = 'kb-status'; }, 5000);
    }

    async function kbPageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      event.target.value = '';
      kbPageStatus(`Uploading ${file.name}...`, 'loading');
      const formData = new FormData();
      formData.append('file', file);
      try {
        const res = await fetch(`${API}/api/knowledge/upload`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
        const data = await res.json();
        if (data.error) { kbPageStatus(data.error, 'error'); }
        else { kbPageStatus(`Uploaded "${file.name}" — ${data.chunks || 0} chunks`, 'success'); kbPageRefresh(); loadKBFiles(); }
      } catch (err) { kbPageStatus(`Upload failed: ${err.message}`, 'error'); }
    }

    async function kbPageImportUrl() {
      const input = document.getElementById('kb-page-url');
      const url = input.value.trim();
      if (!url) return;
      kbPageStatus('Fetching page...', 'loading');
      try {
        const res = await fetch(`${API}/api/knowledge/import-url`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        const data = await res.json();
        if (data.error) { kbPageStatus(data.error, 'error'); }
        else { kbPageStatus(`Imported "${data.title}" — ${data.chunks} chunks`, 'success'); input.value = ''; kbPageRefresh(); loadKBFiles(); }
      } catch (err) { kbPageStatus(`Import failed: ${err.message}`, 'error'); }
    }

    async function deleteKBPageDoc(id) {
      if (!confirm('Delete this document and all its embeddings?')) return;
      try {
        const res = await fetch(`${API}/api/knowledge/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (data.error) { kbPageStatus(data.error, 'error'); }
        else { kbPageStatus('Document deleted', 'success'); kbPageRefresh(); loadKBFiles(); }
      } catch (err) { kbPageStatus(`Delete failed: ${err.message}`, 'error'); }
    }

    let editingKBId = null;
    async function viewKBDoc(id) {
      editingKBId = id;
      try {
        const res = await fetch(`${API}/api/knowledge/${id}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const doc = await res.json();
        if (doc.error) { alert(doc.error); return; }
        document.getElementById('kb-modal-title').textContent = doc.originalName || doc.filename;
        document.getElementById('kb-modal-info').textContent = `Type: ${doc.fileType || '-'} | Chunks: ${doc.chunks?.length || 0} | Size: ${doc.content?.length || 0} chars`;
        document.getElementById('kb-modal-content').value = doc.content || '';
        document.getElementById('kb-modal').classList.add('open');
      } catch (err) { alert('Failed to load document: ' + err.message); }
    }

    function closeKBModal() {
      document.getElementById('kb-modal').classList.remove('open');
      editingKBId = null;
    }

    async function saveKBContent() {
      if (!editingKBId) return;
      const content = document.getElementById('kb-modal-content').value;
      try {
        const res = await fetch(`${API}/api/knowledge/${editingKBId}`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ content })
        });
        const data = await res.json();
        if (data.error) { alert(data.error); }
        else { kbPageStatus('Document updated and re-embedded', 'success'); closeKBModal(); kbPageRefresh(); }
      } catch (err) { alert('Save failed: ' + err.message); }
    }

    // --- Categories CRUD ---
    async function loadCategories() {
      try {
        const res = await fetch(API + '/api/categories/all', { headers: { 'Authorization': 'Bearer ' + token } });
        const cats = await res.json();
        const el = document.getElementById('cat-list');
        const items = Array.isArray(cats) ? cats : [];
        if (!items.length) { el.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#666; padding:30px;">No categories. Add one above.</td></tr>'; return; }
        el.innerHTML = items.map(c => `<tr>
          <td>${c.icon || ''}</td>
          <td>${escapeHtml(c.name)}</td>
          <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${escapeHtml(c.prompt || '')}">${escapeHtml(c.prompt || '')}</td>
          <td><input type="checkbox" ${c.active ? 'checked' : ''} onchange="toggleCategory('${c._id}', this.checked)"></td>
          <td><div class="actions-cell"><button class="btn-del" onclick="deleteCategory('${c._id}')">Delete</button></div></td>
        </tr>`).join('');
      } catch (err) { log('Categories load error: ' + err.message); }
    }

    async function addCategory() {
      const name = document.getElementById('cat-name').value.trim();
      const icon = document.getElementById('cat-icon').value.trim(); // empty = AI auto-pick
      const prompt = document.getElementById('cat-prompt').value.trim();
      const active = document.getElementById('cat-active').checked;
      if (!name || !prompt) { alert('Name and prompt are required'); return; }
      try {
        await fetch(API + '/api/categories', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, icon, prompt, active })
        });
        document.getElementById('cat-name').value = '';
        document.getElementById('cat-prompt').value = '';
        loadCategories();
      } catch (err) { log('Add category error: ' + err.message); }
    }

    async function toggleCategory(id, active) {
      try {
        await fetch(API + '/api/categories/' + id, {
          method: 'PUT',
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ active })
        });
      } catch (err) { log('Toggle category error: ' + err.message); }
    }

    async function deleteCategory(id) {
      if (!confirm('Delete this category?')) return;
      try {
        await fetch(API + '/api/categories/' + id, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        loadCategories();
      } catch (err) { log('Delete category error: ' + err.message); }
    }

    // --- Users Management ---
    let allAgents = [];
    let allRoles = [];
    let currentAgentSystemRole = 'agent'; // set after login

    function switchUsersSubTab(tab) {
      document.querySelectorAll('#users-page .sub-tab-btn').forEach((btn, i) => {
        const tabs = ['all-users', 'roles-teams', 'invite-links'];
        btn.classList.toggle('active', tabs[i] === tab);
      });
      document.querySelectorAll('#users-page .sub-tab-content').forEach(el => el.classList.remove('active'));
      document.getElementById('subtab-' + tab).classList.add('active');
      if (tab === 'all-users') loadUsers();
      if (tab === 'roles-teams') loadRolesTab();
      if (tab === 'invite-links') loadInviteLinks();
    }

    async function loadUsers() {
      if (!token) return;
      try {
        const res = await fetch(`${API}/api/agents`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        allAgents = Array.isArray(data) ? data : (data.agents || []);
        renderUsersTable();
      } catch (err) { log('Load users error: ' + err.message); }
    }

    function renderUsersTable() {
      const el = document.getElementById('users-list');
      if (!allAgents.length) {
        el.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#666; padding:30px;">No users found.</td></tr>';
        return;
      }
      el.innerHTML = allAgents.map(a => {
        const sysRole = a.systemRole || a.role || 'agent';
        const roleBadgeClass = sysRole === 'admin' ? 'admin' : sysRole === 'manager' ? 'manager' : 'agent';
        const roles = (a.roles || []).map(r => {
          const roleName = typeof r === 'string' ? r : (r.name || r);
          return `<span class="team-tag">${escapeHtml(String(roleName))}</span>`;
        }).join('');
        const managerName = a.managerName || (a.managerId ? 'ID: ' + a.managerId.substring(0, 8) : '-');
        const statusClass = a.status === 'online' ? 'online' : a.status === 'away' ? 'away' : 'offline';
        const statusLabel = a.status || 'offline';
        const deleteBtn = currentAgentSystemRole === 'admin'
          ? `<button class="action-btn danger" onclick="deleteUser('${a._id || a.id}')" title="Delete">&#x1F5D1;</button>`
          : '';
        return `<tr>
          <td>${escapeHtml(a.name || '')}</td>
          <td>${escapeHtml(a.email || '')}</td>
          <td><span class="role-badge ${roleBadgeClass}">${sysRole}</span></td>
          <td>${roles || '-'}</td>
          <td>${escapeHtml(managerName)}</td>
          <td><span class="status-indicator ${statusClass}"></span>${statusLabel}</td>
          <td>
            <button class="action-btn" onclick="showUserModal(${JSON.stringify(a).replace(/"/g, '&quot;')})" title="Edit">&#x270F;</button>
            ${deleteBtn}
            <button class="action-btn" onclick="showResetPasswordModal('${a._id || a.id}', '${escapeHtml(a.name || '')}')" title="Reset Password">&#x1F511;</button>
          </td>
        </tr>`;
      }).join('');
    }

    async function loadRolesTab() {
      if (!token) return;
      try {
        const res = await fetch(`${API}/api/agents/roles`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        allRoles = Array.isArray(data) ? data : (data.roles || []);
        renderRolesTable();
      } catch (err) { log('Load roles error: ' + err.message); }
    }

    function renderRolesTable() {
      const el = document.getElementById('roles-list');
      if (!allRoles.length) {
        el.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#666; padding:30px;">No roles yet. Create one above.</td></tr>';
        return;
      }
      el.innerHTML = allRoles.map(r => {
        const managerName = r.managerName || (r.managerId ? 'ID: ' + String(r.managerId).substring(0, 8) : '-');
        return `<tr>
          <td>${r.icon || ''}</td>
          <td>${escapeHtml(r.name || '')}</td>
          <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${escapeHtml(r.description || '')}">${escapeHtml(r.description || '')}</td>
          <td>${escapeHtml(managerName)}</td>
          <td>${r.agentCount != null ? r.agentCount : '-'}</td>
          <td><div class="actions-cell">
            <button class="btn-view" onclick='showRoleModal(${JSON.stringify(r).replace(/'/g, "&#39;")})'>Edit</button>
            <button class="btn-del" onclick="deleteRole('${r._id || r.id}')">Delete</button>
          </div></td>
        </tr>`;
      }).join('');
    }

    async function loadInviteLinks() {
      if (!token) return;
      try {
        const res = await fetch(`${API}/api/agents/invite-links`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        const links = Array.isArray(data) ? data : (data.links || []);
        renderInviteLinksTable(links);
      } catch (err) { log('Load invite links error: ' + err.message); }
    }

    function renderInviteLinksTable(links) {
      const el = document.getElementById('invite-links-list');
      if (!links.length) {
        el.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#666; padding:30px;">No invite links. Create one above.</td></tr>';
        return;
      }
      el.innerHTML = links.map(l => {
        const url = `${window.location.origin}/test/signup.html?code=${l.code}`;
        const roles = (l.roles || []).map(r => `<span class="team-tag">${escapeHtml(typeof r === 'string' ? r : (r.name || r))}</span>`).join('') || '-';
        const maxLabel = l.maxUses === 0 || !l.maxUses ? 'unlimited' : l.maxUses;
        const created = l.createdAt ? new Date(l.createdAt).toLocaleDateString() : '-';
        const isActive = l.active !== false;
        return `<tr style="${isActive ? '' : 'opacity:0.5;'}">
          <td>${escapeHtml(l.label || l.name || '-')}</td>
          <td><span class="invite-url" title="${escapeHtml(url)}">${escapeHtml(url)}</span><button class="copy-btn" onclick="copyToClipboard('${escapeHtml(url)}')">Copy</button></td>
          <td>${roles}</td>
          <td>${l.usedCount || 0} / ${maxLabel}</td>
          <td>${created}</td>
          <td>${isActive ? `<button class="btn-del" onclick="deleteInviteLink('${l._id || l.id}')">Deactivate</button>` : '<span style="color:#666;">Inactive</span>'}</td>
        </tr>`;
      }).join('');
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        log('Copied invite link to clipboard');
      }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy');
        document.body.removeChild(ta);
        log('Copied invite link to clipboard');
      });
    }

    // --- Modal helpers ---
    function closeModal(id) {
      document.getElementById(id).classList.remove('open');
    }

    async function populateRoleCheckboxes(containerId, selectedRoles) {
      // Load roles if not loaded
      if (!allRoles.length) {
        try {
          const res = await fetch(`${API}/api/agents/roles`, { headers: { 'Authorization': 'Bearer ' + token } });
          const data = await res.json();
          allRoles = Array.isArray(data) ? data : (data.roles || []);
        } catch (err) { /* ignore */ }
      }
      const container = document.getElementById(containerId);
      if (!allRoles.length) {
        container.innerHTML = '<span style="color:#666; font-size:12px;">No roles available</span>';
        return;
      }
      const selected = (selectedRoles || []).map(r => typeof r === 'string' ? r : (r._id || r.id || r.name || r));
      container.innerHTML = allRoles.map(r => {
        const rid = r._id || r.id;
        const checked = selected.includes(rid) || selected.includes(r.name) ? 'checked' : '';
        return `<label><input type="checkbox" value="${rid}" ${checked}> ${escapeHtml(r.name || '')}</label>`;
      }).join('');
    }

    async function populateManagerDropdown(selectId, selectedManagerId) {
      // Load agents if needed
      if (!allAgents.length) {
        try {
          const res = await fetch(`${API}/api/agents`, { headers: { 'Authorization': 'Bearer ' + token } });
          const data = await res.json();
          allAgents = Array.isArray(data) ? data : (data.agents || []);
        } catch (err) { /* ignore */ }
      }
      const select = document.getElementById(selectId);
      const managers = allAgents.filter(a => {
        const role = a.systemRole || a.role || 'agent';
        return role === 'admin' || role === 'manager';
      });
      select.innerHTML = '<option value="">None</option>' + managers.map(m => {
        const mid = m._id || m.id;
        const sel = mid === selectedManagerId ? 'selected' : '';
        return `<option value="${mid}" ${sel}>${escapeHtml(m.name || m.email)}</option>`;
      }).join('');
    }

    // --- User Modal ---
    async function showUserModal(agent) {
      const isEdit = !!agent;
      document.getElementById('user-modal-title').textContent = isEdit ? 'Edit User' : 'Add User';
      document.getElementById('user-modal-id').value = isEdit ? (agent._id || agent.id || '') : '';
      document.getElementById('user-modal-name').value = isEdit ? (agent.name || '') : '';
      document.getElementById('user-modal-email').value = isEdit ? (agent.email || '') : '';
      document.getElementById('user-modal-password').value = '';
      document.getElementById('user-modal-password-field').style.display = isEdit ? 'none' : 'block';
      // System role dropdown: only admin can see it
      if (currentAgentSystemRole === 'admin') {
        document.getElementById('user-modal-sysrole-field').style.display = 'block';
        document.getElementById('user-modal-sysrole').value = isEdit ? (agent.systemRole || agent.role || 'agent') : 'agent';
      } else {
        document.getElementById('user-modal-sysrole-field').style.display = 'none';
      }
      const agentRoles = isEdit ? (agent.roles || []) : [];
      document.getElementById('user-modal-office365').value = isEdit ? (agent.office365Email || '') : '';
      document.getElementById('user-modal-teams').value = isEdit ? (agent.teamsEmail || '') : '';
      await populateRoleCheckboxes('user-modal-roles', agentRoles);
      await populateManagerDropdown('user-modal-manager', isEdit ? agent.managerId : '');
      document.getElementById('user-modal').classList.add('open');
    }

    async function saveUser() {
      const id = document.getElementById('user-modal-id').value;
      const name = document.getElementById('user-modal-name').value.trim();
      const email = document.getElementById('user-modal-email').value.trim();
      const password = document.getElementById('user-modal-password').value;
      const systemRole = currentAgentSystemRole === 'admin' ? document.getElementById('user-modal-sysrole').value : 'agent';
      const roles = Array.from(document.querySelectorAll('#user-modal-roles input:checked')).map(cb => cb.value);
      const managerId = document.getElementById('user-modal-manager').value || null;
      const office365Email = document.getElementById('user-modal-office365').value.trim();
      const teamsEmail = document.getElementById('user-modal-teams').value.trim();

      if (!name || !email) { alert('Name and email are required'); return; }
      if (!id && (!password || password.length < 8)) { alert('Password must be at least 8 characters'); return; }

      const body = { name, email, systemRole, roles, managerId, office365Email, teamsEmail };
      if (!id) body.password = password;

      try {
        const url = id ? `${API}/api/agents/${id}` : `${API}/api/agents`;
        const method = id ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data.error) { alert(data.error); return; }
        closeModal('user-modal');
        log(id ? 'User updated' : 'User created');
        loadUsers();
      } catch (err) { alert('Save failed: ' + err.message); }
    }

    async function deleteUser(id) {
      if (!confirm('Deactivate this user? They will no longer be able to log in.')) return;
      try {
        const res = await fetch(`${API}/api/agents/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        if (data.error) { alert(data.error); return; }
        log('User deactivated');
        loadUsers();
      } catch (err) { alert('Delete failed: ' + err.message); }
    }

    // --- Role Modal ---
    async function showRoleModal(role) {
      const isEdit = !!role;
      document.getElementById('role-modal-title').textContent = isEdit ? 'Edit Role' : 'Create Role';
      document.getElementById('role-modal-id').value = isEdit ? (role._id || role.id || '') : '';
      document.getElementById('role-modal-name').value = isEdit ? (role.name || '') : '';
      document.getElementById('role-modal-desc').value = isEdit ? (role.description || '') : '';
      document.getElementById('role-modal-icon').value = isEdit ? (role.icon || '') : '';
      await populateManagerDropdown('role-modal-manager', isEdit ? role.managerId : '');
      document.getElementById('role-modal').classList.add('open');
    }

    async function saveRole() {
      const id = document.getElementById('role-modal-id').value;
      const name = document.getElementById('role-modal-name').value.trim();
      const description = document.getElementById('role-modal-desc').value.trim();
      const icon = document.getElementById('role-modal-icon').value.trim();
      const managerId = document.getElementById('role-modal-manager').value || null;

      if (!name) { alert('Name is required'); return; }

      const body = { name, description, icon, managerId };
      try {
        const url = id ? `${API}/api/agents/roles/${id}` : `${API}/api/agents/roles`;
        const method = id ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data.error) { alert(data.error); return; }
        closeModal('role-modal');
        log(id ? 'Role updated' : 'Role created');
        loadRolesTab();
      } catch (err) { alert('Save failed: ' + err.message); }
    }

    async function deleteRole(id) {
      if (!confirm('Delete this role? Agents with this role will be unassigned.')) return;
      try {
        const res = await fetch(`${API}/api/agents/roles/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        if (data.error) { alert(data.error); return; }
        log('Role deleted');
        loadRolesTab();
      } catch (err) { alert('Delete failed: ' + err.message); }
    }

    // --- Invite Link Modal ---
    async function showInviteLinkModal() {
      document.getElementById('invite-modal-label').value = '';
      document.getElementById('invite-modal-max').value = '0';
      document.getElementById('invite-modal-expiry').value = '';
      await populateRoleCheckboxes('invite-modal-roles', []);
      await populateManagerDropdown('invite-modal-manager', '');
      document.getElementById('invite-modal').classList.add('open');
    }

    async function createInviteLink() {
      const label = document.getElementById('invite-modal-label').value.trim();
      const roles = Array.from(document.querySelectorAll('#invite-modal-roles input:checked')).map(cb => cb.value);
      const defaultManagerId = document.getElementById('invite-modal-manager').value || null;
      const maxUses = parseInt(document.getElementById('invite-modal-max').value) || 0;
      const expiresAt = document.getElementById('invite-modal-expiry').value || null;

      if (!label) { alert('Label is required'); return; }

      try {
        const res = await fetch(`${API}/api/agents/invite-links`, {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ label, roles, defaultManagerId, maxUses, expiresAt })
        });
        const data = await res.json();
        if (data.error) { alert(data.error); return; }
        closeModal('invite-modal');
        log('Invite link created');
        loadInviteLinks();
      } catch (err) { alert('Create failed: ' + err.message); }
    }

    async function deleteInviteLink(id) {
      if (!confirm('Deactivate this invite link?')) return;
      try {
        const res = await fetch(`${API}/api/agents/invite-links/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        if (data.error) { alert(data.error); return; }
        log('Invite link deactivated');
        loadInviteLinks();
      } catch (err) { alert('Deactivate failed: ' + err.message); }
    }

    // --- Reset Password Modal ---
    function showResetPasswordModal(agentId, agentName) {
      document.getElementById('reset-pw-agent-id').value = agentId;
      document.getElementById('reset-pw-agent-name').value = agentName;
      document.getElementById('reset-pw-value').value = '';
      document.getElementById('reset-pw-modal').classList.add('open');
    }

    async function resetAgentPassword() {
      const agentId = document.getElementById('reset-pw-agent-id').value;
      const newPassword = document.getElementById('reset-pw-value').value;
      if (!newPassword || newPassword.length < 8) { alert('Password must be at least 8 characters'); return; }
      try {
        const res = await fetch(`${API}/api/agents/${agentId}/reset-password`, {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ newPassword })
        });
        const data = await res.json();
        if (data.error) { alert(data.error); return; }
        closeModal('reset-pw-modal');
        log('Password reset successfully');
      } catch (err) { alert('Reset failed: ' + err.message); }
    }

    // --- Push to RAG (knowledge base) ---
    async function pushToRAG(content, sender) {
      if (!token) return;
      const body = {};
      if (sender === 'user') {
        body.question = content;
        body.source = 'Chat - User Question';
      } else {
        body.answer = content;
        body.source = 'Chat - Agent/AI Response';
      }

      try {
        const res = await fetch(`${API}/api/knowledge/push`, {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data.success) {
          log(`Pushed to knowledge base (${content.substring(0, 50)}...)`);
          // Visual feedback - find the button that was clicked
          event.target.classList.add('pushed');
          event.target.title = 'Already pushed to KB';
        } else {
          alert(data.error || 'Failed to push to knowledge base');
        }
      } catch (err) {
        alert('Failed to push to knowledge base: ' + err.message);
      }
    }

    // --- Profile modal ---
    async function openProfileModal() {
      const msgEl = document.getElementById('profile-msg');
      msgEl.style.display = 'none';
      document.getElementById('profile-current-pw').value = '';
      document.getElementById('profile-new-pw').value = '';

      try {
        const res = await fetch(`${API}/api/agents/me`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        if (data.agent) {
          document.getElementById('profile-name').value = data.agent.name || '';
          document.getElementById('profile-email').value = data.agent.email || '';
          document.getElementById('profile-office365').value = data.agent.office365Email || '';
          document.getElementById('profile-teams').value = data.agent.teamsEmail || '';
        }
      } catch (e) {}

      document.getElementById('profile-modal').classList.add('open');
    }

    async function saveProfile() {
      const msgEl = document.getElementById('profile-msg');
      msgEl.style.display = 'none';

      const name = document.getElementById('profile-name').value.trim();
      const office365Email = document.getElementById('profile-office365').value.trim();
      const teamsEmail = document.getElementById('profile-teams').value.trim();
      const currentPw = document.getElementById('profile-current-pw').value;
      const newPw = document.getElementById('profile-new-pw').value;

      if (!name) { alert('Name is required'); return; }

      try {
        // Update profile
        const res = await fetch(`${API}/api/agents/me`, {
          method: 'PUT',
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, office365Email, teamsEmail })
        });
        const data = await res.json();
        if (data.error) { alert(data.error); return; }

        document.getElementById('agent-name').textContent = name;
        agentName = name;

        // Change password if both fields filled
        if (currentPw && newPw) {
          if (newPw.length < 8) { alert('New password must be at least 8 characters'); return; }
          const pwRes = await fetch(`${API}/api/agents/change-password`, {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify({ currentPassword: currentPw, newPassword: newPw })
          });
          const pwData = await pwRes.json();
          if (pwData.error) { alert(pwData.error); return; }
        }

        msgEl.textContent = 'Profile saved successfully!';
        msgEl.style.color = '#00b894';
        msgEl.style.display = 'block';
        log('Profile updated');
        updateO365Status(office365Email);
        setTimeout(() => closeModal('profile-modal'), 1500);
      } catch (err) {
        alert('Save failed: ' + err.message);
      }
    }

    // ========== GLOBAL SEARCH ==========
    let searchTimer = null;
    let searchAbort = null;

    function onSearchInput(val) {
      clearTimeout(searchTimer);
      const dd = document.getElementById('search-dropdown');
      if (val.trim().length < 2) { dd.classList.remove('open'); return; }
      dd.innerHTML = '<div class="search-loading">Searching...</div>';
      dd.classList.add('open');
      searchTimer = setTimeout(() => doSearch(val.trim()), 150);
    }

    function onSearchFocus() {
      const dd = document.getElementById('search-dropdown');
      const val = document.getElementById('global-search').value.trim();
      if (val.length >= 2 && dd.innerHTML && dd.innerHTML !== '<div class="search-loading">Searching...</div>') {
        dd.classList.add('open');
      }
    }

    function onSearchKeydown(e) {
      if (e.key === 'Escape') {
        document.getElementById('search-dropdown').classList.remove('open');
        document.getElementById('global-search').blur();
      }
    }

    // Close search dropdown on outside click
    document.addEventListener('click', (e) => {
      const wrapper = document.querySelector('.search-wrapper');
      if (wrapper && !wrapper.contains(e.target)) {
        document.getElementById('search-dropdown').classList.remove('open');
      }
    });

    async function doSearch(q) {
      if (searchAbort) searchAbort.abort();
      searchAbort = new AbortController();
      try {
        const res = await fetch(API + '/api/search?q=' + encodeURIComponent(q), {
          headers: { 'Authorization': 'Bearer ' + token },
          signal: searchAbort.signal
        });
        if (!res.ok) throw new Error('Search failed');
        const data = await res.json();
        renderSearchResults(data, q);
      } catch (err) {
        if (err.name === 'AbortError') return;
        const dd = document.getElementById('search-dropdown');
        dd.innerHTML = '<div class="search-empty">Search failed</div>';
      }
    }

    function highlightMatch(text, query) {
      if (!text) return '';
      const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      return text.replace(new RegExp('(' + escaped + ')', 'gi'), '<mark>$1</mark>');
    }

    function truncateAround(text, query, maxLen) {
      if (!text || text.length <= maxLen) return text || '';
      const idx = text.toLowerCase().indexOf(query.toLowerCase());
      if (idx === -1) return text.substring(0, maxLen) + '...';
      const start = Math.max(0, idx - 40);
      const end = Math.min(text.length, idx + query.length + 60);
      return (start > 0 ? '...' : '') + text.substring(start, end) + (end < text.length ? '...' : '');
    }

    function renderSearchResults(data, q) {
      const dd = document.getElementById('search-dropdown');
      const { chats, messages, agents, teams } = data;
      const total = (chats?.length || 0) + (messages?.length || 0) + (agents?.length || 0) + (teams?.length || 0);

      if (total === 0) {
        dd.innerHTML = '<div class="search-empty">No results found</div>';
        dd.classList.add('open');
        return;
      }

      let html = '';

      // Chats
      if (chats && chats.length > 0) {
        html += '<div class="search-group-label">Chats (' + chats.length + ')</div>';
        chats.forEach(c => {
          const name = highlightMatch(c.userName || 'Unknown', q);
          const sub = c.summary ? highlightMatch(truncateAround(c.summary, q, 80), q) : (c.userEmail || '');
          html += '<div class="search-result" onclick="jumpToChat(\'' + c.sessionId + '\')">'
            + '<span class="sr-icon">💬</span>'
            + '<div class="sr-body"><div class="sr-title">' + name + '</div><div class="sr-sub">' + sub + '</div></div>'
            + '<span style="font-size:10px;color:#8c9bab;">' + (c.status || '') + '</span>'
            + '</div>';
        });
      }

      // Messages
      if (messages && messages.length > 0) {
        html += '<div class="search-group-label">Messages (' + messages.length + ')</div>';
        messages.forEach(m => {
          const snippet = highlightMatch(truncateAround(m.content, q, 100), q);
          const who = m.sender === 'user' ? (m.chatUserName || 'User') : (m.senderName || m.sender);
          html += '<div class="search-result" onclick="jumpToChat(\'' + (m.chatSessionId || '') + '\')">'
            + '<span class="sr-icon">📝</span>'
            + '<div class="sr-body"><div class="sr-title">' + snippet + '</div><div class="sr-sub">' + who + ' &middot; ' + new Date(m.sentAt).toLocaleDateString() + '</div></div>'
            + '</div>';
        });
      }

      // Agents
      if (agents && agents.length > 0) {
        html += '<div class="search-group-label">Agents (' + agents.length + ')</div>';
        agents.forEach(a => {
          const name = highlightMatch(a.name, q);
          const email = highlightMatch(a.email, q);
          const rolesBadge = (a.roles || []).map(r => '<span class="team-tag">' + r + '</span>').join('');
          html += '<div class="search-result" onclick="searchGoToUsers()">'
            + '<span class="sr-icon">👤</span>'
            + '<div class="sr-body"><div class="sr-title">' + name + ' <span class="role-badge ' + (a.systemRole || 'agent') + '">' + (a.systemRole || 'agent') + '</span></div><div class="sr-sub">' + email + ' ' + rolesBadge + '</div></div>'
            + '</div>';
        });
      }

      // Teams
      if (teams && teams.length > 0) {
        html += '<div class="search-group-label">Teams (' + teams.length + ')</div>';
        teams.forEach(t => {
          const name = highlightMatch(t.name, q);
          html += '<div class="search-result" onclick="searchGoToUsers()">'
            + '<span class="sr-icon">' + (t.icon || '👥') + '</span>'
            + '<div class="sr-body"><div class="sr-title">' + name + '</div><div class="sr-sub">' + (t.description || 'Team') + '</div></div>'
            + '</div>';
        });
      }

      dd.innerHTML = html;
      dd.classList.add('open');
    }

    function jumpToChat(sessionId) {
      document.getElementById('search-dropdown').classList.remove('open');
      document.getElementById('global-search').value = '';
      if (!sessionId) return;
      // Switch to chats tab
      switchTab('chats');
      // Find and select the chat
      const chatItem = chatList.find(c => c.sessionId === sessionId);
      if (chatItem) {
        selectChat(chatItem.sessionId, chatItem._id, chatItem.mode, chatItem.userName, chatItem.userEmail);
      }
    }

    function searchGoToUsers() {
      document.getElementById('search-dropdown').classList.remove('open');
      document.getElementById('global-search').value = '';
      switchTab('users');
    }

    // Poll for new chats
    setInterval(() => { if (token) loadChats(); }, 5000);
  </script>
</body>
</html>
