<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIChatDesk - Agent Dashboard Test</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #e0e0e0; }
    .header { background: #16213e; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2a2a4a; }
    .header h1 { font-size: 18px; color: #6C5CE7; }
    .header .agent-info { display: flex; gap: 15px; align-items: center; font-size: 13px; }
    .header .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .header .status-dot.online { background: #00b894; }
    .header .status-dot.offline { background: #e74c3c; }
    .main { display: grid; grid-template-columns: 300px 1fr 300px; height: calc(100vh - 52px); }
    .sidebar { background: #16213e; border-right: 1px solid #2a2a4a; overflow-y: auto; }
    .sidebar h2 { padding: 15px 20px; font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
    .chat-item { padding: 12px 20px; border-bottom: 1px solid #2a2a4a; cursor: pointer; transition: background 0.2s; }
    .chat-item:hover { background: #2a2a4a; }
    .chat-item.active { background: #2a2a4a; border-left: 3px solid #6C5CE7; }
    .chat-item .name { font-weight: 600; font-size: 14px; margin-bottom: 3px; }
    .chat-item .preview { font-size: 12px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-item .meta { display: flex; justify-content: space-between; margin-top: 5px; font-size: 11px; color: #666; }
    .priority-badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
    .priority-badge.high { background: #e74c3c33; color: #e74c3c; }
    .priority-badge.medium { background: #f39c1233; color: #f39c12; }
    .priority-badge.low { background: #00b89433; color: #00b894; }
    .mode-badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 10px; }
    .mode-badge.ai { background: #6C5CE733; color: #6C5CE7; }
    .mode-badge.human { background: #00b89433; color: #00b894; }
    .center { display: flex; flex-direction: column; }
    .chat-header { padding: 15px 20px; background: #16213e; border-bottom: 1px solid #2a2a4a; display: flex; justify-content: space-between; align-items: center; }
    .chat-header .user-name { font-weight: 600; font-size: 16px; }
    .chat-header .actions { display: flex; gap: 8px; }
    .btn { padding: 6px 14px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: 600; }
    .btn-takeover { background: #e74c3c; color: white; }
    .btn-takeover:hover { background: #c0392b; }
    .btn-return { background: #00b894; color: white; }
    .btn-return:hover { background: #00a381; }
    .btn-suggest { background: #6C5CE7; color: white; }
    .btn-suggest:hover { background: #5a4bd1; }
    .btn-transfer { background: #f39c12; color: white; }
    .btn-transfer:hover { background: #e08e0b; }
    .messages { flex: 1; padding: 20px; overflow-y: auto; }
    .message { margin-bottom: 12px; max-width: 70%; }
    .message.user { margin-left: auto; }
    .message .bubble { padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.5; }
    .message.user .bubble { background: #6C5CE7; color: white; border-bottom-right-radius: 4px; }
    .message.ai .bubble { background: #2a2a4a; color: #e0e0e0; border-bottom-left-radius: 4px; }
    .message.agent .bubble { background: #00b894; color: white; border-bottom-left-radius: 4px; }
    .message.system .bubble { background: transparent; color: #888; text-align: center; font-size: 12px; font-style: italic; max-width: 100%; }
    .message .sender { font-size: 11px; color: #888; margin-bottom: 3px; }
    .message .time { font-size: 10px; color: #666; margin-top: 3px; }
    .agent-input { padding: 15px 20px; background: #16213e; border-top: 1px solid #2a2a4a; display: flex; gap: 10px; }
    .agent-input input { flex: 1; background: #2a2a4a; border: 1px solid #3a3a5a; color: #e0e0e0; padding: 10px 14px; border-radius: 8px; font-size: 14px; }
    .agent-input input:focus { outline: none; border-color: #6C5CE7; }
    .agent-input button { background: #6C5CE7; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .right-panel { background: #16213e; border-left: 1px solid #2a2a4a; overflow-y: auto; padding: 20px; }
    .right-panel h3 { font-size: 13px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
    .info-row { display: flex; justify-content: space-between; font-size: 13px; padding: 6px 0; border-bottom: 1px solid #2a2a4a; }
    .info-row .label { color: #888; }
    .info-row .value { color: #e0e0e0; }
    .section { margin-bottom: 25px; }
    .note-input { width: 100%; background: #2a2a4a; border: 1px solid #3a3a5a; color: #e0e0e0; padding: 8px 12px; border-radius: 6px; font-size: 13px; resize: vertical; min-height: 60px; margin-top: 8px; }
    .note-btn { margin-top: 8px; background: #3a3a5a; color: #e0e0e0; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .canned-list { margin-top: 8px; }
    .canned-item { padding: 6px 10px; background: #2a2a4a; border-radius: 4px; margin-bottom: 4px; cursor: pointer; font-size: 12px; }
    .canned-item:hover { background: #3a3a5a; }
    .connection-bar { padding: 8px 30px; font-size: 12px; display: flex; gap: 20px; background: #0f0f23; }
    .connection-bar span { color: #888; }
    .connection-bar .connected { color: #00b894; }
    .connection-bar .disconnected { color: #e74c3c; }
    .empty-state { display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 14px; flex-direction: column; gap: 10px; }
    .log-panel { background: #0f0f23; padding: 15px; margin-top: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 11px; max-height: 150px; overflow-y: auto; color: #0f0; }
  </style>
</head>
<body>
  <div class="header">
    <h1>AIChatDesk Agent Dashboard</h1>
    <div class="agent-info">
      <span><span class="status-dot" id="agent-dot"></span> <span id="agent-name">Agent</span></span>
      <span style="color: #666;">|</span>
      <span>Server: <span id="server-status">Checking...</span></span>
      <span style="color: #666;">|</span>
      <span>WS: <span id="ws-status">Disconnected</span></span>
    </div>
  </div>

  <div class="connection-bar">
    <span>API: <span id="api-url">http://localhost:8001</span></span>
    <span>Active Chats: <span id="chat-count">0</span></span>
    <span>Queue: <span id="queue-count">0</span></span>
  </div>

  <div class="main">
    <!-- Left: Chat List -->
    <div class="sidebar">
      <h2>Active Chats</h2>
      <div id="chat-list">
        <!-- Populated dynamically -->
      </div>
    </div>

    <!-- Center: Chat View -->
    <div class="center">
      <div id="chat-view-empty" class="empty-state">
        <div style="font-size: 40px; opacity: 0.3;">ðŸ’¬</div>
        <div>Select a chat from the sidebar</div>
        <div style="font-size: 12px; color: #555;">Or wait for new incoming chats</div>
      </div>
      <div id="chat-view" style="display:none; flex-direction: column; height: 100%;">
        <div class="chat-header">
          <div>
            <span class="user-name" id="chat-user-name">User</span>
            <span class="mode-badge ai" id="chat-mode-badge">AI</span>
          </div>
          <div class="actions">
            <button class="btn btn-takeover" id="btn-takeover" onclick="takeover()">Take Over</button>
            <button class="btn btn-return" id="btn-return" onclick="returnToAI()" style="display:none;">Return to AI</button>
            <button class="btn btn-suggest" onclick="suggestReply()">Suggest Reply</button>
            <button class="btn btn-transfer" onclick="transferChat()">Transfer</button>
          </div>
        </div>
        <div class="messages" id="messages"></div>
        <div class="agent-input">
          <input type="text" id="agent-message" placeholder="Type a message as agent..." onkeypress="if(event.key==='Enter') sendAgentMessage()">
          <button onclick="sendAgentMessage()">Send</button>
        </div>
      </div>
    </div>

    <!-- Right: Info Panel -->
    <div class="right-panel">
      <div class="section">
        <h3>User Information</h3>
        <div class="info-row"><span class="label">Name</span><span class="value" id="info-name">â€”</span></div>
        <div class="info-row"><span class="label">Email</span><span class="value" id="info-email">â€”</span></div>
        <div class="info-row"><span class="label">Page</span><span class="value" id="info-page">â€”</span></div>
        <div class="info-row"><span class="label">Browser</span><span class="value" id="info-browser">â€”</span></div>
        <div class="info-row"><span class="label">OS</span><span class="value" id="info-os">â€”</span></div>
        <div class="info-row"><span class="label">Location</span><span class="value" id="info-location">â€”</span></div>
        <div class="info-row"><span class="label">Category</span><span class="value" id="info-category">â€”</span></div>
        <div class="info-row"><span class="label">Sentiment</span><span class="value" id="info-sentiment">â€”</span></div>
        <div class="info-row"><span class="label">Priority</span><span class="value" id="info-priority">â€”</span></div>
        <div class="info-row"><span class="label">Wait Time</span><span class="value" id="info-wait">â€”</span></div>
      </div>

      <div class="section">
        <h3>Internal Notes</h3>
        <textarea class="note-input" id="note-input" placeholder="Add a note (invisible to user)..."></textarea>
        <button class="note-btn" onclick="addNote()">Add Note</button>
      </div>

      <div class="section">
        <h3>Canned Responses</h3>
        <div class="canned-list">
          <div class="canned-item" onclick="useCanned('Thank you for contacting us! Let me help you with that.')">Thanks + help</div>
          <div class="canned-item" onclick="useCanned('I\'m looking into this for you. One moment please.')">Looking into it</div>
          <div class="canned-item" onclick="useCanned('Could you provide more details about the issue?')">Need more details</div>
          <div class="canned-item" onclick="useCanned('This has been resolved. Is there anything else I can help with?')">Issue resolved</div>
          <div class="canned-item" onclick="useCanned('Let me transfer you to a specialist who can better assist you.')">Transfer notice</div>
        </div>
      </div>

      <div class="section">
        <h3>Event Log</h3>
        <div class="log-panel" id="log"></div>
      </div>
    </div>
  </div>

  <script>
    const API = 'http://localhost:8001';
    let token = null;
    let selectedChat = null;
    let ws = null;

    function log(msg) {
      const el = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      el.innerHTML += `[${time}] ${msg}\n`;
      el.scrollTop = el.scrollHeight;
    }

    // Login
    async function login() {
      try {
        const res = await fetch(`${API}/api/agents/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: prompt('Agent email:', 'admin@myapp.com'),
            password: prompt('Password:', 'changeme123')
          })
        });
        const data = await res.json();
        if (data.token) {
          token = data.token;
          document.getElementById('agent-name').textContent = data.agent?.name || 'Agent';
          document.getElementById('agent-dot').classList.add('online');
          document.getElementById('server-status').textContent = 'Connected';
          document.getElementById('server-status').className = 'connected';
          log('Logged in successfully');
          loadChats();
          connectWS();
        } else {
          log(`Login failed: ${data.error || 'Unknown error'}`);
          document.getElementById('server-status').textContent = 'Auth Failed';
          document.getElementById('server-status').className = 'disconnected';
        }
      } catch (err) {
        log(`Login error: ${err.message}`);
        document.getElementById('server-status').textContent = 'Offline';
        document.getElementById('server-status').className = 'disconnected';
      }
    }

    // Load active chats
    async function loadChats() {
      try {
        const res = await fetch(`${API}/api/chat?status=active`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const chats = await res.json();
        renderChatList(Array.isArray(chats) ? chats : chats.chats || []);
      } catch (err) {
        log(`Failed to load chats: ${err.message}`);
      }
    }

    function renderChatList(chats) {
      const el = document.getElementById('chat-list');
      document.getElementById('chat-count').textContent = chats.length;

      if (chats.length === 0) {
        el.innerHTML = '<div style="padding: 20px; color: #666; text-align: center; font-size: 13px;">No active chats.<br>Open the <a href="index.html" style="color: #6C5CE7;">customer test page</a> and start a chat.</div>';
        return;
      }

      el.innerHTML = chats.map(chat => {
        const priority = chat.priority || 'medium';
        const mode = chat.mode || 'ai';
        const waitMins = Math.round((Date.now() - new Date(chat.startedAt).getTime()) / 60000);
        return `
          <div class="chat-item ${selectedChat?.sessionId === chat.sessionId ? 'active' : ''}" onclick="selectChat('${chat.sessionId}')">
            <div class="name">${chat.userName || 'Anonymous'}</div>
            <div class="preview">${chat.summary || 'New conversation'}</div>
            <div class="meta">
              <span class="priority-badge ${priority}">${priority}</span>
              <span class="mode-badge ${mode}">${mode.toUpperCase()}</span>
              <span>${waitMins}m</span>
            </div>
          </div>
        `;
      }).join('');
    }

    async function selectChat(sessionId) {
      selectedChat = { sessionId };
      document.getElementById('chat-view-empty').style.display = 'none';
      document.getElementById('chat-view').style.display = 'flex';
      log(`Selected chat: ${sessionId}`);

      try {
        // Load messages
        const msgRes = await fetch(`${API}/api/chat/${sessionId}/messages`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const messages = await msgRes.json();
        renderMessages(Array.isArray(messages) ? messages : messages.messages || []);

        // Load chat details
        const chatRes = await fetch(`${API}/api/chat/${sessionId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const chat = await chatRes.json();
        updateChatInfo(chat);
      } catch (err) {
        log(`Failed to load chat: ${err.message}`);
      }
    }

    function renderMessages(messages) {
      const el = document.getElementById('messages');
      el.innerHTML = messages.map(msg => {
        const sender = msg.sender || 'user';
        const time = new Date(msg.sentAt || msg.createdAt).toLocaleTimeString();
        const senderLabel = sender === 'user' ? msg.senderName || 'User' : sender === 'ai' ? 'AI' : msg.senderName || 'Agent';
        if (msg.isInternal) {
          return `<div class="message system"><div class="bubble">[Internal Note] ${msg.content}</div></div>`;
        }
        return `
          <div class="message ${sender}">
            <div class="sender">${senderLabel}</div>
            <div class="bubble">${msg.content}</div>
            <div class="time">${time}</div>
          </div>
        `;
      }).join('');
      el.scrollTop = el.scrollHeight;
    }

    function updateChatInfo(chat) {
      document.getElementById('chat-user-name').textContent = chat.userName || 'Anonymous';
      const modeBadge = document.getElementById('chat-mode-badge');
      modeBadge.textContent = (chat.mode || 'ai').toUpperCase();
      modeBadge.className = `mode-badge ${chat.mode || 'ai'}`;
      document.getElementById('btn-takeover').style.display = chat.mode === 'ai' ? '' : 'none';
      document.getElementById('btn-return').style.display = chat.mode === 'human' ? '' : 'none';

      document.getElementById('info-name').textContent = chat.userName || 'â€”';
      document.getElementById('info-email').textContent = chat.userEmail || 'â€”';
      document.getElementById('info-page').textContent = chat.userPage || 'â€”';
      document.getElementById('info-browser').textContent = chat.userBrowser || 'â€”';
      document.getElementById('info-os').textContent = chat.userOS || 'â€”';
      document.getElementById('info-location').textContent = chat.userLocation || 'â€”';
      document.getElementById('info-category').textContent = chat.category || 'â€”';
      document.getElementById('info-sentiment').textContent = chat.sentiment || 'â€”';
      document.getElementById('info-priority').textContent = chat.priority || 'â€”';
      const waitMins = Math.round((Date.now() - new Date(chat.startedAt).getTime()) / 60000);
      document.getElementById('info-wait').textContent = `${waitMins} min`;

      selectedChat = chat;
    }

    // Agent actions
    async function takeover() {
      if (!selectedChat) return;
      try {
        const res = await fetch(`${API}/api/chat/${selectedChat.sessionId || selectedChat._id}/takeover`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        log(`Took over chat: ${JSON.stringify(data).substring(0, 80)}`);
        selectChat(selectedChat.sessionId || selectedChat._id);
        loadChats();
      } catch (err) { log(`Takeover error: ${err.message}`); }
    }

    async function returnToAI() {
      if (!selectedChat) return;
      try {
        const res = await fetch(`${API}/api/chat/${selectedChat.sessionId || selectedChat._id}/return-to-ai`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
        });
        log('Returned chat to AI');
        selectChat(selectedChat.sessionId || selectedChat._id);
        loadChats();
      } catch (err) { log(`Return error: ${err.message}`); }
    }

    async function suggestReply() {
      if (!selectedChat) return;
      log('Requesting AI suggestion...');
      try {
        const res = await fetch(`${API}/api/ai/suggest-reply`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ chatId: selectedChat._id || selectedChat.sessionId })
        });
        const data = await res.json();
        document.getElementById('agent-message').value = data.suggestion || data.reply || '';
        log('AI suggestion loaded into input');
      } catch (err) { log(`Suggest error: ${err.message}`); }
    }

    async function transferChat() {
      if (!selectedChat) return;
      const agentId = prompt('Enter target agent ID to transfer:');
      if (!agentId) return;
      try {
        const res = await fetch(`${API}/api/chat/${selectedChat.sessionId || selectedChat._id}/transfer`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ targetAgentId: agentId })
        });
        log('Chat transferred');
        loadChats();
      } catch (err) { log(`Transfer error: ${err.message}`); }
    }

    async function sendAgentMessage() {
      const input = document.getElementById('agent-message');
      const content = input.value.trim();
      if (!content || !selectedChat) return;
      try {
        await fetch(`${API}/api/chat/${selectedChat.sessionId || selectedChat._id}/message`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ content, sender: 'agent' })
        });
        input.value = '';
        selectChat(selectedChat.sessionId || selectedChat._id);
      } catch (err) { log(`Send error: ${err.message}`); }
    }

    async function addNote() {
      const input = document.getElementById('note-input');
      const content = input.value.trim();
      if (!content || !selectedChat) return;
      try {
        await fetch(`${API}/api/chat/${selectedChat.sessionId || selectedChat._id}/message`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ content, sender: 'agent', isInternal: true })
        });
        input.value = '';
        selectChat(selectedChat.sessionId || selectedChat._id);
        log('Internal note added');
      } catch (err) { log(`Note error: ${err.message}`); }
    }

    function useCanned(text) {
      document.getElementById('agent-message').value = text;
    }

    // WebSocket
    function connectWS() {
      try {
        ws = new WebSocket('ws://localhost:8001/ws');
        ws.onopen = () => {
          document.getElementById('ws-status').textContent = 'Connected';
          document.getElementById('ws-status').className = 'connected';
          log('WebSocket connected');
          // Authenticate WS
          ws.send(JSON.stringify({ type: 'auth', token }));
        };
        ws.onmessage = (e) => {
          const data = JSON.parse(e.data);
          log(`WS: ${data.type}`);
          if (['chat.created', 'chat.updated', 'chat.closed', 'agent.takeover', 'agent.return'].includes(data.type)) {
            loadChats();
            if (selectedChat && (data.sessionId === selectedChat.sessionId || data.chatId === selectedChat._id)) {
              selectChat(selectedChat.sessionId || selectedChat._id);
            }
          }
        };
        ws.onclose = () => {
          document.getElementById('ws-status').textContent = 'Disconnected';
          document.getElementById('ws-status').className = 'disconnected';
          setTimeout(connectWS, 3000);
        };
      } catch (err) {
        log(`WS error: ${err.message}`);
      }
    }

    // Init - auto login
    log('Dashboard loaded. Attempting login...');
    login();
    setInterval(loadChats, 10000);
  </script>
</body>
</html>
