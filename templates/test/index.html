<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIChatDesk - Customer Test Page</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; }
    .header { background: linear-gradient(135deg, #6C5CE7, #a29bfe); color: white; padding: 20px 40px; }
    .header h1 { font-size: 24px; margin-bottom: 5px; }
    .header p { opacity: 0.9; font-size: 14px; }
    .content { max-width: 900px; margin: 40px auto; padding: 0 20px; }
    .card { background: white; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .card h2 { font-size: 18px; margin-bottom: 15px; color: #6C5CE7; }
    .card p { line-height: 1.6; color: #666; margin-bottom: 10px; }
    .status-bar { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
    .status-item { background: #f0f0f0; padding: 10px 16px; border-radius: 8px; font-size: 13px; }
    .status-item span { font-weight: 600; color: #6C5CE7; }
    footer { text-align: center; padding: 30px; color: #999; font-size: 13px; }

    /* Chat Widget */
    #chat-bubble {
      position: fixed; bottom: 24px; right: 24px; width: 60px; height: 60px;
      background: #6C5CE7; border-radius: 50%; cursor: pointer; z-index: 9999;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 16px rgba(108,92,231,0.4); transition: transform 0.2s;
    }
    #chat-bubble:hover { transform: scale(1.1); }
    #chat-bubble svg { width: 28px; height: 28px; fill: white; }

    #chat-window {
      position: fixed; bottom: 96px; right: 24px; width: 380px; height: 700px;
      background: white; border-radius: 16px; z-index: 9999;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15); display: none; flex-direction: column;
      overflow: hidden;
    }
    #chat-window.open { display: flex; }

    .chat-header {
      background: linear-gradient(135deg, #6C5CE7, #a29bfe); color: white;
      padding: 14px 20px; display: flex; justify-content: space-between; align-items: center;
    }
    .chat-header h3 { font-size: 15px; font-weight: 600; }
    .chat-header .mode-badge { font-size: 11px; padding: 3px 8px; border-radius: 10px; background: rgba(255,255,255,0.2); }
    .header-actions { display: flex; align-items: center; gap: 2px; }
    .header-icon-btn {
      width: 30px; height: 30px; background: none; border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center; border-radius: 50%;
      transition: background 0.2s; position: relative;
    }
    .header-icon-btn:hover { background: rgba(255,255,255,0.2); }
    .header-icon-btn svg { width: 16px; height: 16px; fill: rgba(255,255,255,0.85); }
    .header-icon-btn:hover svg { fill: white; }
    .header-icon-btn::after {
      content: attr(data-tooltip);
      position: absolute; bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%);
      background: #1e1919; color: #fff; font-size: 11px; padding: 4px 8px; border-radius: 4px;
      white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.15s;
      z-index: 100;
    }
    .header-icon-btn::before {
      content: ''; position: absolute; bottom: calc(100% + 2px); left: 50%; transform: translateX(-50%);
      border: 4px solid transparent; border-top-color: #1e1919;
      pointer-events: none; opacity: 0; transition: opacity 0.15s; z-index: 100;
    }
    .header-icon-btn:hover::after, .header-icon-btn:hover::before { opacity: 1; }
    .chat-header .close-btn {
      background: none; border: none; color: white; font-size: 20px; cursor: pointer;
      width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
      border-radius: 50%; transition: background 0.2s; margin-left: 2px;
    }
    .chat-header .close-btn:hover { background: rgba(255,255,255,0.2); }

    #prechat-form {
      flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 30px; gap: 16px;
    }
    #prechat-form h4 { font-size: 16px; color: #333; text-align: center; margin-bottom: 8px; }
    #prechat-form input {
      width: 100%; padding: 12px 14px; border: 1px solid #ddd; border-radius: 8px;
      font-size: 14px; outline: none; transition: border 0.2s;
    }
    #prechat-form input:focus { border-color: #6C5CE7; }
    #prechat-form button.start-btn {
      background: #6C5CE7; color: white; border: none; padding: 12px;
      border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 600;
    }
    #prechat-form button.start-btn:hover { background: #5a4bd1; }

    /* Calendar popup */
    #calendar-popup {
      display: none; position: absolute; top: 50px; right: 8px; width: 310px;
      background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 16px; z-index: 10000; max-height: 420px; overflow-y: auto;
    }
    #calendar-popup.open { display: block; }
    .cal-title { font-size: 14px; font-weight: 600; color: #333; margin-bottom: 12px; text-align: center; }
    .cal-subtitle { font-size: 11px; color: #888; text-align: center; margin-bottom: 12px; }
    .cal-types { display: flex; gap: 8px; margin-bottom: 16px; }
    .cal-type-btn {
      flex: 1; padding: 10px 6px; border: 2px solid #eee; border-radius: 10px;
      background: white; cursor: pointer; text-align: center; transition: all 0.2s; font-size: 12px;
    }
    .cal-type-btn:hover { border-color: #a29bfe; }
    .cal-type-btn.selected { border-color: #6C5CE7; background: #f3f0ff; }
    .cal-type-btn .cal-icon { font-size: 22px; display: block; margin-bottom: 4px; }
    .cal-date-tabs { display: flex; gap: 6px; margin-bottom: 12px; }
    .cal-date-tab {
      flex: 1; padding: 8px 4px; border: 1px solid #eee; border-radius: 8px;
      background: white; cursor: pointer; text-align: center; font-size: 11px; transition: all 0.15s;
    }
    .cal-date-tab:hover { border-color: #a29bfe; }
    .cal-date-tab.active { border-color: #6C5CE7; background: #f3f0ff; color: #6C5CE7; font-weight: 600; }
    .cal-slots { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
    .cal-slot {
      padding: 6px 10px; border: 1px solid #eee; border-radius: 6px; background: white;
      cursor: pointer; font-size: 12px; transition: all 0.15s;
    }
    .cal-slot:hover { border-color: #a29bfe; background: #f9f8ff; }
    .cal-slot.selected { border-color: #6C5CE7; background: #6C5CE7; color: white; }
    .cal-loading { text-align: center; padding: 20px; color: #888; font-size: 13px; }
    .cal-confirm {
      background: #6C5CE7; color: white; border: none; width: 100%; padding: 10px;
      border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s;
    }
    .cal-confirm:hover { background: #5a4bd1; }
    .cal-confirm:disabled { background: #ccc; cursor: not-allowed; }
    .cal-summary { background: #f9f8ff; border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 12px; color: #555; }
    .cal-summary strong { color: #333; }
    .cal-success { text-align: center; padding: 10px 0; }
    .cal-success .cal-check { font-size: 36px; margin-bottom: 8px; }
    .cal-success p { font-size: 13px; color: #555; margin-bottom: 6px; }
    .cal-success a { color: #6C5CE7; font-weight: 600; font-size: 13px; }
    .cal-back-btn { background: none; border: none; color: #6C5CE7; font-size: 12px; cursor: pointer; margin-bottom: 8px; padding: 0; }
    .cal-back-btn:hover { text-decoration: underline; }
    .cal-no-slots { text-align: center; padding: 16px; color: #999; font-size: 12px; }

    /* Header dropdown popups (ticket type, priority, mood) */
    .header-popup {
      display: none; position: absolute; top: 50px; right: 8px; width: 200px;
      background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 8px; z-index: 10000;
    }
    .header-popup.open { display: block; }
    .header-popup .popup-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; padding: 4px 8px; }
    .header-popup .popup-item {
      display: flex; align-items: center; gap: 8px; padding: 8px 10px;
      border-radius: 6px; cursor: pointer; font-size: 13px; color: #333; transition: background 0.15s;
    }
    .header-popup .popup-item:hover { background: #f0f0f0; }
    .header-popup .popup-item.selected { background: #f3f0ff; color: #6C5CE7; font-weight: 600; }
    .header-popup .popup-item .pip {
      width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
    }

    #chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: none; flex-direction: column; gap: 10px; }
    #chat-messages.active { display: flex; }

    .msg { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.5; word-wrap: break-word; }
    .msg.user { align-self: flex-end; background: #6C5CE7; color: white; border-bottom-right-radius: 4px; }
    .msg.ai, .msg.agent { align-self: flex-start; background: #f0f0f0; color: #333; border-bottom-left-radius: 4px; }
    .msg.system { align-self: center; background: #e8f4fd; color: #1a73e8; font-size: 12px; padding: 6px 12px; border-radius: 20px; }
    .msg .sender-label { font-size: 10px; opacity: 0.7; margin-bottom: 2px; display: block; }
    .msg .confidence { font-size: 10px; opacity: 0.6; margin-top: 4px; display: block; }
    .msg img.attachment { max-width: 100%; border-radius: 8px; margin-top: 6px; cursor: pointer; }
    .msg .file-attachment {
      display: flex; align-items: center; gap: 6px; margin-top: 6px; padding: 6px 10px;
      background: rgba(0,0,0,0.06); border-radius: 6px; font-size: 12px; text-decoration: none; color: inherit;
    }
    .msg.user .file-attachment { background: rgba(255,255,255,0.2); }

    .typing-indicator { align-self: flex-start; padding: 10px 14px; background: #f0f0f0; border-radius: 12px; display: none; }
    .typing-indicator.show { display: flex; gap: 4px; align-items: center; }
    .typing-indicator span { width: 6px; height: 6px; background: #999; border-radius: 50%; animation: typingBounce 1.4s infinite ease-in-out; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }

    /* Attachment preview bar */
    #attachment-preview {
      display: none; padding: 8px 16px; border-top: 1px solid #eee; background: #fafafa;
      gap: 8px; align-items: center; flex-wrap: wrap;
    }
    #attachment-preview.active { display: flex; }
    .preview-item {
      position: relative; width: 48px; height: 48px; border-radius: 6px; overflow: hidden;
      border: 1px solid #ddd; flex-shrink: 0;
    }
    .preview-item img { width: 100%; height: 100%; object-fit: cover; }
    .preview-item .file-icon {
      width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
      background: #f0f0f0; font-size: 10px; color: #666; text-align: center; padding: 2px;
    }
    .preview-item .remove-btn {
      position: absolute; top: -4px; right: -4px; width: 16px; height: 16px;
      background: #e74c3c; color: white; border: none; border-radius: 50%;
      font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;
      line-height: 1;
    }

    /* Input area */
    #chat-input-area { padding: 10px 12px; border-top: 1px solid #eee; display: none; gap: 8px; align-items: center; }
    #chat-input-area.active { display: flex; }
    .input-icon-btn {
      width: 24px; height: 24px; background: none; border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center; border-radius: 50%;
      transition: background 0.2s; flex-shrink: 0;
    }
    .input-icon-btn:hover { background: #f0f0f0; }
    .input-icon-btn svg { width: 14px; height: 14px; fill: #888; }
    .input-icon-btn:hover svg { fill: #6C5CE7; }
    #chat-input {
      flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 20px;
      font-size: 14px; outline: none; font-family: inherit; min-width: 0;
    }
    #chat-input:focus { border-color: #6C5CE7; }
    #send-btn {
      width: 32px; height: 32px; background: #6C5CE7; border: none; border-radius: 50%;
      cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    #send-btn:hover { background: #5a4bd1; }
    #send-btn svg { width: 14px; height: 14px; fill: white; }

    /* Emoji picker */
    #emoji-picker {
      display: none; position: absolute; top: 50px; right: 8px; width: 280px;
      background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 10px; z-index: 10000; max-height: 280px; overflow-y: auto;
    }
    #emoji-picker.open { display: block; }
    .emoji-category { margin-bottom: 8px; }
    .emoji-category-label { font-size: 10px; color: #999; text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.5px; }
    .emoji-grid { display: flex; flex-wrap: wrap; gap: 2px; }
    .emoji-grid span {
      width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; border-radius: 6px; font-size: 18px; transition: background 0.15s;
    }
    .emoji-grid span:hover { background: #f0f0f0; }

    /* Quick actions popup */
    #quick-actions {
      display: none; position: absolute; top: 50px; right: 8px; width: 200px;
      background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 6px; z-index: 10000;
    }
    #quick-actions.open { display: block; }
    .qa-item {
      display: flex; align-items: center; gap: 10px; padding: 10px 12px;
      border-radius: 8px; cursor: pointer; font-size: 13px; color: #333; transition: background 0.15s;
    }
    .qa-item:hover { background: #f0f0f0; }
    .qa-item svg { width: 18px; height: 18px; fill: #6C5CE7; flex-shrink: 0; }

    /* Formatted AI/agent messages */
    .ai-content p { margin: 0 0 4px; line-height: 1.5; }
    .ai-content p:last-child { margin-bottom: 0; }
    .ai-content ul, .ai-content ol { margin: 2px 0 4px 16px; padding: 0; }
    .ai-content li { margin-bottom: 1px; line-height: 1.4; }
    .ai-content li:last-child { margin-bottom: 0; }
    .ai-content strong { font-weight: 700; }
    .ai-content em { font-style: italic; }
    .ai-content code { background: rgba(0,0,0,0.07); padding: 1px 5px; border-radius: 3px; font-size: 12px; font-family: monospace; }
    .ai-content pre { background: rgba(0,0,0,0.07); padding: 8px 10px; border-radius: 6px; margin: 4px 0; overflow-x: auto; font-size: 12px; }
    .ai-content pre code { background: none; padding: 0; }
    .ai-content h1, .ai-content h2, .ai-content h3 { font-size: 13px; font-weight: 700; margin: 6px 0 2px; }
    .ai-content h1:first-child, .ai-content h2:first-child, .ai-content h3:first-child { margin-top: 0; }
    .ai-content blockquote { border-left: 3px solid #6C5CE7; padding-left: 10px; margin: 4px 0; opacity: 0.85; }
    .ai-content br { display: none; }

    /* Screenshot annotation overlay */
    #annotation-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85); z-index: 20000; flex-direction: column; align-items: center; justify-content: center;
    }
    #annotation-overlay.open { display: flex; }
    #annotation-overlay .anno-toolbar {
      display: flex; gap: 8px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; justify-content: center;
    }
    #annotation-overlay .anno-toolbar button {
      padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600;
    }
    #annotation-overlay .anno-toolbar .anno-tool-btn {
      width: 34px; height: 34px; padding: 0; background: #444; color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px;
    }
    #annotation-overlay .anno-toolbar .anno-tool-btn:hover { background: #666; }
    #annotation-overlay .anno-toolbar .anno-tool-btn.active { background: #6C5CE7; }
    #annotation-overlay .anno-toolbar .anno-tool-btn svg { width: 18px; height: 18px; fill: white; }
    #annotation-overlay .anno-toolbar .anno-color-dot {
      width: 22px; height: 22px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; padding: 0; background: none;
    }
    #annotation-overlay .anno-toolbar .anno-color-dot.active { border-color: white; }
    #annotation-overlay .anno-toolbar .anno-color-inner {
      width: 100%; height: 100%; border-radius: 50%; display: block;
    }
    #annotation-overlay .anno-toolbar .anno-separator {
      width: 1px; height: 24px; background: #555; margin: 0 4px;
    }
    #annotation-overlay .anno-toolbar .anno-done { background: #6C5CE7; color: white; }
    #annotation-overlay .anno-toolbar .anno-done:hover { background: #5a4bd1; }
    #annotation-overlay .anno-toolbar .anno-cancel { background: #555; color: white; }
    #annotation-overlay .anno-toolbar .anno-cancel:hover { background: #666; }
    #annotation-overlay .anno-toolbar .anno-clear { background: #e74c3c; color: white; }
    #annotation-overlay .anno-toolbar .anno-clear:hover { background: #c0392b; }
    #annotation-overlay .anno-toolbar .anno-undo { background: #f39c12; color: white; }
    #annotation-overlay .anno-toolbar .anno-undo:hover { background: #e67e22; }
    #annotation-canvas-container {
      position: relative; display: inline-block;
    }
    #annotation-canvas {
      border: 2px solid white; border-radius: 4px; cursor: crosshair; max-width: 90vw; max-height: 70vh; display: block;
    }
    #annotation-text-input {
      position: absolute; background: rgba(0,0,0,0.7); border: 2px solid #fff; color: #ff4444;
      font-size: 24px; font-weight: 700; outline: none; padding: 6px 10px; min-width: 180px;
      display: none; z-index: 20001; border-radius: 4px; font-family: Arial, sans-serif;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    #annotation-text-input::placeholder { color: rgba(255,255,255,0.5); font-weight: 400; font-size: 18px; }
    #annotation-overlay .anno-hint { color: #aaa; font-size: 12px; margin-top: 8px; }

    /* Category bar */
    #category-bar {
      display: none; padding: 8px 12px; border-bottom: 1px solid #eee;
      gap: 6px; flex-wrap: wrap;
    }
    #category-bar.active { display: flex; }
    .cat-btn {
      padding: 4px 10px; border: 1px solid #ddd; border-radius: 16px; cursor: pointer;
      font-size: 12px; background: white; transition: all 0.2s; display: flex; align-items: center; gap: 4px;
    }
    .cat-btn:hover { border-color: #6C5CE7; color: #6C5CE7; }
    .cat-btn.selected { background: #6C5CE7; color: white; border-color: #6C5CE7; }

    /* Hidden file input */
    #file-input { display: none; }
  </style>
</head>
<body>
  <div class="header">
    <h1>MyApp - Sample Product Page</h1>
    <p>This is a test page to simulate a customer browsing your website with the AIChatDesk widget</p>
  </div>

  <div class="content">
    <div class="card">
      <h2>Server Connection</h2>
      <p>The chat widget connects to your AIChatDesk server. Make sure the server is running.</p>
      <div class="status-bar">
        <div class="status-item">Server: <span id="server-status">Checking...</span></div>
        <div class="status-item">WebSocket: <span id="ws-status">Not connected</span></div>
        <div class="status-item">Chat Mode: <span id="chat-mode">--</span></div>
      </div>
    </div>

    <div class="card">
      <h2>Sample Content (for AI context)</h2>
      <p><strong>MyApp</strong> is a project management tool for teams. Features include:</p>
      <ul style="margin: 10px 0 10px 20px; color: #666; line-height: 1.8;">
        <li>Task boards with drag-and-drop</li>
        <li>Team collaboration with real-time updates</li>
        <li>Time tracking and reporting</li>
        <li>Integrations with Slack, GitHub, and Jira</li>
        <li>Plans: Free, Pro ($10/mo), Enterprise (custom)</li>
      </ul>
      <p>Upload some FAQ documents about this imaginary product to test RAG responses.</p>
    </div>
  </div>

  <footer>
    AIChatDesk Test Page | <a href="dashboard.html" style="color: #6C5CE7;">Open Agent Dashboard</a>
  </footer>

  <!-- Chat Bubble -->
  <div id="chat-bubble" onclick="toggleChat()">
    <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
  </div>

  <!-- Chat Window -->
  <div id="chat-window">
    <div class="chat-header">
      <div>
        <h3>Support Chat</h3>
        <span class="mode-badge" id="mode-badge">AI Powered</span>
      </div>
      <div class="header-actions">
        <button class="header-icon-btn" onclick="toggleHeaderPopup('ticket-popup')" data-tooltip="Ticket Type">
          <svg viewBox="0 0 24 24"><path d="M20 12c0-1.1.9-2 2-2V6c0-1.1-.9-2-2-2H4c-1.1 0-1.99.9-1.99 2v4c1.1 0 1.99.9 1.99 2s-.89 2-2 2v4c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2v-4c-1.1 0-2-.9-2-2zm-4.42 4.8L12 14.5l-3.58 2.3 1.08-4.12-3.29-2.69 4.24-.25L12 5.8l1.54 3.95 4.24.25-3.29 2.69 1.09 4.11z"/></svg>
        </button>
        <button class="header-icon-btn" onclick="toggleHeaderPopup('priority-popup')" data-tooltip="Priority">
          <svg viewBox="0 0 24 24"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6z"/></svg>
        </button>
        <button class="header-icon-btn" onclick="toggleHeaderPopup('mood-popup')" data-tooltip="Mood">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
        </button>
        <button class="header-icon-btn" onclick="toggleEmoji()" data-tooltip="Emoji">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm1-13h-2v6l5.25 3.15.75-1.23-4.5-2.67V7z"/></svg>
        </button>
        <button class="header-icon-btn" onclick="toggleQuickActions()" data-tooltip="Quick Actions">
          <svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
        </button>
        <button class="header-icon-btn" onclick="openCalendarPopup()" data-tooltip="Schedule Call">
          <svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg>
        </button>
        <button onclick="bookDemo()" style="background:#f59e0b;color:#fff;border:none;padding:4px 12px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;letter-spacing:0.3px;white-space:nowrap;">Book Demo</button>
        <button class="close-btn" onclick="closeAndEndChat()">&times;</button>
      </div>
    </div>

    <div id="prechat-form">
      <h4>Start a conversation</h4>
      <input type="text" id="user-name" placeholder="Your name" value="Taj" required>
      <input type="email" id="user-email" placeholder="Your email" value="taj@haslani.com" required>
      <button class="start-btn" onclick="startChat()">Start Chat</button>
    </div>

    <!-- URL bar (always visible after chat starts) -->
    <div id="url-bar" style="display:none; padding:4px 14px; background:#f8f8f8; border-bottom:1px solid #eee; font-size:11px; color:#888; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title=""></div>

    <!-- Category bar (shown after chat starts, if categories exist) -->
    <div id="category-bar"></div>

    <div id="chat-messages">
      <div class="typing-indicator" id="typing-indicator">
        <span></span><span></span><span></span>
      </div>
    </div>

    <!-- Attachment preview -->
    <div id="attachment-preview"></div>

    <!-- Emoji picker -->
    <div id="emoji-picker"></div>

    <!-- Quick actions popup -->
    <div id="quick-actions">
      <div class="qa-item" onclick="quickAction('bug')">
        <svg viewBox="0 0 24 24"><path d="M20 8h-2.81c-.45-.78-1.07-1.45-1.82-1.96L17 4.41 15.59 3l-2.17 2.17C12.96 5.06 12.49 5 12 5s-.96.06-1.41.17L8.41 3 7 4.41l1.62 1.63C7.88 6.55 7.26 7.22 6.81 8H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c1.04 1.79 2.97 3 5.19 3s4.15-1.21 5.19-3H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20V8zm-6 8h-4v-2h4v2zm0-4h-4v-2h4v2z"/></svg>
        Report a Bug
      </div>
      <div class="qa-item" onclick="quickAction('feedback')">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"/></svg>
        Send Feedback
      </div>
      <div class="qa-item" onclick="quickAction('callback')">
        <svg viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/></svg>
        Request Callback
      </div>
    </div>

    <!-- Ticket type popup -->
    <div id="ticket-popup" class="header-popup">
      <div class="popup-label">Ticket Type</div>
      <div class="popup-item" onclick="selectTicket('bug')">&#x1F41B; Bug Report</div>
      <div class="popup-item" onclick="selectTicket('feature')">&#x2728; Feature Request</div>
      <div class="popup-item" onclick="selectTicket('question')">&#x2753; Question</div>
      <div class="popup-item" onclick="selectTicket('support')">&#x1F3AB; Support</div>
      <div class="popup-item" onclick="selectTicket(null)">&#x274C; Clear</div>
    </div>

    <!-- Priority popup -->
    <div id="priority-popup" class="header-popup">
      <div class="popup-label">Priority</div>
      <div class="popup-item" onclick="selectPriority('low')"><span class="pip" style="background:#00b894;"></span> Low</div>
      <div class="popup-item selected" onclick="selectPriority('medium')"><span class="pip" style="background:#f39c12;"></span> Medium</div>
      <div class="popup-item" onclick="selectPriority('high')"><span class="pip" style="background:#e74c3c;"></span> High</div>
    </div>

    <!-- Mood popup -->
    <div id="mood-popup" class="header-popup">
      <div class="popup-label">How are you feeling?</div>
      <div class="popup-item" onclick="selectMood(1)">&#x1F621; Angry</div>
      <div class="popup-item" onclick="selectMood(2)">&#x1F615; Confused</div>
      <div class="popup-item selected" onclick="selectMood(3)">&#x1F610; Neutral</div>
      <div class="popup-item" onclick="selectMood(4)">&#x1F642; Happy</div>
      <div class="popup-item" onclick="selectMood(5)">&#x1F929; Amazing</div>
    </div>

    <!-- Calendar popup -->
    <div id="calendar-popup">
      <!-- Step 1: Select type -->
      <div id="cal-step-type">
        <div class="cal-title">Schedule a Meeting</div>
        <div class="cal-subtitle">Select the type of meeting</div>
        <div class="cal-types">
          <button class="cal-type-btn" onclick="selectMeetingType('call')">
            <span class="cal-icon">&#x1F4DE;</span>Call
          </button>
          <button class="cal-type-btn" onclick="selectMeetingType('demo')">
            <span class="cal-icon">&#x1F5A5;</span>Demo
          </button>
          <button class="cal-type-btn" onclick="selectMeetingType('meeting')">
            <span class="cal-icon">&#x1F4CB;</span>Meeting
          </button>
        </div>
      </div>
      <!-- Step 1b: Contact info (phone & company) -->
      <div id="cal-step-contact" style="display:none;">
        <button class="cal-back-btn" onclick="calGoBack('type')">&larr; Back</button>
        <div class="cal-title">Your Details</div>
        <div class="cal-subtitle">So we can reach you</div>
        <div style="padding:8px 0;">
          <input type="tel" id="cal-phone" placeholder="Phone number" style="width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;margin-bottom:10px;box-sizing:border-box;">
          <input type="text" id="cal-company" placeholder="Company name" style="width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box;">
        </div>
        <button class="cal-confirm" onclick="calContactNext()" style="margin-top:12px;">Continue</button>
      </div>
      <!-- Step 2: Select date & time -->
      <div id="cal-step-slots" style="display:none;">
        <button class="cal-back-btn" onclick="calGoBack('contact')">&larr; Back</button>
        <div class="cal-title" id="cal-slots-title">Pick a time</div>
        <div class="cal-date-tabs" id="cal-date-tabs"></div>
        <div id="cal-slots-container">
          <div class="cal-loading">Loading available times...</div>
        </div>
      </div>
      <!-- Step 3: Confirm -->
      <div id="cal-step-confirm" style="display:none;">
        <button class="cal-back-btn" onclick="calGoBack('slots')">&larr; Back</button>
        <div class="cal-title">Confirm Booking</div>
        <div class="cal-summary" id="cal-summary"></div>
        <button class="cal-confirm" onclick="confirmCalendarBooking()">Book Now</button>
      </div>
      <!-- Step 4: Success -->
      <div id="cal-step-success" style="display:none;">
        <div class="cal-success">
          <div class="cal-check">&#x2705;</div>
          <div class="cal-title">Meeting Booked!</div>
          <p id="cal-success-details"></p>
          <a id="cal-meeting-link" href="#" target="_blank" style="display:none;">Join Meeting</a>
        </div>
        <button class="cal-confirm" onclick="closeCalendarPopup()" style="margin-top:12px;">Done</button>
      </div>
    </div>

    <!-- Input area (attach + screenshot buttons moved here) -->
    <div id="chat-input-area">
      <button class="input-icon-btn" onclick="endChatSession()" title="End chat" style="color:#dc2626;" data-tooltip="End Chat">
        <svg viewBox="0 0 24 24" style="fill:#dc2626;"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/></svg>
      </button>
      <button class="input-icon-btn" onclick="document.getElementById('file-input').click()" title="Attach file">
        <svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
      </button>
      <button class="input-icon-btn" onclick="captureScreenshot()" title="Screenshot">
        <svg viewBox="0 0 24 24"><path d="M21 6h-3.17L16 4h-6v2h5.12l1.83 2H21v12H5v-9H3v9c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM8 14c0 2.76 2.24 5 5 5s5-2.24 5-5-2.24-5-5-5-5 2.24-5 5zm5-3c1.65 0 3 1.35 3 3s-1.35 3-3 3-3-1.35-3-3 1.35-3 3-3zM5 6h3V4H5V1H3v3H0v2h3v3h2V6z"/></svg>
      </button>
      <input type="text" id="chat-input" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendMessage()">
      <button id="send-btn" onclick="sendMessage()">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>

    <input type="file" id="file-input" multiple accept="image/*,.pdf,.txt,.doc,.docx,.zip,.log" onchange="handleFileSelect(event)">
  </div>

  <!-- Screenshot annotation overlay -->
  <div id="annotation-overlay">
    <div class="anno-toolbar">
      <!-- Tool buttons -->
      <button class="anno-tool-btn active" id="anno-pen-btn" onclick="setAnnotationMode('pen')" title="Pen">
        <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
      </button>
      <button class="anno-tool-btn" id="anno-text-btn" onclick="setAnnotationMode('text')" title="Text">
        <svg viewBox="0 0 24 24"><path d="M5 4v3h5.5v12h3V7H19V4H5z"/></svg>
      </button>
      <button class="anno-tool-btn" id="anno-circle-btn" onclick="setAnnotationMode('circle')" title="Circle">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg>
      </button>
      <div class="anno-separator"></div>
      <!-- Color dots -->
      <button class="anno-color-dot active" onclick="setAnnotationColor('#e74c3c')" title="Red"><span class="anno-color-inner" style="background:#e74c3c;"></span></button>
      <button class="anno-color-dot" onclick="setAnnotationColor('#2980b9')" title="Blue"><span class="anno-color-inner" style="background:#2980b9;"></span></button>
      <button class="anno-color-dot" onclick="setAnnotationColor('#27ae60')" title="Green"><span class="anno-color-inner" style="background:#27ae60;"></span></button>
      <button class="anno-color-dot" onclick="setAnnotationColor('#f1c40f')" title="Yellow"><span class="anno-color-inner" style="background:#f1c40f;"></span></button>
      <div class="anno-separator"></div>
      <button class="anno-undo" onclick="annotationUndo()">Undo</button>
      <button class="anno-done" onclick="annotationDone()">Done</button>
      <button class="anno-clear" onclick="annotationClear()">Clear</button>
      <button class="anno-cancel" onclick="annotationCancel()">Cancel</button>
    </div>
    <div id="annotation-canvas-container">
      <canvas id="annotation-canvas"></canvas>
      <input type="text" id="annotation-text-input" placeholder="Type here and press Enter" onmousedown="event.stopPropagation();" onclick="event.stopPropagation();">
    </div>
    <div class="anno-hint">Draw, add text, or circle areas on the screenshot, then click Done</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    const API = 'http://localhost:8004';
    const WS_URL = 'ws://localhost:8004/ws';

    const BLOCKED_EXTENSIONS = ['.exe','.com','.bat','.cmd','.scr','.pif','.msi','.vbs','.js','.ws','.wsf','.ps1','.sh'];

    let ws = null;
    let sessionId = null;
    let chatId = null;
    let chatMode = 'ai';
    let userName = '';
    let userEmail = '';
    let pendingFiles = []; // files queued for upload
    let selectedTicketType = null;
    let selectedPriority = 'medium';
    let selectedMood = 3;
    let selectedCategory = null;

    function toggleHeaderPopup(id) {
      closeAllPopups();
      const popup = document.getElementById(id);
      popup.classList.toggle('open');
    }

    function closeAllPopups() {
      document.querySelectorAll('.header-popup, #emoji-picker, #quick-actions, #calendar-popup').forEach(p => p.classList.remove('open'));
    }

    function selectTicket(type) {
      selectedTicketType = type;
      document.querySelectorAll('#ticket-popup .popup-item').forEach(el => {
        el.classList.toggle('selected', el.textContent.toLowerCase().includes(type || '___none'));
      });
      document.getElementById('ticket-popup').classList.remove('open');
    }
    function selectPriority(level) {
      selectedPriority = level;
      document.querySelectorAll('#priority-popup .popup-item').forEach(el => {
        el.classList.toggle('selected', el.textContent.trim().toLowerCase() === level);
      });
      document.getElementById('priority-popup').classList.remove('open');
    }
    function selectMood(val) {
      selectedMood = val;
      const labels = ['', 'angry', 'confused', 'neutral', 'happy', 'amazing'];
      document.querySelectorAll('#mood-popup .popup-item').forEach(el => {
        el.classList.toggle('selected', el.textContent.trim().toLowerCase().includes(labels[val] || ''));
      });
      document.getElementById('mood-popup').classList.remove('open');
    }

    // --- Environment capture ---
    function captureEnvironment() {
      return {
        browser: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        languages: navigator.languages,
        cookiesEnabled: navigator.cookieEnabled,
        doNotTrack: navigator.doNotTrack,
        screenWidth: screen.width,
        screenHeight: screen.height,
        screenColorDepth: screen.colorDepth,
        windowWidth: window.innerWidth,
        windowHeight: window.innerHeight,
        devicePixelRatio: window.devicePixelRatio,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        timezoneOffset: new Date().getTimezoneOffset(),
        online: navigator.onLine,
        connectionType: navigator.connection?.effectiveType,
        connectionDownlink: navigator.connection?.downlink,
        hardwareConcurrency: navigator.hardwareConcurrency,
        deviceMemory: navigator.deviceMemory,
        maxTouchPoints: navigator.maxTouchPoints,
        referrer: document.referrer,
        currentUrl: window.location.href,
        localStorage: typeof localStorage !== 'undefined',
        sessionStorage: typeof sessionStorage !== 'undefined'
      };
    }

    // --- Emoji data ---
    const emojiData = {
      'Smileys': ['ðŸ˜€','ðŸ˜ƒ','ðŸ˜„','ðŸ˜','ðŸ˜…','ðŸ˜‚','ðŸ¤£','ðŸ˜Š','ðŸ˜‡','ðŸ™‚','ðŸ˜‰','ðŸ˜Œ','ðŸ˜','ðŸ¥°','ðŸ˜˜','ðŸ˜—','ðŸ˜™','ðŸ˜‹','ðŸ˜›','ðŸ˜œ','ðŸ¤ª','ðŸ˜','ðŸ¤‘','ðŸ¤—','ðŸ¤­','ðŸ¤«','ðŸ¤”','ðŸ˜','ðŸ˜‘','ðŸ˜¶','ðŸ˜','ðŸ˜’','ðŸ™„','ðŸ˜¬','ðŸ˜®â€ðŸ’¨','ðŸ¤¥'],
      'Gestures': ['ðŸ‘','ðŸ‘Ž','ðŸ‘‹','ðŸ¤','ðŸ™','ðŸ’ª','ðŸ‘','ðŸ¤ž','âœŒï¸','ðŸ¤Ÿ','ðŸ¤™','ðŸ‘Œ','ðŸ«¡','ðŸ«¶','â¤ï¸','ðŸ”¥','â­','âœ…','âŒ','âš¡','ðŸ’¯'],
      'Objects': ['ðŸ’»','ðŸ“±','ðŸ“§','ðŸ“Ž','ðŸ“','ðŸ”‘','ðŸ”’','ðŸ’¡','ðŸ“Š','ðŸŽ¯','ðŸ› ï¸','âš™ï¸','ðŸ“¦','ðŸš€','ðŸ’¬','ðŸ“ž','ðŸ·ï¸','ðŸ’³','ðŸ§¾','ðŸ“‹']
    };

    // --- Server health check ---
    async function checkServer() {
      try {
        const res = await fetch(`${API}/health`);
        const data = await res.json();
        const el = document.getElementById('server-status');
        el.textContent = data.status === 'ok' ? 'Connected' : 'Error';
        el.style.color = data.status === 'ok' ? '#00b894' : '#e74c3c';
      } catch {
        const el = document.getElementById('server-status');
        el.textContent = 'Offline';
        el.style.color = '#e74c3c';
      }
    }

    // --- WebSocket ---
    function connectWS() {
      try {
        ws = new WebSocket(WS_URL);
        ws.onopen = () => {
          document.getElementById('ws-status').textContent = 'Connected';
          document.getElementById('ws-status').style.color = '#00b894';
          if (sessionId) ws.send(JSON.stringify({ type: 'chat.join', sessionId, clientType: 'widget' }));
        };
        ws.onmessage = (e) => { handleWSMessage(JSON.parse(e.data)); };
        ws.onclose = () => {
          document.getElementById('ws-status').textContent = 'Disconnected';
          document.getElementById('ws-status').style.color = '#e74c3c';
          setTimeout(connectWS, 3000);
        };
        ws.onerror = () => {};
      } catch {}
    }

    function handleWSMessage(data) {
      resetInactivityTimer();
      switch (data.type) {
        case 'chat.message':
          if (data.message && data.message.sender !== 'user') {
            addMessage(data.message.content, data.message.sender, data.message.senderName);
          }
          break;
        case 'agent.takeover':
          chatMode = 'human'; updateModeBadge();
          addSystemMessage(`${data.agentName || 'An agent'} has joined the chat`);
          break;
        case 'agent.return':
          chatMode = 'ai'; updateModeBadge();
          addSystemMessage('You are now chatting with AI');
          break;
      }
    }

    function toggleChat() { document.getElementById('chat-window').classList.toggle('open'); }

    // --- Workflow categories ---
    async function loadCategories() {
      try {
        const res = await fetch(`${API}/api/categories`);
        const cats = await res.json();
        if (!cats || !cats.length) return;
        const bar = document.getElementById('category-bar');
        bar.innerHTML = cats.map(cat =>
          `<button class="cat-btn" data-id="${cat._id}" onclick="selectCategory('${cat._id}', this)">${cat.icon ? cat.icon + ' ' : ''}${cat.name}</button>`
        ).join('');
        bar.classList.add('active');
      } catch (err) {
        console.log('Categories not available:', err.message);
      }
    }

    async function selectCategory(catId, btn) {
      selectedCategory = catId;
      document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
      if (btn) btn.classList.add('selected');
      try {
        await fetch(`${API}/api/chat/${sessionId}/category`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ categoryId: catId })
        });
        const catName = btn ? btn.textContent.trim() : '';
        addSystemMessage(`${catName} selected.`);
        // Trigger AI greeting based on category prompt
        document.getElementById('typing-indicator').classList.add('show');
        try {
          const aiRes = await fetch(`${API}/api/ai/query`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chatId, message: 'Hello', userEmail, userName, pageContext: window.location.pathname })
          });
          const aiData = await aiRes.json();
          document.getElementById('typing-indicator').classList.remove('show');
          if (aiData.response) {
            addMessage(aiData.response, 'ai', null, aiData.confidence);
          }
        } catch (e) {
          document.getElementById('typing-indicator').classList.remove('show');
        }
      } catch (err) {
        console.error('Failed to set category:', err);
      }
    }

    // --- Start chat ---
    async function startChat() {
      userName = document.getElementById('user-name').value.trim();
      userEmail = document.getElementById('user-email').value.trim();
      if (!userName || !userEmail) { alert('Please enter your name and email'); return; }

      try {
        const res = await fetch(`${API}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userName, userEmail, currentPage: window.location.pathname,
            ticketType: selectedTicketType || undefined,
            userPriority: selectedPriority || undefined,
            mood: selectedMood || undefined,
            environment: captureEnvironment()
          })
        });
        const data = await res.json();
        sessionId = data.sessionId;
        chatId = data.chatId;
        chatMode = data.mode || 'ai';
        window._chatStartTime = Date.now();
        resetInactivityTimer();
        if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'chat.join', sessionId, clientType: 'widget' }));
        chatMode = 'ai'; // Always default to AI
        document.getElementById('prechat-form').style.display = 'none';
        document.getElementById('chat-messages').classList.add('active');
        document.getElementById('chat-input-area').classList.add('active');
        // Show URL bar
        const urlBar = document.getElementById('url-bar');
        urlBar.textContent = window.location.href;
        urlBar.title = window.location.href;
        urlBar.style.display = 'block';
        updateModeBadge();
        // Load categories first â€” prompt user to pick one
        await loadCategories();
        if (document.getElementById('category-bar').classList.contains('active')) {
          addSystemMessage('Please select a category to get started.');
        } else {
          addSystemMessage('Connected! Ask anything.');
        }
      } catch (err) { alert('Failed to connect: ' + err.message); }
    }

    // --- Upload files ---
    async function uploadFiles(files) {
      const formData = new FormData();
      for (const f of files) formData.append('files', f);
      try {
        const res = await fetch(`${API}/api/upload`, { method: 'POST', body: formData });
        const data = await res.json();
        return data.files || [];
      } catch (err) {
        console.error('Upload failed:', err);
        return [];
      }
    }

    // --- End chat session ---
    async function endChatSession() {
      if (!sessionId) return;
      clearInactivityTimer();
      try {
        await fetch(`${API}/api/messages/chat/${sessionId}/end`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
      } catch (e) { console.error('End chat error:', e); }
      addSystemMessage('Chat ended. Thank you!');
      chatId = null;
      document.getElementById('chat-input').disabled = true;
      document.getElementById('chat-input').placeholder = 'Chat ended';
    }

    // Close chat window AND end the session
    function closeAndEndChat() {
      document.getElementById('chat-window').classList.remove('open');
      if (chatId) endChatSession();
    }

    // --- Inactivity timer (3 min) ---
    let inactivityTimer = null;
    function resetInactivityTimer() {
      clearInactivityTimer();
      if (!chatId) return;
      inactivityTimer = setTimeout(() => {
        console.log('[Inactivity] 3 min timeout â€” ending chat');
        endChatSession();
      }, 3 * 60 * 1000);
    }
    function clearInactivityTimer() {
      if (inactivityTimer) { clearTimeout(inactivityTimer); inactivityTimer = null; }
    }

    // End chat on tab/window close
    window.addEventListener('beforeunload', () => {
      if (sessionId) {
        navigator.sendBeacon(`${API}/api/messages/chat/${sessionId}/end`, JSON.stringify({}));
      }
    });

    // --- Send message ---
    async function sendMessage() {
      resetInactivityTimer();
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      const hasFiles = pendingFiles.length > 0;
      if (!text && !hasFiles) return;
      if (!chatId) return;

      // Check for stop/end commands
      if (/^(stop|end|bye|close|quit|exit)$/i.test(text)) {
        input.value = '';
        addMessage(text, 'user');
        await endChatSession();
        return;
      }

      input.value = '';

      // Upload pending files first
      let uploadedFiles = [];
      if (hasFiles) {
        addSystemMessage('Uploading files...');
        uploadedFiles = await uploadFiles(pendingFiles);
        clearAttachments();
      }

      // Show user message
      addMessage(text, 'user', null, undefined, uploadedFiles);

      document.getElementById('typing-indicator').classList.add('show');

      // Save user message to DB
      try {
        await fetch(`${API}/api/messages`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chatId,
            content: text || (uploadedFiles.length ? `[Sent ${uploadedFiles.length} file(s)]` : ''),
            attachments: uploadedFiles.map(f => ({ filename: f.originalName || f.filename, url: f.url, type: f.type, size: f.size }))
          })
        });
      } catch (err) { console.error('Failed to save message:', err); }

      // AI query
      if (chatMode === 'ai' && text) {
        try {
          const res = await fetch(`${API}/api/ai/query`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chatId, message: text, userEmail, userName, pageContext: window.location.pathname })
          });
          const data = await res.json();
          document.getElementById('typing-indicator').classList.remove('show');
          if (data.response) {
            addMessage(data.response, 'ai', null, data.confidence);
            if (data.needsHuman) {
              addSystemMessage('AI confidence is low. Requesting human agent...');
              chatMode = 'human'; updateModeBadge();
            }
          } else {
            addMessage('Sorry, I encountered an error. Please try again.', 'ai');
          }
        } catch {
          document.getElementById('typing-indicator').classList.remove('show');
          addMessage('Connection error. Please try again.', 'system');
        }
      } else {
        setTimeout(() => { document.getElementById('typing-indicator').classList.remove('show'); }, 1000);
      }
    }

    // --- Blocked extension check ---
    function isBlockedFile(file) {
      const name = file.name.toLowerCase();
      const dotIdx = name.lastIndexOf('.');
      if (dotIdx === -1) return false;
      const ext = name.substring(dotIdx);
      return BLOCKED_EXTENSIONS.includes(ext);
    }

    // --- File handling ---
    function handleFileSelect(e) {
      const files = Array.from(e.target.files);
      files.forEach(f => {
        if (isBlockedFile(f)) {
          alert(`File "${f.name}" is not allowed. Blocked file type.`);
          return;
        }
        addPendingFile(f);
      });
      e.target.value = ''; // reset so same file can be re-selected
    }

    function addPendingFile(file) {
      if (isBlockedFile(file)) {
        alert(`File "${file.name}" is not allowed. Blocked file type.`);
        return;
      }
      if (pendingFiles.length >= 5) { alert('Maximum 5 files at a time'); return; }
      if (file.size > 10 * 1024 * 1024) { alert(`${file.name} is too large (max 10MB)`); return; }
      pendingFiles.push(file);
      renderAttachmentPreview();
    }

    function removePendingFile(idx) {
      pendingFiles.splice(idx, 1);
      renderAttachmentPreview();
    }

    function clearAttachments() {
      pendingFiles = [];
      renderAttachmentPreview();
    }

    function renderAttachmentPreview() {
      const el = document.getElementById('attachment-preview');
      if (pendingFiles.length === 0) {
        el.classList.remove('active');
        el.innerHTML = '';
        return;
      }
      el.classList.add('active');
      // Filter out system-info TXT from preview (still uploaded)
      const visibleFiles = pendingFiles.filter(f => !f.name.startsWith('system-info'));
      if (visibleFiles.length === 0) { el.classList.remove('active'); el.innerHTML = ''; return; }
      el.innerHTML = pendingFiles.map((f, i) => {
        if (f.name.startsWith('system-info')) return '';
        const isImg = f.type.startsWith('image/');
        if (isImg) {
          const url = URL.createObjectURL(f);
          return `<div class="preview-item"><img src="${url}"><button class="remove-btn" onclick="removePendingFile(${i})">&times;</button></div>`;
        }
        return `<div class="preview-item"><div class="file-icon">${f.name.split('.').pop().toUpperCase()}</div><button class="remove-btn" onclick="removePendingFile(${i})">&times;</button></div>`;
      }).join('');
    }

    // --- Clipboard paste (screenshots) ---
    document.addEventListener('paste', (e) => {
      if (!chatId) return;
      const items = e.clipboardData?.items;
      if (!items) return;
      for (const item of items) {
        if (item.type.startsWith('image/')) {
          e.preventDefault();
          const file = item.getAsFile();
          if (file) {
            const ext = file.type.split('/')[1] || 'png';
            const named = new File([file], `screenshot-${Date.now()}.${ext}`, { type: file.type });
            addPendingFile(named);
            addPendingFile(createSystemInfoFile());
          }
        }
      }
    });

    // --- Emoji picker ---
    function toggleEmoji() {
      const picker = document.getElementById('emoji-picker');
      const wasOpen = picker.classList.contains('open');
      closeAllPopups();
      if (wasOpen) return;
      // Build picker if empty
      if (!picker.innerHTML) {
        let html = '';
        for (const [cat, emojis] of Object.entries(emojiData)) {
          html += `<div class="emoji-category"><div class="emoji-category-label">${cat}</div><div class="emoji-grid">`;
          emojis.forEach(e => { html += `<span onclick="insertEmoji('${e}')">${e}</span>`; });
          html += '</div></div>';
        }
        picker.innerHTML = html;
      }
      picker.classList.add('open');
    }

    function insertEmoji(emoji) {
      const input = document.getElementById('chat-input');
      const pos = input.selectionStart || input.value.length;
      input.value = input.value.slice(0, pos) + emoji + input.value.slice(pos);
      input.focus();
      input.setSelectionRange(pos + emoji.length, pos + emoji.length);
      document.getElementById('emoji-picker').classList.remove('open');
    }

    // --- Enhanced Screenshot annotation ---
    let annoBaseImage = null;
    let annoDrawing = false;
    let annoCtx = null;
    let annotationMode = 'pen'; // 'pen' | 'text' | 'circle'
    let annotationColor = '#e74c3c';
    let annotations = []; // { type: 'pen'|'text'|'circle', data: ..., color: string }
    let currentPenPath = []; // points for current pen stroke
    let circleStart = null; // {x, y} for circle drag start

    function setAnnotationMode(mode) {
      annotationMode = mode;
      document.getElementById('anno-pen-btn').classList.toggle('active', mode === 'pen');
      document.getElementById('anno-text-btn').classList.toggle('active', mode === 'text');
      document.getElementById('anno-circle-btn').classList.toggle('active', mode === 'circle');
      // Update cursor
      const canvas = document.getElementById('annotation-canvas');
      canvas.style.cursor = mode === 'text' ? 'text' : 'crosshair';
    }

    function setAnnotationColor(color) {
      annotationColor = color;
      document.querySelectorAll('.anno-color-dot').forEach(dot => {
        const inner = dot.querySelector('.anno-color-inner');
        dot.classList.toggle('active', inner && inner.style.background === color);
      });
    }

    function captureScreenshot() {
      if (!chatId) { alert('Please start a chat first'); return; }
      const chatWindow = document.getElementById('chat-window');
      const bubble = document.getElementById('chat-bubble');
      chatWindow.style.visibility = 'hidden';
      bubble.style.visibility = 'hidden';

      html2canvas(document.body, { useCORS: true, scale: 1 }).then(canvas => {
        chatWindow.style.visibility = '';
        bubble.style.visibility = '';
        openAnnotation(canvas);
      }).catch(err => {
        chatWindow.style.visibility = '';
        bubble.style.visibility = '';
        console.error('Screenshot failed:', err);
        alert('Screenshot capture failed');
      });
    }

    function openAnnotation(sourceCanvas) {
      const overlay = document.getElementById('annotation-overlay');
      const annoCanvas = document.getElementById('annotation-canvas');

      const maxW = window.innerWidth * 0.9;
      const maxH = window.innerHeight * 0.70;
      let w = sourceCanvas.width, h = sourceCanvas.height;
      const ratio = Math.min(maxW / w, maxH / h, 1);
      w = Math.round(w * ratio);
      h = Math.round(h * ratio);

      annoCanvas.width = w;
      annoCanvas.height = h;
      annoCtx = annoCanvas.getContext('2d');
      annoCtx.drawImage(sourceCanvas, 0, 0, w, h);

      annoBaseImage = annoCtx.getImageData(0, 0, w, h);
      annotations = [];
      currentPenPath = [];
      circleStart = null;
      annotationMode = 'pen';
      annotationColor = '#e74c3c';

      // Reset toolbar state
      setAnnotationMode('pen');
      setAnnotationColor('#e74c3c');

      // Mouse handlers
      annoCanvas.onmousedown = (e) => handleAnnoMouseDown(e.offsetX, e.offsetY);
      annoCanvas.onmousemove = (e) => handleAnnoMouseMove(e.offsetX, e.offsetY);
      annoCanvas.onmouseup = (e) => handleAnnoMouseUp(e.offsetX, e.offsetY);
      annoCanvas.onmouseleave = () => { if (annotationMode === 'pen' && annoDrawing) handleAnnoMouseUp(0, 0); };

      // Touch support
      annoCanvas.ontouchstart = (e) => {
        e.preventDefault();
        const t = e.touches[0]; const r = annoCanvas.getBoundingClientRect();
        handleAnnoMouseDown(t.clientX - r.left, t.clientY - r.top);
      };
      annoCanvas.ontouchmove = (e) => {
        e.preventDefault();
        const t = e.touches[0]; const r = annoCanvas.getBoundingClientRect();
        handleAnnoMouseMove(t.clientX - r.left, t.clientY - r.top);
      };
      annoCanvas.ontouchend = (e) => {
        e.preventDefault();
        handleAnnoMouseUp(0, 0);
      };

      overlay.classList.add('open');
    }

    function handleAnnoMouseDown(x, y) {
      if (annotationMode === 'pen') {
        annoDrawing = true;
        currentPenPath = [{ x, y }];
        annoCtx.beginPath();
        annoCtx.moveTo(x, y);
      } else if (annotationMode === 'circle') {
        annoDrawing = true;
        circleStart = { x, y };
      } else if (annotationMode === 'text') {
        showTextInput(x, y);
      }
    }

    function handleAnnoMouseMove(x, y) {
      if (!annoDrawing) return;
      if (annotationMode === 'pen') {
        currentPenPath.push({ x, y });
        annoCtx.strokeStyle = annotationColor;
        annoCtx.lineWidth = 3;
        annoCtx.lineCap = 'round';
        annoCtx.lineJoin = 'round';
        annoCtx.lineTo(x, y);
        annoCtx.stroke();
      } else if (annotationMode === 'circle' && circleStart) {
        // Redraw everything up to now, then preview the ellipse
        redrawAnnotations();
        drawEllipseFromPoints(circleStart.x, circleStart.y, x, y, annotationColor, false);
      }
    }

    function handleAnnoMouseUp(x, y) {
      if (!annoDrawing) return;
      annoDrawing = false;
      if (annotationMode === 'pen' && currentPenPath.length > 1) {
        annotations.push({ type: 'pen', data: [...currentPenPath], color: annotationColor });
        currentPenPath = [];
      } else if (annotationMode === 'circle' && circleStart) {
        annotations.push({ type: 'circle', data: { x1: circleStart.x, y1: circleStart.y, x2: x, y2: y }, color: annotationColor });
        circleStart = null;
        redrawAnnotations();
      }
    }

    let activeTextCommit = null; // reference to current commit function

    function showTextInput(x, y) {
      // Commit any previous text first
      if (activeTextCommit) { activeTextCommit(); activeTextCommit = null; }

      const input = document.getElementById('annotation-text-input');
      input.style.left = x + 'px';
      input.style.top = (y - 16) + 'px';
      input.style.color = annotationColor;
      input.style.borderColor = annotationColor;
      input.style.display = 'block';
      input.value = '';
      setTimeout(() => input.focus(), 50);

      const currentColor = annotationColor;

      function commitText() {
        const text = input.value.trim();
        if (text) {
          annotations.push({ type: 'text', data: { x, y, text }, color: currentColor });
          redrawAnnotations();
        }
        input.style.display = 'none';
        input.removeEventListener('keydown', onKey);
        activeTextCommit = null;
      }

      function onKey(e) {
        e.stopPropagation();
        if (e.key === 'Enter') {
          e.preventDefault();
          commitText();
        } else if (e.key === 'Escape') {
          input.style.display = 'none';
          input.value = '';
          input.removeEventListener('keydown', onKey);
          activeTextCommit = null;
        }
      }

      input.addEventListener('keydown', onKey);
      activeTextCommit = commitText;
    }

    function drawEllipseFromPoints(x1, y1, x2, y2, color, permanent) {
      const cx = (x1 + x2) / 2;
      const cy = (y1 + y2) / 2;
      const rx = Math.abs(x2 - x1) / 2;
      const ry = Math.abs(y2 - y1) / 2;
      if (rx < 2 && ry < 2) return;
      annoCtx.beginPath();
      annoCtx.ellipse(cx, cy, rx, ry, 0, 0, 2 * Math.PI);
      annoCtx.strokeStyle = color;
      annoCtx.lineWidth = 3;
      annoCtx.stroke();
    }

    function redrawAnnotations() {
      if (!annoBaseImage || !annoCtx) return;
      const canvas = document.getElementById('annotation-canvas');
      annoCtx.putImageData(annoBaseImage, 0, 0);

      for (const anno of annotations) {
        if (anno.type === 'pen') {
          annoCtx.beginPath();
          annoCtx.strokeStyle = anno.color;
          annoCtx.lineWidth = 3;
          annoCtx.lineCap = 'round';
          annoCtx.lineJoin = 'round';
          const pts = anno.data;
          if (pts.length > 0) {
            annoCtx.moveTo(pts[0].x, pts[0].y);
            for (let i = 1; i < pts.length; i++) {
              annoCtx.lineTo(pts[i].x, pts[i].y);
            }
            annoCtx.stroke();
          }
        } else if (anno.type === 'circle') {
          drawEllipseFromPoints(anno.data.x1, anno.data.y1, anno.data.x2, anno.data.y2, anno.color, true);
        } else if (anno.type === 'text') {
          annoCtx.font = 'bold 24px Arial, sans-serif';
          annoCtx.fillStyle = anno.color;
          annoCtx.fillText(anno.data.text, anno.data.x, anno.data.y);
        }
      }
    }

    function annotationUndo() {
      if (annotations.length === 0) return;
      annotations.pop();
      redrawAnnotations();
    }

    function generateSystemInfo() {
      const nav = navigator;
      const scr = screen;
      const perf = performance;
      const conn = nav.connection || nav.mozConnection || nav.webkitConnection || {};
      const mem = nav.deviceMemory || 'N/A';
      const cores = nav.hardwareConcurrency || 'N/A';
      const timing = perf.timing || {};
      const loadTime = timing.loadEventEnd && timing.navigationStart ? (timing.loadEventEnd - timing.navigationStart) + 'ms' : 'N/A';
      const domReady = timing.domContentLoadedEventEnd && timing.navigationStart ? (timing.domContentLoadedEventEnd - timing.navigationStart) + 'ms' : 'N/A';
      const now = new Date();
      const chatStart = window._chatStartTime || 0;
      const sessionDuration = chatStart ? Math.round((Date.now() - chatStart) / 1000) : 0;
      const sessionMin = Math.floor(sessionDuration / 60);
      const sessionSec = sessionDuration % 60;

      // Detect browser name and version
      const ua = nav.userAgent;
      let browserName = 'Unknown', browserVersion = '';
      if (ua.includes('Firefox/')) { browserName = 'Firefox'; browserVersion = ua.match(/Firefox\/([\d.]+)/)?.[1] || ''; }
      else if (ua.includes('Edg/')) { browserName = 'Edge'; browserVersion = ua.match(/Edg\/([\d.]+)/)?.[1] || ''; }
      else if (ua.includes('Chrome/')) { browserName = 'Chrome'; browserVersion = ua.match(/Chrome\/([\d.]+)/)?.[1] || ''; }
      else if (ua.includes('Safari/') && !ua.includes('Chrome')) { browserName = 'Safari'; browserVersion = ua.match(/Version\/([\d.]+)/)?.[1] || ''; }

      // Detect OS
      let osName = 'Unknown';
      if (ua.includes('Windows NT 10')) osName = 'Windows 10/11';
      else if (ua.includes('Windows')) osName = 'Windows';
      else if (ua.includes('Mac OS X')) { const v = ua.match(/Mac OS X ([\d_]+)/)?.[1]?.replace(/_/g, '.') || ''; osName = 'macOS ' + v; }
      else if (ua.includes('Linux')) osName = 'Linux';
      else if (ua.includes('Android')) osName = 'Android ' + (ua.match(/Android ([\d.]+)/)?.[1] || '');
      else if (ua.includes('iPhone') || ua.includes('iPad')) osName = 'iOS ' + (ua.match(/OS ([\d_]+)/)?.[1]?.replace(/_/g, '.') || '');

      // Detect device type
      let deviceType = 'Desktop';
      if (/Mobi|Android/i.test(ua)) deviceType = 'Mobile';
      else if (/Tablet|iPad/i.test(ua)) deviceType = 'Tablet';

      // Battery info (async but we'll try sync check)
      let batteryInfo = 'N/A';

      // Local storage usage
      let storageUsed = 'N/A';
      try {
        let total = 0;
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          total += (localStorage.getItem(key) || '').length;
        }
        storageUsed = Math.round(total / 1024) + ' KB';
      } catch(e) {}

      // Count console errors (if available)
      const resourceErrors = perf.getEntriesByType ? perf.getEntriesByType('resource').filter(r => r.transferSize === 0 && r.decodedBodySize === 0).length : 0;

      // Slow resources
      let slowResources = [];
      try {
        const resources = perf.getEntriesByType('resource') || [];
        slowResources = resources
          .filter(r => r.duration > 1000)
          .sort((a, b) => b.duration - a.duration)
          .slice(0, 5)
          .map(r => '  ' + Math.round(r.duration) + 'ms - ' + r.name.split('/').pop().substring(0, 60));
      } catch(e) {}

      // Blocked features / permissions
      const permChecks = ['clipboard-read', 'clipboard-write', 'notifications', 'geolocation', 'camera', 'microphone'];

      const lines = [
        '=== USER SYSTEM INFORMATION ===',
        'Captured: ' + now.toLocaleString() + ' (' + Intl.DateTimeFormat().resolvedOptions().timeZone + ')',
        'Chat Session: ' + (sessionId || 'N/A'),
        'Session Duration: ' + sessionMin + 'm ' + sessionSec + 's',
        '',
        '--- Device ---',
        'Type: ' + deviceType,
        'OS: ' + osName,
        'Browser: ' + browserName + ' ' + browserVersion,
        'Platform: ' + (nav.userAgentData?.platform || nav.platform || 'N/A'),
        'User Agent: ' + ua,
        '',
        '--- Screen & Display ---',
        'Screen Resolution: ' + scr.width + 'x' + scr.height,
        'Available Area: ' + scr.availWidth + 'x' + scr.availHeight,
        'Browser Window: ' + window.innerWidth + 'x' + window.innerHeight,
        'Outer Window: ' + window.outerWidth + 'x' + window.outerHeight,
        'Pixel Ratio: ' + window.devicePixelRatio + 'x',
        'Color Depth: ' + scr.colorDepth + '-bit',
        'Orientation: ' + (scr.orientation?.type || 'N/A'),
        'Scroll Position: ' + window.scrollX + ', ' + window.scrollY,
        'Document Size: ' + document.documentElement.scrollWidth + 'x' + document.documentElement.scrollHeight,
        '',
        '--- Hardware ---',
        'CPU Cores: ' + cores,
        'Device Memory: ' + (mem !== 'N/A' ? mem + ' GB' : 'N/A'),
        'Max Touch Points: ' + (nav.maxTouchPoints || 0),
        'Gamepad: ' + (nav.getGamepads ? nav.getGamepads().filter(Boolean).length + ' connected' : 'N/A'),
        '',
        '--- Network ---',
        'Online: ' + nav.onLine,
        'Connection Type: ' + (conn.effectiveType || 'N/A'),
        'Downlink Speed: ' + (conn.downlink ? conn.downlink + ' Mbps' : 'N/A'),
        'Round Trip Time: ' + (conn.rtt ? conn.rtt + 'ms' : 'N/A'),
        'Save Data Mode: ' + (conn.saveData || false),
        '',
        '--- Performance ---',
        'Page Load Time: ' + loadTime,
        'DOM Ready: ' + domReady,
        'JS Heap: ' + (perf.memory ? Math.round(perf.memory.usedJSHeapSize / 1048576) + ' MB used / ' + Math.round(perf.memory.jsHeapSizeLimit / 1048576) + ' MB limit' : 'N/A'),
        'Failed Resources: ' + resourceErrors,
      ];
      if (slowResources.length > 0) {
        lines.push('Slow Resources (>1s):');
        slowResources.forEach(r => lines.push(r));
      }
      lines.push('');
      lines.push('--- Page Context ---');
      lines.push('URL: ' + window.location.href);
      lines.push('Protocol: ' + window.location.protocol);
      lines.push('Host: ' + window.location.host);
      lines.push('Path: ' + window.location.pathname);
      lines.push('Query: ' + (window.location.search || '(none)'));
      lines.push('Hash: ' + (window.location.hash || '(none)'));
      lines.push('Referrer: ' + (document.referrer || 'Direct'));
      lines.push('Title: ' + document.title);
      lines.push('Charset: ' + document.characterSet);
      lines.push('Doc Mode: ' + document.compatMode);
      lines.push('Visibility: ' + document.visibilityState);
      lines.push('Focused: ' + document.hasFocus());
      lines.push('iFrame: ' + (window.self !== window.top));
      lines.push('');
      lines.push('--- Browser Features ---');
      lines.push('Language: ' + nav.language);
      lines.push('Languages: ' + (nav.languages || []).join(', '));
      lines.push('Cookies: ' + nav.cookieEnabled);
      lines.push('Do Not Track: ' + (nav.doNotTrack === '1' ? 'Enabled' : nav.doNotTrack === '0' ? 'Disabled' : 'Not Set'));
      lines.push('PDF Viewer: ' + (nav.pdfViewerEnabled ?? 'N/A'));
      lines.push('WebGL: ' + (!!document.createElement('canvas').getContext('webgl') ? 'Yes' : 'No'));
      lines.push('WebRTC: ' + (typeof RTCPeerConnection !== 'undefined' ? 'Yes' : 'No'));
      lines.push('Service Workers: ' + ('serviceWorker' in nav ? 'Yes' : 'No'));
      lines.push('Web Workers: ' + (typeof Worker !== 'undefined' ? 'Yes' : 'No'));
      lines.push('WebSocket: ' + (typeof WebSocket !== 'undefined' ? 'Yes' : 'No'));
      lines.push('Notifications: ' + (typeof Notification !== 'undefined' ? Notification.permission : 'N/A'));
      lines.push('Geolocation: ' + ('geolocation' in nav ? 'Available' : 'No'));
      lines.push('Clipboard API: ' + ('clipboard' in nav ? 'Yes' : 'No'));
      lines.push('Share API: ' + ('share' in nav ? 'Yes' : 'No'));
      lines.push('Bluetooth: ' + ('bluetooth' in nav ? 'Yes' : 'No'));
      lines.push('USB: ' + ('usb' in nav ? 'Yes' : 'No'));
      lines.push('Local Storage: ' + storageUsed + ' used');
      lines.push('');
      lines.push('--- Date/Time ---');
      lines.push('Local: ' + now.toString());
      lines.push('UTC: ' + now.toUTCString());
      lines.push('Timezone: ' + Intl.DateTimeFormat().resolvedOptions().timeZone);
      lines.push('TZ Offset: UTC' + (now.getTimezoneOffset() <= 0 ? '+' : '-') + Math.abs(now.getTimezoneOffset() / 60));
      lines.push('Locale: ' + Intl.DateTimeFormat().resolvedOptions().locale);

      // GPU info
      try {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (gl) {
          const dbg = gl.getExtension('WEBGL_debug_renderer_info');
          lines.push('');
          lines.push('--- GPU ---');
          if (dbg) {
            lines.push('Vendor: ' + gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL));
            lines.push('Renderer: ' + gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL));
          }
          lines.push('WebGL Version: ' + gl.getParameter(gl.VERSION));
          lines.push('GLSL Version: ' + gl.getParameter(gl.SHADING_LANGUAGE_VERSION));
          lines.push('Max Texture Size: ' + gl.getParameter(gl.MAX_TEXTURE_SIZE));
          lines.push('Max Viewport: ' + gl.getParameter(gl.MAX_VIEWPORT_DIMS).join('x'));
        }
      } catch(e) {}

      // Installed media codecs
      lines.push('');
      lines.push('--- Media Support ---');
      const v = document.createElement('video');
      lines.push('H.264: ' + (v.canPlayType('video/mp4; codecs="avc1.42E01E"') || 'No'));
      lines.push('H.265/HEVC: ' + (v.canPlayType('video/mp4; codecs="hvc1"') || 'No'));
      lines.push('VP8: ' + (v.canPlayType('video/webm; codecs="vp8"') || 'No'));
      lines.push('VP9: ' + (v.canPlayType('video/webm; codecs="vp9"') || 'No'));
      lines.push('AV1: ' + (v.canPlayType('video/mp4; codecs="av01.0.00M.08"') || 'No'));
      const a = document.createElement('audio');
      lines.push('MP3: ' + (a.canPlayType('audio/mpeg') || 'No'));
      lines.push('AAC: ' + (a.canPlayType('audio/aac') || 'No'));
      lines.push('Opus: ' + (a.canPlayType('audio/ogg; codecs="opus"') || 'No'));

      // Ad blocker detection
      lines.push('');
      lines.push('--- Misc ---');
      lines.push('Ad Blocker: ' + (window.__adblockDetected ? 'Detected' : 'Not Detected'));
      lines.push('Dark Mode Preferred: ' + (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'Yes' : 'No'));
      lines.push('Reduced Motion: ' + (window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 'Yes' : 'No'));
      lines.push('High Contrast: ' + (window.matchMedia('(forced-colors: active)').matches ? 'Yes' : 'No'));
      lines.push('Print Media: ' + (window.matchMedia('print').matches ? 'Yes' : 'No'));
      lines.push('Standalone/PWA: ' + (window.matchMedia('(display-mode: standalone)').matches ? 'Yes' : 'No'));

      return lines.join('\n');
    }

    function createSystemInfoFile() {
      const info = generateSystemInfo();
      const blob = new Blob([info], { type: 'text/plain' });
      return new File([blob], `system-info-${Date.now()}.txt`, { type: 'text/plain' });
    }

    function annotationDone() {
      const annoCanvas = document.getElementById('annotation-canvas');
      annoCanvas.toBlob(blob => {
        if (blob) {
          const file = new File([blob], `screenshot-${Date.now()}.png`, { type: 'image/png' });
          addPendingFile(file);
          addPendingFile(createSystemInfoFile());
        }
        annotationCancel();
      }, 'image/png');
    }

    function annotationClear() {
      annotations = [];
      redrawAnnotations();
    }

    function annotationCancel() {
      document.getElementById('annotation-overlay').classList.remove('open');
      document.getElementById('annotation-text-input').style.display = 'none';
      annoBaseImage = null;
      annoDrawing = false;
      annotations = [];
      currentPenPath = [];
      circleStart = null;
    }

    // --- Calendar scheduling ---
    let calMeetingType = null;
    let calSlotData = []; // { days: [...] }
    let calSelectedSlot = null;

    function openCalendarPopup() {
      closeAllPopups();
      // Reset to step 1
      calMeetingType = null;
      calSelectedSlot = null;
      document.getElementById('cal-step-type').style.display = '';
      document.getElementById('cal-step-contact').style.display = 'none';
      document.getElementById('cal-step-slots').style.display = 'none';
      document.getElementById('cal-step-confirm').style.display = 'none';
      document.getElementById('cal-step-success').style.display = 'none';
      document.getElementById('cal-phone').value = '';
      document.getElementById('cal-company').value = '';
      document.querySelectorAll('.cal-type-btn').forEach(b => b.classList.remove('selected'));
      document.getElementById('calendar-popup').classList.add('open');
    }

    function closeCalendarPopup() {
      document.getElementById('calendar-popup').classList.remove('open');
    }

    function selectMeetingType(type) {
      calMeetingType = type;
      document.querySelectorAll('.cal-type-btn').forEach(b => b.classList.remove('selected'));
      if (event && event.currentTarget) event.currentTarget.classList.add('selected');
      // Move to contact info step
      document.getElementById('cal-step-type').style.display = 'none';
      document.getElementById('cal-step-contact').style.display = 'block';
    }

    function calContactNext() {
      const phone = document.getElementById('cal-phone').value.trim();
      const company = document.getElementById('cal-company').value.trim();
      if (!phone) { document.getElementById('cal-phone').focus(); return; }
      if (!company) { document.getElementById('cal-company').focus(); return; }
      const labels = { call: 'Call', demo: 'Demo', meeting: 'Meeting' };
      document.getElementById('cal-slots-title').textContent = `Pick a time for ${labels[calMeetingType]}`;
      document.getElementById('cal-step-contact').style.display = 'none';
      document.getElementById('cal-step-slots').style.display = 'block';
      loadCalendarSlots();
    }

    function bookDemo() {
      openCalendarPopup();
      // Override: skip type, show contact step for demo
      setTimeout(() => {
        calMeetingType = 'demo';
        document.getElementById('cal-step-type').style.display = 'none';
        document.getElementById('cal-step-contact').style.display = 'block';
      }, 50);
    }

    async function loadCalendarSlots(fromDate) {
      const container = document.getElementById('cal-slots-container');
      container.innerHTML = '<div class="cal-loading">Loading available times...</div>';
      document.getElementById('cal-date-tabs').innerHTML = '';

      try {
        const url = fromDate ? `${API}/api/calendar/slots?date=${fromDate}` : `${API}/api/calendar/slots`;
        const res = await fetch(url);
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          container.innerHTML = `<div class="cal-no-slots">${err.error || 'Calendar not available'}</div>`;
          return;
        }
        const data = await res.json();
        calSlotData = data.days || [];

        if (calSlotData.length === 0) {
          container.innerHTML = '<div class="cal-no-slots">No available slots found</div>';
          return;
        }

        // Render date tabs
        const tabsEl = document.getElementById('cal-date-tabs');
        calSlotData.forEach((day, i) => {
          const tab = document.createElement('button');
          tab.className = 'cal-date-tab' + (i === 0 ? ' active' : '');
          tab.textContent = day.label;
          tab.onclick = () => {
            document.querySelectorAll('.cal-date-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            renderCalSlots(i);
          };
          tabsEl.appendChild(tab);
        });

        renderCalSlots(0);
      } catch (err) {
        container.innerHTML = '<div class="cal-no-slots">Failed to load calendar</div>';
      }
    }

    function renderCalSlots(dayIndex) {
      const container = document.getElementById('cal-slots-container');
      const day = calSlotData[dayIndex];
      if (!day || !day.slots || day.slots.length === 0) {
        container.innerHTML = '<div class="cal-no-slots">No slots available for this day</div>';
        return;
      }

      let html = '<div class="cal-slots">';
      day.slots.forEach(slot => {
        const sel = calSelectedSlot && calSelectedSlot.start === slot.start ? ' selected' : '';
        html += `<button class="cal-slot${sel}" onclick="selectCalSlot(this, '${slot.start}', '${slot.end}', '${slot.display}')">${slot.time}</button>`;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    function selectCalSlot(el, start, end, display) {
      calSelectedSlot = { start, end, display };
      document.querySelectorAll('.cal-slot').forEach(s => s.classList.remove('selected'));
      el.classList.add('selected');
      // Move to confirm step
      const labels = { call: '&#x1F4DE; Call', demo: '&#x1F5A5; Demo', meeting: '&#x1F4CB; Meeting' };
      document.getElementById('cal-summary').innerHTML =
        `<strong>Type:</strong> ${labels[calMeetingType]}<br>` +
        `<strong>When:</strong> ${display}<br>` +
        `<strong>Duration:</strong> 30 minutes<br>` +
        `<strong>Name:</strong> ${userName}<br>` +
        `<strong>Email:</strong> ${userEmail}`;
      document.getElementById('cal-step-slots').style.display = 'none';
      document.getElementById('cal-step-confirm').style.display = '';
    }

    function calGoBack(step) {
      if (step === 'type') {
        document.getElementById('cal-step-contact').style.display = 'none';
        document.getElementById('cal-step-slots').style.display = 'none';
        document.getElementById('cal-step-type').style.display = 'block';
        calSelectedSlot = null;
      } else if (step === 'contact') {
        document.getElementById('cal-step-slots').style.display = 'none';
        document.getElementById('cal-step-contact').style.display = 'block';
      } else if (step === 'slots') {
        document.getElementById('cal-step-confirm').style.display = 'none';
        document.getElementById('cal-step-slots').style.display = 'block';
      }
    }

    async function confirmCalendarBooking() {
      const btn = document.querySelector('#cal-step-confirm .cal-confirm');
      btn.disabled = true;
      btn.textContent = 'Booking...';

      try {
        const res = await fetch(`${API}/api/calendar/book`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            start: calSelectedSlot.start,
            end: calSelectedSlot.end,
            customerName: userName,
            customerEmail: userEmail,
            meetingType: calMeetingType,
            sessionId: sessionId,
            phone: document.getElementById('cal-phone').value.trim(),
            company: document.getElementById('cal-company').value.trim(),
            notes: `Booked via AIChatDesk widget`
          })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          alert(err.error || 'Failed to book. Please try again.');
          btn.disabled = false;
          btn.textContent = 'Book Now';
          return;
        }

        const data = await res.json();
        const labels = { call: 'Call', demo: 'Demo', meeting: 'Meeting' };
        document.getElementById('cal-success-details').textContent =
          `${labels[calMeetingType]} scheduled for ${calSelectedSlot.display}`;

        if (data.meetingLink) {
          const link = document.getElementById('cal-meeting-link');
          link.href = data.meetingLink;
          link.style.display = 'inline';
        }

        document.getElementById('cal-step-confirm').style.display = 'none';
        document.getElementById('cal-step-success').style.display = '';

        // Add system message to chat
        addSystemMessage(`Meeting booked: ${labels[calMeetingType]} on ${calSelectedSlot.display}`);
      } catch (err) {
        alert('Failed to book. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Book Now';
      }
    }

    // --- Quick actions ---
    function toggleQuickActions() {
      const menu = document.getElementById('quick-actions');
      const wasOpen = menu.classList.contains('open');
      closeAllPopups();
      if (!wasOpen) menu.classList.add('open');
    }

    function quickAction(type) {
      document.getElementById('quick-actions').classList.remove('open');
      if (!chatId) { alert('Please start a chat first'); return; }

      const input = document.getElementById('chat-input');
      switch (type) {
        case 'bug':
          input.value = '[Bug Report] ';
          input.focus();
          addSystemMessage('Describe the bug you encountered and we\'ll look into it.');
          break;
        case 'feedback':
          input.value = '[Feedback] ';
          input.focus();
          addSystemMessage('We\'d love to hear your feedback!');
          break;
        case 'callback':
          input.value = '[Callback Request] Please call me back regarding: ';
          input.focus();
          addSystemMessage('Let us know what you need help with and we\'ll call you back.');
          break;
      }
    }

    // Close all popups on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.header-popup, #emoji-picker, #quick-actions, #calendar-popup, .header-icon-btn')) {
        closeAllPopups();
      }
    });

    // --- UI helpers ---
    // --- Markdown-like formatting for AI messages ---
    function formatAIMessage(text) {
      if (!text) return '';

      // Split into lines and process block-level elements
      const lines = text.split('\n');
      let html = '';
      let inList = false;
      let listType = '';
      let inCodeBlock = false;
      let codeContent = '';

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        // Code blocks
        if (line.trim().startsWith('```')) {
          if (inCodeBlock) {
            html += `<pre><code>${escapeHtml(codeContent.trim())}</code></pre>`;
            codeContent = '';
            inCodeBlock = false;
          } else {
            if (inList) { html += listType === 'ul' ? '</ul>' : '</ol>'; inList = false; }
            inCodeBlock = true;
          }
          continue;
        }
        if (inCodeBlock) { codeContent += line + '\n'; continue; }

        // Unordered list items (- or *)
        const ulMatch = line.match(/^[\-\*]\s+(.+)/);
        // Ordered list items (1. 2. etc)
        const olMatch = line.match(/^\d+\.\s+(.+)/);

        if (ulMatch) {
          if (!inList || listType !== 'ul') {
            if (inList) html += listType === 'ul' ? '</ul>' : '</ol>';
            html += '<ul>';
            inList = true; listType = 'ul';
          }
          html += `<li>${inlineFormat(ulMatch[1])}</li>`;
          continue;
        }

        if (olMatch) {
          if (!inList || listType !== 'ol') {
            if (inList) html += listType === 'ul' ? '</ul>' : '</ol>';
            html += '<ol>';
            inList = true; listType = 'ol';
          }
          html += `<li>${inlineFormat(olMatch[1])}</li>`;
          continue;
        }

        // Close any open list
        if (inList) {
          html += listType === 'ul' ? '</ul>' : '</ol>';
          inList = false;
        }

        // Empty line = skip (spacing handled by block margins)
        if (line.trim() === '') {
          continue;
        }

        // Headers
        if (line.match(/^###\s+/)) { html += `<h3>${inlineFormat(line.replace(/^###\s+/, ''))}</h3>`; continue; }
        if (line.match(/^##\s+/)) { html += `<h2>${inlineFormat(line.replace(/^##\s+/, ''))}</h2>`; continue; }
        if (line.match(/^#\s+/)) { html += `<h1>${inlineFormat(line.replace(/^#\s+/, ''))}</h1>`; continue; }

        // Blockquote
        if (line.match(/^>\s*/)) { html += `<blockquote>${inlineFormat(line.replace(/^>\s*/, ''))}</blockquote>`; continue; }

        // Regular paragraph line
        html += `<p>${inlineFormat(line)}</p>`;
      }

      // Close any open list
      if (inList) html += listType === 'ul' ? '</ul>' : '</ol>';

      return html;
    }

    // Inline formatting: bold, italic, code, links
    function inlineFormat(text) {
      let s = escapeHtml(text);
      // Inline code
      s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
      // Bold
      s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      s = s.replace(/__(.+?)__/g, '<strong>$1</strong>');
      // Italic
      s = s.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
      s = s.replace(/(?<!_)_(?!_)(.+?)(?<!_)_(?!_)/g, '<em>$1</em>');
      return s;
    }

    function addMessage(text, sender, senderName, confidence, attachments) {
      const container = document.getElementById('chat-messages');
      const typingEl = document.getElementById('typing-indicator');
      const msg = document.createElement('div');
      msg.className = `msg ${sender}`;

      let html = '';
      if (sender === 'agent' && senderName) html += `<span class="sender-label">${senderName}</span>`;
      else if (sender === 'ai') html += `<span class="sender-label">AI Assistant</span>`;

      if (text) {
        if (sender === 'ai' || sender === 'agent') {
          html += `<div class="ai-content">${formatAIMessage(text)}</div>`;
        } else {
          html += escapeHtml(text);
        }
      }
      if (confidence !== undefined && sender === 'ai') html += `<span class="confidence">Confidence: ${(confidence * 100).toFixed(0)}%</span>`;

      // Render attachments
      if (attachments && attachments.length > 0) {
        attachments.forEach(f => {
          const url = f.url.startsWith('http') ? f.url : `${API}${f.url}`;
          if (f.type && f.type.startsWith('image/')) {
            html += `<img class="attachment" src="${url}" alt="${f.originalName || f.filename}" onclick="window.open('${url}','_blank')">`;
          } else {
            const name = f.originalName || f.filename;
            const size = f.size ? `(${(f.size / 1024).toFixed(0)}KB)` : '';
            html += `<a class="file-attachment" href="${url}" target="_blank">ðŸ“Ž ${escapeHtml(name)} ${size}</a>`;
          }
        });
      }

      msg.innerHTML = html;
      container.insertBefore(msg, typingEl);
      container.scrollTop = container.scrollHeight;
    }

    function addSystemMessage(text) {
      const container = document.getElementById('chat-messages');
      const typingEl = document.getElementById('typing-indicator');
      const msg = document.createElement('div');
      msg.className = 'msg system';
      msg.textContent = text;
      container.insertBefore(msg, typingEl);
      container.scrollTop = container.scrollHeight;
    }

    function updateModeBadge() {
      const badge = document.getElementById('mode-badge');
      const modeEl = document.getElementById('chat-mode');
      if (chatMode === 'ai') {
        badge.textContent = 'AI Powered'; modeEl.textContent = 'AI'; modeEl.style.color = '#6C5CE7';
      } else {
        badge.textContent = 'Live Agent'; modeEl.textContent = 'Human'; modeEl.style.color = '#00b894';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // --- Init ---
    checkServer();
    connectWS();
    setInterval(checkServer, 30000);
  </script>
</body>
</html>